# Testing Stencil Controllers

## Pre-requisites

- Make sure you followed the [Controllers setup guide](./0.introduction.md#installation) and added necessary options
  to your Stencil Config

- [Read Stencil's documentation on testing components](https://stenciljs.com/docs/testing-overview)

## Unit Tests

You can use Stencil's default `newSpecPage` to write unit tests for your web
components that use Controllers. However, Stencil is not type-safe with it's
typings, and so the component returned by `newSpecPage` is typed as having `any`
type for all of it's properties.

Instead, you can use the `spec` utility provided by this package - the utility
is just a small wrapper for `newSpecPage`, with the following benefits:

- Adds an `el` property, which is like `root`, but properly typed with all the
  properties and methods of the component
  - Similarly, adds a `component` property, which is a better typed version
    of `rootInstance`
- With, `spec`, you are not required to provide an HTML string, as it uses
  the following convenient default:

  ```html
  <your-component-tag-name />
  ```

  (where tag name is coming dynamically from the component you passed in)

### Usage

```ts
import { spec } from "@arcgis/components-controllers/testing";
import type { ControllerManager } from "@arcgis/components-controllers";
import { useControllerManager, makeController } from "@arcgis/components-controllers";
import { Component, Element, Prop } from "@stencil/core";

// A sample controller:
const useGreet = (): void => makeController(() => "Hi!");

// A sample component:
@Component({ tag: "te-st" })
class TestComponent {
  manager: ControllerManager<this> = useControllerManager(this);
  @Element() el!: HTMLElement;

  test = useGreet();

  render(): string {
    return this.test;
  }
}

describe("TestComponent", () => {
  it("renders without exceptions", async () => {
    const { component, el } = await spec(TestComponent);
    expect(el).toEqualHtml(`<te-st>Hi!</te-st>`);
    expect(component.test).toEqual("Hi!");
  });
});
```

### Testing Controllers without a component

Note, that the `spec` function accepts a Component class. If you are interested
in testing a controller only, you can use the `wrapController` to create a
simple component that uses your controller:

```ts
import { spec, wrapController } from "@arcgis/components-controllers/testing";
import { makeController } from "@arcgis/components-controllers";

const useGreet = (): string => makeController(() => "Hi!");

it("useGreet", async () => {
  const { component } = await spec(wrapController(useGreet));
  expect(component.controller).toEqual("Hi!");
});
```

### Testing multiple component instances at once

It is sometimes helpful to create multiple instances of the same component at
once inside your test to make sure they don't interfere. Since each
`spec`/`newSpecPage` call creates a separate "virtual browser page", you can't
just call `spec` multiple times in a single test. Instead, a helper `multiSpec`
function is provided:

```ts
describe("TestComponent", () => {
  it("renders without exceptions", async () => {
    // Create two instances
    const {
      els: [el1, el2],
      components: [component1, component2],
    } = await multiSpec(TestComponent, { html: ['<te-st name="test1" />', '<te-st name="test2" />'] });

    // Make 5 instances like <te-st />
    const { els, components } = await multiSpec(TestComponent, { count: 5 });

    // Make 5 instances with different templates
    const { els: els5, components: components5 } = await multiSpec(Test, {
      count: 5,
      html: (index) => `<te-st prop="${index}" />`,
    });
  });
});
```

## The end

That's it for the core Stencil Controllers documentation.
You can [continue to the next page](./6.lit.tsx) to see optional additional
information (like how to use Lit's Controllers in Stencil, and what is the
roadmap for controllers), or take a look at some
[real-world controllers](./README.md#real-world-examples).

Have feedback, questions or need help? [Make a post in this GitHub Discussion](https://devtopia.esri.com/WebGIS/arcgis-web-components/discussions/711).
