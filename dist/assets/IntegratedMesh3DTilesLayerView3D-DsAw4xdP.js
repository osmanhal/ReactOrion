import{ca as Fe,A as Y,mU as He,ba as ge,c8 as Ve,mV as j,mW as be,cY as ye,i3 as Le,f$ as je,mX as Be,eE as De,eO as ke,eB as _e,mY as Ge,mZ as Z,m_ as Ne,m$ as $e,ep as K,n0 as ze,R as We,fw as Je,eo as qe,fF as Xe,J as we,v as R,y as B,z as Ye,eA as ve}from"./index-BfC8i6jT.js";import{u as Ze}from"./computeTranslationToOriginAndRotation-DK7GzGeb.js";import{x as Ke,f as Qe,t as et,i as tt}from"./Transform-WXEZpNOT.js";import{n as it}from"./projectVectorToVector-C51LtB8f.js";import{c as rt,x as st,L as ot,i as Q,O as at,E as nt,u as lt,k as mt,B as xe,g as Ce}from"./BufferView-DcMGflLe.js";import{r as P,a as ee,S as D,N as U,e as u,m as ct,d as dt,g as Te,t as E,n as te,i as S}from"./ILyr3DWasmPerSceneView-vPx4somd.js";import{R as Me}from"./elevationInfoUtils-Dkzy2V0O.js";import{t as pt}from"./WaterSurface.glsl-BrdOaNHj.js";import{d as ht}from"./RenderGeometry-BYg-7xwk.js";import{l as ut}from"./LayerView3D-B4a7j2_d.js";import{s as $,e as A,u as Ee}from"./basicInterfaces-wONHx_SN.js";import{E as Pe,D as x}from"./enums-BlUEVwJR.js";import{l as ft}from"./ElevationQueryTileCache-BEPYiqMG.js";import{i as gt,e as bt,G as yt}from"./ElevationProvider-BU9L4pxM.js";import{m as _t,A as wt}from"./VertexColor.glsl-DMQrT1G9.js";import{e as vt}from"./ElevationRange-BrgM1moX.js";import{I as xt,J as Ct,t as k}from"./orientedBoundingBox-Do1Vt1ct.js";import{b as Tt,I as Mt,d as Et}from"./Viewshed.glsl-D2C0nY_-.js";import{s as Pt}from"./RenderTexture-DVwGHX_m.js";import{d as Oe,N as Ot}from"./Texture-1xthaLvE.js";import{c as Ut}from"./Normals-FPkG6ULP.js";import{e as G}from"./VertexAttribute-BnAa5VW0.js";import{y as At}from"./LayerView-D3G_E76P.js";import{c as It}from"./layerViewUtils-D2JqIDZ8.js";import"./sphere-BgvJtIjV.js";import"./plane-ByuX_NXR.js";import"./mathUtils-DIiwy5h7.js";import"./projectPointToVector-C0Qwzs7z.js";import"./ColorMaterial.glsl-r8qsLxA-.js";import"./Material-CL7oq3ds.js";import"./interfaces-B8ge7Jg9.js";import"./InterleavedLayout-D5nIvpjN.js";import"./types-D0PSWh4d.js";import"./Util-D9KK83cB.js";import"./Matrix4PassUniform-BH4JqvtO.js";import"./BindType-BmZEZMMh.js";import"./renderState-yUi34s5A.js";import"./ShaderTechniqueConfiguration-D3UbJ2mX.js";import"./hydratedFeatures-Dp0VykK3.js";import"./floatRGBA-BcMV1NFr.js";import"./Texture-Bq-Yp-pO.js";import"./dehydratedFeatures-ONP9sBF3.js";import"./featureConversionUtils-CGYMoz5K.js";import"./OptimizedFeature-7juV2tZm.js";import"./OptimizedGeometry-vU5jWBvU.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./edgeUtils-7PCAzCge.js";import"./DecodeSymbolColor.glsl-BR7HIChu.js";import"./Float4DrawUniform-DSpHBPg2.js";import"./earcut-BrWrA6nz.js";import"./DoubleArray-CZhUFo5d.js";import"./Indices-Bl02GO-3.js";import"./vec3-DSC46DgP.js";import"./SnappingCandidate-O5eRSE6e.js";import"./triangulationUtils-en0lWBIB.js";import"./deduplicate-DD1J6YAH.js";import"./triangle-B-TmEFJd.js";import"./lineSegment-DbTVMGoh.js";import"./objectResourceUtils-AgE6Mx7R.js";import"./devEnvironmentUtils-D6qIi8Ky.js";import"./vec4-CDid__v2.js";import"./DefaultMaterial_COLOR_GAMMA-iPR_ZT6p.js";import"./resourceUtils-Cd4X6-Sw.js";import"./NestedMap-DgiGbX8E.js";import"./requestImageUtils-CYZi7VGK.js";import"./verticalOffsetUtils-Bdqba6xa.js";import"./CIMSymbolHelper-RNagakW-.js";import"./BidiEngine-BwB1Df7c.js";import"./fontUtils-BN6jNuTX.js";import"./GeometryUtils-ClkMWevA.js";import"./enums-BRXbslMp.js";import"./definitions-ByNBSgP9.js";import"./Rect-CUzevAry.js";import"./BoundingBox-Dn8AJClK.js";import"./cimSymbolUtils-DS1Fp96D.js";import"./utils-C2H3A1uw.js";import"./lineStippleUtils-DdOUX39J.js";import"./projectVectorToPoint-sjRZ-2WD.js";import"./MeshComponent-D498mY_W.js";import"./imageUtils-BfjLvT3i.js";import"./MeshVertexAttributes-BD2PtWGl.js";import"./meshVertexSpaceUtils-CcfLNHym.js";import"./MeshLocalVertexSpace-DZNf3szf.js";import"./projection-PKkfrDjd.js";import"./spatialReferenceEllipsoidUtils-6vOoKuZD.js";import"./DefaultLayouts-DkwmdUjQ.js";import"./frustum-Bdr-rFEQ.js";import"./webStyleSymbolUtils-BLz2G3ck.js";import"./glUtil-C6KhMg1m.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./Octree-bjpgk3mA.js";import"./BufferObject-CLFFt1Oe.js";import"./Intersector-juYjkWfX.js";import"./Scheduler-DSoCN6Hr.js";import"./debugFlags-CX6JgPmI.js";import"./weather-B3EDJgNZ.js";import"./vec3f32-Cw9Q6TO_.js";import"./Intersector-Dzvq-gms.js";import"./VertexArrayObject-DJNUJ_t_.js";import"./LayerConstants-B33OP6sh.js";import"./boundedPlane-xSVxcV1_.js";import"./RenderCoordsHelper-BbU_hNrx.js";import"./scaleUtils-DL5-S4xE.js";import"./viewpointUtils-t8HSs1zS.js";import"./earthUtils-B4BKKXMy.js";import"./spatialReferenceSupport-BIiDjE2t.js";import"./ElevationSamplerData-k1b1ey21.js";import"./terrainUtils-BzcC3xJT.js";import"./Environment-zbroFpii.js";import"./quantityUtils-B2xRWNSM.js";import"./Program-C3FgCIV9.js";import"./ShadowCastVisualizeTechniqueConfiguration-DXK-OiGG.js";import"./euclideanLengthMeasurementUtils-D2ZslYzK.js";import"./ray-8l9wECN6.js";import"./ZoomMomentumEstimator-COZR6STZ.js";import"./labelFormatUtils-DkVwf7tJ.js";import"./FeatureTileDescriptor3D-DtDBB7rP.js";import"./geometryServiceUtils-DujY2RdF.js";import"./project-gQLDAKs4.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./RenderableTile-Co1N3tXi.js";import"./enums-BRzLM11V.js";import"./config-MDUrh2eL.js";import"./TiledDisplayObject-wW3wbRrm.js";import"./DisplayObject-COGNSicI.js";import"./StyleDefinition-BK3ROBTO.js";import"./resources-DkiY2wAJ.js";import"./edgeProcessing-BaVy8Gc3.js";import"./testSVGPremultipliedAlpha-pEtBKrma.js";import"./RenderingContext-B8FOG7Ha.js";import"./ProgramCache-NPIMJ8lZ.js";import"./doublePrecisionUtils-B0owpBza.js";class Rt extends pt{constructor(e,c,o,m,n,s,d){super(e,0,0,0,c),this.nodesCached=o,this.vboMB=m,this.textureMB=n,this.vboMBCached=s,this.textureMBCached=d}}const St={[P.Points]:null,[P.Lines]:null,[P.LineStrip]:null,[P.Triangles]:Pe.TRIANGLES,[P.TriangleStrip]:Pe.TRIANGLE_STRIP,[P.NotSet]:null},Ue={[ee.Opaque]:$.Opaque,[ee.Mask]:$.Mask,[ee.Blend]:$.Blend},Ft={[D.Back]:A.Back,[D.Front]:A.Front,[D.None]:A.None,[D.NotSet]:A.Back},Ht={[U.WrapYBit]:{s:x.CLAMP_TO_EDGE,t:x.REPEAT},[U.WrapXBit]:{s:x.REPEAT,t:x.CLAMP_TO_EDGE},[U.WrapXy]:{s:x.REPEAT,t:x.REPEAT},[U.None]:{s:x.CLAMP_TO_EDGE,t:x.CLAMP_TO_EDGE},[U.NotSet]:{s:x.CLAMP_TO_EDGE,t:x.CLAMP_TO_EDGE}},Vt={[u.U8]:1,[u.I8]:1,[u.U16]:2,[u.I16]:2,[u.U32]:4,[u.I32]:4,[u.F32]:4,[u.F64]:8,[u.Utf8String]:1,[u.NotSet]:1};class Lt{constructor(e){this.layerUid=[],this.type=gt.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,c,o,m,n,s){const d=e.results,_=e.options.store===bt.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const w=this.layerView.view._stage.renderView.componentObjectCollection,f=new _t(s??!1,e.options.normalRequired);this.layerView.objects.forEach(h=>{h.visible&&h.intersectionGeometry&&w.intersect(h,o,m,e.tolerance,null,f,(p,a,i,g)=>{if(a>=0){if(c!=null&&!c(o,m,a))return;const l=T=>{const C=new ft(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));T.set(this.type,C,a,i)};if(this.isGround&&(d.ground.dist==null||a<d.ground.dist)&&l(d.ground),e.options.isFiltered)return;if((d.min.dist==null||a<d.min.dist)&&l(d.min),(d.max.dist==null||a>d.max.dist)&&l(d.max),_){const T=yt(e.ray);l(T),e.results.all.push(T)}}})})}_createTiles3DGraphic(e,c){return new Fe({layer:e,sourceLayer:e,attributes:c})}}var b;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(b||(b={}));class jt{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function N(t){return Math.round(t/1048.576)/1e3}let O=class extends ut(At){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=ht.WithoutRasterImage,this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(b.Error),this._dbg(b.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new Y("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=He(this).then(e=>{this._intersectionHandler=new Lt(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,o=>this._slicePlaneEnabledChange(o)),this._elevationProvider=new Ke({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const c=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,o=>this._onRemoveFromCache(o));this._memCache=c,this.addHandles([ge(()=>this.layer.elevationInfo,o=>this._elevationInfoChanged(o))]),this._suspendedHandle=ge(()=>this.suspended,o=>{const m=j(this.view);m&&m.setEnabled(this,!o)},Ve)}).catch(e=>{if(be(this),this._wasmLayerId=-1,e===ct)throw new Y("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===dt)throw new Y("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(b.VerboseAPI,"Tiles3DLayerView3D destroy() called"),be(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=ye(this._memCache),this._updatingHandles=ye(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle==null&&(this._visibleGeometryChangedSchedulerHandle=Le(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{const c=this._collection.getMaterial(e);c.commonMaterialParameters.hasSlicePlane=t,c.commonMaterialParameters.cullFace=t?A.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){const e=j(this.view);e&&e.setLayerOffset(this,Me(t))}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.totalMemory())}),t}get unloadedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.totalMemory())}),t}get visibleAtCurrentScale(){return It(this.layer.effectiveScaleRange,this.view.terrainScale)}get performanceInfo(){let t=0,e=0,c=0,o=0,m=0,n=0;return this._lyrHandleToObjects.forEach(s=>{s.isVisible?(t+=s.texMemoryUsage,e+=s.vboMemoryUsage,m++):(c+=s.texMemoryUsage,o+=s.vboMemoryUsage,n++)}),new Rt(this.usedMemory,m,n,N(e),N(t),N(o),N(c))}_canProjectWithoutEngine(){var t,e;if(this.view.state.viewingMode===je.Local){const c=(t=this.view.renderSpatialReference)!=null&&t.isWebMercator?3857:((e=this.view.renderSpatialReference)==null?void 0:e.wkid)??-1;if(c!==3857&&c!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return Me(this.layer.elevationInfo)}get elevationRange(){const t=this.fullExtent;return t!=null&&t.zmin&&(t!=null&&t.zmax)?new vt(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){const t=j(this.view);return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){var a;const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const c=Be(e.desc.origin),o=new Array,m=new Map,n=new jt;n.handle=t.handle,this._lyrHandleToObjects.set(t.handle,n);const s=this.view.basemapTerrain.spatialReference;let d,_;if(this.view.viewingMode==="global"){const i=ve();Ze(De,c,i,s),d=ke(_e(),i),_=Ge(_e(),d)}else d=Z,_=Z;const w=ve();Ne(w,w,c);const f=$e(K(),w);let h=null;const p=K();if(e.desc.obb){const i=e.desc.obb.quaternion;h=new xt(e.desc.obb.center,e.desc.obb.halfSize,ze(i[0],i[1],i[2],i[3]))}for(let i=0;i<e.desc.prims.length;i++){const g=e.desc.prims[i];if(this._dbg(b.VerboseAPI,JSON.stringify(g)),g.ptype===P.Lines)continue;if(St[g.ptype]==null||e.data==null){this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+g.ptype+"). Skipping primitive.");continue}const l=(a=e.desc)!=null&&a.materials&&g.materialId!=null?e.desc.materials[g.materialId]:null,T=l!=null?l.lightingModel:Te.Unlit,C=!We("disable-feature:im-shading"),{positionView:y,positionAttr:M,normalsView:Ae,normalsAttr:z,colorAttr:F,texCoord0Attr:H,indicesView:I}=this.getBufferViews(g,e.data.buffer,d,C);if(M==null||y==null||I==null)continue;const ie={colors:F!=null,textureCoordinates:H!=null?Oe.Default:Oe.None,hasNormals:Ae!=null,needsNormals:C},Ie=M.data.length/M.size,W=(r,v)=>!r||r.data.length/r.size===Ie||(this._dbg(b.Error,`${v} !== numPos. Skipping primitive.`),!1);if(!W(H,"numTexcoord")||!W(F,"numColors")||!W(z,"normals"))continue;const re=Tt(ie);if(h!=null?h=h.clone():(h=Ct(M),Je(p,h.center,c),h.center=p),d!==Z)for(let r=0;r<y.count;r++)y.getVec(r,p),qe(p,p,d),y.setVec(r,p);const J=re.createBuffer(M.data.length),V=new Map([[G.POSITION,M]]);H!=null&&V.set(G.UV0,H),F!=null&&V.set(G.COLOR,F),z!=null&&V.set(G.NORMALCOMPRESSED,z),V.forEach((r,v)=>{r!=null&&wt(v,r,null,null,J,0)});const Re=new Uint32Array([0,I.typedBuffer.length]),Se={vertices:{data:J.buffer,count:J.byteLength/re.stride,layoutParameters:ie},positionData:{positions:y.typedBuffer,indices:I.typedBuffer},indices:I.typedBuffer,componentOffsets:Re};n.cpuMemoryUsage+=y.count,n.cpuMemoryUsage+=I.count;const se=this.view.renderSpatialReference,q=K(),X=[1,1,1];Qe(f,se,X,s)||this._dbg(b.Error,"Unsupported coordinate system for IM overlay"),it(f,se,q,s);const L=this._collection.createObject(new et(Xe(q[0],q[1],X[0],X[1]),new tt(f,_),h,Se));l&&this._collection.updateMaterial(L,r=>{r.baseColor=l.baseColorFactor,r.usePBR=T===Te.Pbr,r.hasParametersFromSource=!1,r.baseColorTexture=this._getTexture(l.baseColorTex,e,m),r.usePBR&&(r.mrrFactors=[l.metallicFactor,l.roughnessFactor,0],r.emissiveFactor=l.emissiveFactor??[0,0,0],r.metallicRoughnessTexture=this._getTexture(l.metalTex,e,m),r.emissionTexture=this._getTexture(l.emissiveTex,e,m),r.occlusionTexture=this._getTexture(l.occlusionTex,e,m),r.normalTexture=this._getTexture(l.normalTex,e,m)),r.objectOpacity=0,r.alphaDiscardMode=$.Mask;const v=[];r.baseColorTexture&&v.push(r.baseColorTexture.loadPromise),r.usePBR&&r.metallicRoughnessTexture&&v.push(r.metallicRoughnessTexture.loadPromise),r.usePBR&&r.emissionTexture&&v.push(r.emissionTexture.loadPromise),r.usePBR&&r.occlusionTexture&&v.push(r.occlusionTexture.loadPromise),r.usePBR&&r.normalTexture&&v.push(r.normalTexture.loadPromise);const oe=Promise.all(v);o.push(oe),oe.then(()=>{var ae,ne,le,me,ce,de,pe,he,ue,fe;r.alphaDiscardMode=Ue[l.alphaMode],r.objectOpacity=1,n.texMemoryUsage+=((ne=(ae=r.baseColorTexture)==null?void 0:ae.glTexture)==null?void 0:ne.usedMemory)||0,r.usePBR&&(n.texMemoryUsage+=((me=(le=r.metallicRoughnessTexture)==null?void 0:le.glTexture)==null?void 0:me.usedMemory)||0,n.texMemoryUsage+=((de=(ce=r.emissionTexture)==null?void 0:ce.glTexture)==null?void 0:de.usedMemory)||0,n.texMemoryUsage+=((he=(pe=r.occlusionTexture)==null?void 0:pe.glTexture)==null?void 0:he.usedMemory)||0,n.texMemoryUsage+=((fe=(ue=r.normalTexture)==null?void 0:ue.glTexture)==null?void 0:fe.usedMemory)||0)}),r.commonMaterialParameters.doubleSided=l.isDoubleSided,r.commonMaterialParameters.cullFace=l.faceCulling?Ft[l.faceCulling]:A.Back,this._initialCullFace.set(L,r.commonMaterialParameters.cullFace),r.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,r.componentParameters.castShadows=Mt.All,r.textureAlphaCutoff=l.alphaCutoff??.1,r.alphaDiscardMode=Ue[l.alphaMode],r.isIntegratedMesh=!0,r.polygonOffsetEnabled=!1,r.hasOccludees=!1,r.ellipsoidMode=Et(this.view.spatialReference)}),n.components.push(L),n.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(L)}if(await Promise.all(o),m.forEach(i=>{n.textures.push(i)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${n.handle}`,n,n.totalMemory()),{memUsageBytes:n.totalMemory()}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(c=>{this._stage.remove(c)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,c){if(this._memCache){for(let o=0;o<c;++o){const m=t[o],n=e[o];if(!n)continue;const s=this._lyrHandleToObjects.get(m);s&&(this._visibleGeometryChanged(),s.isVisible=n,s.components.forEach(d=>{this._collection.setObjectVisibility(d,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(d))}),this._memCache.pop(`${m}`))}for(let o=0;o<c;++o){const m=t[o],n=e[o];if(n)continue;const s=this._lyrHandleToObjects.get(m);s&&(this._visibleGeometryChanged(),s.isVisible=n,s.components.forEach(d=>{this._collection.setObjectVisibility(d,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(d))}),this._memCache.put(`${m}`,s,s.totalMemory()))}}}_getTexture(t,e,c){var m,n;let o=null;if(t&&((m=e.desc)!=null&&m.images)&&((n=e.data)!=null&&n.buffer)){const s=e.desc.images[t==null?void 0:t.imageId];if(o=c.get(s),!o&&s){const d=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,_=d>1,w=Ht[t.wrapMode??U.None];let f=s.alpha?4:3;const h=new Uint8Array(e.data.buffer,s.data.byteOffset,s.data.byteCount);let p=null,a=null,i=null;switch(s.format){case E.Raw:s.pixelFormat===te.R8?(p=h.buffer,f=1,a=""):s.pixelFormat===te.Rgb8?(p=h.buffer,f=3,a=""):s.pixelFormat===te.Rgba8&&(p=h.buffer,f=4,a="");break;case E.Dxt1:p=h.buffer,f=3,a=Ee.DDS_ENCODING;break;case E.Dxt5:p=h.buffer,f=4,a=Ee.DDS_ENCODING;break;case E.Png:a="image/png",i=document.createElement("img");break;case E.Jpeg:a="image/jpeg",i=document.createElement("img");break;case E.Etc2:a="image/ktx",i=document.createElement("img");break;case E.Astc:this._dbg(b.Error,"Astc texture not supported");break;case E.Pvrtc:this._dbg(b.Error,"Pvrtc texture not supported")}if(i&&a){const g=new Blob([h],{type:a});i.src=URL.createObjectURL(g),p=i}p&&a!=null&&(o=new Ot(p,{mipmap:_,maxAnisotropy:d,encoding:a,wrap:w,components:f,noUnpackFlip:!0,width:s.mip0Width,height:s.mip0Height}),this._stage.add(o),c.set(s,o))}}return o?new Pt(this.view._stage.renderView.textures,o.id):null}getBufferViews(t,e,c,o){let m,n,s,d,_,w,f,h=null;for(let p=0;p<t.atrbs.length;p++){const a=t.atrbs[p],i=a.view,g=void 0,l=i.byteOffset+i.byteCount,T=i.byteCount/Vt[i.type],C=[...Array(T).keys()].map(y=>y);try{switch(a.sem){case S.Position:i.ncomp!==3||i.type!==u.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Position ("+i+")"):(m=new Q(e,i.byteOffset,g,l),n=new k(m.typedBuffer,C,3));break;case S.Normal:if(i.ncomp!==3||i.type!==u.F32)this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Normal ("+i+")");else if(o){const y=new Q(e,i.byteOffset,g,l),M=Ut(y.typedBuffer,c);_=new mt(M),w=new k(_.typedBuffer,C,2)}break;case S.TexCoord:i.ncomp!==2||i.type!==u.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+i+")"):d===void 0&&(d=new k(new lt(e,i.byteOffset,g,l).typedBuffer,C,2));break;case S.Color:i.ncomp===4?(i.type===u.F32&&(h=new rt(e,i.byteOffset,g,l)),i.type===u.U8&&(h=new st(e,i.byteOffset,g,l)),i.type===u.U16&&(h=new ot(e,i.byteOffset,g,l))):i.ncomp===3&&(i.type===u.F32&&(h=new Q(e,i.byteOffset,g,l)),i.type===u.U8&&(h=new at(e,i.byteOffset,g,l)),i.type===u.U16&&(h=new nt(e,i.byteOffset,g,l))),h==null?this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+i+")"):s=new k(h.typedBuffer,C,i.ncomp);break;case S.FeatureIndex:break;default:this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+a.sem+"). Skipping vertex attribute.")}}catch(y){this._dbg(b.VerboseAPI,"Error Creating buffer ("+y+"). Skipping vertex attribute.")}}if(t.index){const p=t.index.view,a=void 0,i=p.byteOffset+p.byteCount;switch(t.index.view.type){case u.U16:f=new Ce(e,p.byteOffset,a,i);break;case u.U32:f=new xe(e,p.byteOffset,a,i);break;case u.U8:default:this._dbg(b.Error,"[Unsupported Feature] index type not supported ("+p.type+").")}}if(f==null&&m!=null){const p=m.count;if(p<65535){const a=new Uint16Array(p);f=new Ce(a)}else{const a=new Uint32Array(p);f=new xe(a)}for(let a=0;a<p;a++)f.set(a,a)}return{positionView:m,positionAttr:n,colorAttr:s,texCoord0Attr:d,indicesView:f,normalsView:_,normalsAttr:w}}_onRemoveFromCache(t){const e=j(this.view);e&&e.onRenderableEvicted(this,t.handle,t.totalMemory()),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===b.Error?we.getLogger(this).error(e):we.getLogger(this).warn(e))}};R([B()],O.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),R([B()],O.prototype,"layer",void 0),R([B({readOnly:!0})],O.prototype,"visibleAtCurrentScale",null),R([B()],O.prototype,"elevationOffset",null),O=R([Ye("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],O);const cs=O;export{cs as default};
