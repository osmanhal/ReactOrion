function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/OrientedImageryViewerViewModelAdapter2D-C1FYagzU.js","assets/index-BfC8i6jT.js","assets/index-CKzvfSE0.css","assets/ImageryTileLayer-B-YZ2ypl.js","assets/fetchRasterInfo-CRGzxPzd.js","assets/multidimensionalUtils-DIjUKqi2.js","assets/dataUtils-DhADFUS8.js","assets/pixelRangeUtils-DR2RxTkt.js","assets/RasterSymbolizer-CbthH4ql.js","assets/utils-C2H3A1uw.js","assets/cimSymbolUtils-DS1Fp96D.js","assets/ClassBreaksDefinition-CFCBLk51.js","assets/RawBlockCache-DjQlw8pe.js","assets/rasterProjectionHelper-B00wUuFF.js","assets/PolynomialTransform-CeuClFLJ.js","assets/TilemapCache-C4tcvL45.js","assets/ByteSizeUnit-BsxeN7wM.js","assets/GraphicsLayer-B2JC83UW.js","assets/OrientedImageryLayer-BJ2QFfLf.js","assets/requestPresets-BbUE9oCD.js","assets/Circle-BB08Wuoo.js","assets/geodesicUtils-BOUsTR0r.js","assets/Mesh-lqzZlCsM.js","assets/MeshComponent-D498mY_W.js","assets/imageUtils-BfjLvT3i.js","assets/MeshVertexAttributes-BD2PtWGl.js","assets/MeshLocalVertexSpace-DZNf3szf.js","assets/meshVertexSpaceUtils-CcfLNHym.js","assets/triangulationUtils-en0lWBIB.js","assets/earcut-BrWrA6nz.js","assets/DoubleArray-CZhUFo5d.js","assets/Indices-Bl02GO-3.js","assets/plane-ByuX_NXR.js","assets/mathUtils-DIiwy5h7.js","assets/deduplicate-DD1J6YAH.js","assets/projection-PKkfrDjd.js","assets/spatialReferenceEllipsoidUtils-6vOoKuZD.js","assets/computeTranslationToOriginAndRotation-DK7GzGeb.js","assets/BufferView-DcMGflLe.js","assets/vec3-DSC46DgP.js","assets/vec4-CDid__v2.js","assets/projectPointToVector-C0Qwzs7z.js","assets/vertexSpaceConversion-Bg4vy5id.js","assets/External-DUpZJXYU.js","assets/lineSegment-DbTVMGoh.js","assets/sphere-BgvJtIjV.js","assets/ElevationLayer-DjnPzjXZ.js","assets/ArcGISCachedService-Ck_c4zTW.js","assets/TileInfoTilemapCache-D02BJTXT.js","assets/LercDecoder-BGMljx8H.js","assets/WorkerHandle-CXxGr93G.js","assets/ImageryLayer-Dimcsfbr.js","assets/imageBitmapUtils-Bs4FbqLw.js","assets/executeQueryJSON-BvKan1w-.js","assets/query-Ct_ioWiz.js","assets/pbfQueryUtils-BfYlzyKp.js","assets/pbf-W1xbSZIX.js","assets/OptimizedGeometry-vU5jWBvU.js","assets/OptimizedFeature-7juV2tZm.js","assets/OptimizedFeatureSet-Blu9Ckm7.js","assets/AttachmentInfo-rwMSayzj.js","assets/executeForIds-CQINWF9R.js","assets/ElevationSamplerData-k1b1ey21.js","assets/ElevationTile-nLRXAw2j.js","assets/Viewshed.glsl-D2C0nY_-.js","assets/WaterSurface.glsl-BrdOaNHj.js","assets/RenderGeometry-BYg-7xwk.js","assets/vec3f32-Cw9Q6TO_.js","assets/Texture-1xthaLvE.js","assets/Matrix4PassUniform-BH4JqvtO.js","assets/interfaces-B8ge7Jg9.js","assets/BindType-BmZEZMMh.js","assets/VertexAttribute-BnAa5VW0.js","assets/Util-D9KK83cB.js","assets/enums-BlUEVwJR.js","assets/Texture-Bq-Yp-pO.js","assets/basicInterfaces-wONHx_SN.js","assets/ShaderTechniqueConfiguration-D3UbJ2mX.js","assets/doublePrecisionUtils-B0owpBza.js","assets/Material-CL7oq3ds.js","assets/triangle-B-TmEFJd.js","assets/renderState-yUi34s5A.js","assets/requestImageUtils-CYZi7VGK.js","assets/orientedBoundingBox-Do1Vt1ct.js","assets/ElevationProvider-BU9L4pxM.js","assets/boundedPlane-xSVxcV1_.js","assets/verticalOffsetUtils-Bdqba6xa.js","assets/hydratedFeatures-Dp0VykK3.js","assets/projectVectorToVector-C51LtB8f.js","assets/frustum-Bdr-rFEQ.js","assets/weather-B3EDJgNZ.js","assets/Scheduler-DSoCN6Hr.js","assets/debugFlags-CX6JgPmI.js","assets/Float4DrawUniform-DSpHBPg2.js","assets/NestedMap-DgiGbX8E.js","assets/Octree-bjpgk3mA.js","assets/InterleavedLayout-D5nIvpjN.js","assets/types-D0PSWh4d.js","assets/floatRGBA-BcMV1NFr.js","assets/Intersector-Dzvq-gms.js","assets/glUtil-C6KhMg1m.js","assets/VertexElementDescriptor-BOD-G50G.js","assets/VertexArrayObject-DJNUJ_t_.js","assets/BufferObject-CLFFt1Oe.js","assets/ColorMaterial.glsl-r8qsLxA-.js","assets/VertexColor.glsl-DMQrT1G9.js","assets/dehydratedFeatures-ONP9sBF3.js","assets/featureConversionUtils-CGYMoz5K.js","assets/edgeUtils-7PCAzCge.js","assets/DecodeSymbolColor.glsl-BR7HIChu.js","assets/SnappingCandidate-O5eRSE6e.js","assets/Normals-FPkG6ULP.js","assets/objectResourceUtils-AgE6Mx7R.js","assets/devEnvironmentUtils-D6qIi8Ky.js","assets/DefaultMaterial_COLOR_GAMMA-iPR_ZT6p.js","assets/resourceUtils-Cd4X6-Sw.js","assets/CIMSymbolHelper-RNagakW-.js","assets/BidiEngine-BwB1Df7c.js","assets/fontUtils-BN6jNuTX.js","assets/GeometryUtils-ClkMWevA.js","assets/enums-BRXbslMp.js","assets/definitions-ByNBSgP9.js","assets/Rect-CUzevAry.js","assets/BoundingBox-Dn8AJClK.js","assets/lineStippleUtils-DdOUX39J.js","assets/projectVectorToPoint-sjRZ-2WD.js","assets/DefaultLayouts-DkwmdUjQ.js","assets/webStyleSymbolUtils-BLz2G3ck.js","assets/Intersector-juYjkWfX.js","assets/RenderCoordsHelper-BbU_hNrx.js","assets/scaleUtils-DL5-S4xE.js","assets/viewpointUtils-t8HSs1zS.js","assets/earthUtils-B4BKKXMy.js","assets/spatialReferenceSupport-BIiDjE2t.js","assets/terrainUtils-BzcC3xJT.js","assets/Environment-zbroFpii.js","assets/quantityUtils-B2xRWNSM.js","assets/Program-C3FgCIV9.js","assets/ShadowCastVisualizeTechniqueConfiguration-DXK-OiGG.js","assets/euclideanLengthMeasurementUtils-D2ZslYzK.js","assets/ray-8l9wECN6.js","assets/ZoomMomentumEstimator-COZR6STZ.js","assets/labelFormatUtils-DkVwf7tJ.js","assets/FeatureTileDescriptor3D-DtDBB7rP.js","assets/elevationInfoUtils-Dkzy2V0O.js","assets/ElevationQueryTileCache-BEPYiqMG.js","assets/LayerConstants-B33OP6sh.js","assets/ElevationRange-BrgM1moX.js","assets/geometryServiceUtils-DujY2RdF.js","assets/project-gQLDAKs4.js","assets/hitTestSelectUtils-UXJPjatw.js","assets/RenderableTile-Co1N3tXi.js","assets/enums-BRzLM11V.js","assets/config-MDUrh2eL.js","assets/TiledDisplayObject-wW3wbRrm.js","assets/DisplayObject-COGNSicI.js","assets/StyleDefinition-BK3ROBTO.js","assets/resources-DkiY2wAJ.js","assets/edgeProcessing-BaVy8Gc3.js","assets/testSVGPremultipliedAlpha-pEtBKrma.js","assets/RenderingContext-B8FOG7Ha.js","assets/ProgramCache-NPIMJ8lZ.js","assets/layerViewUtils-D2JqIDZ8.js","assets/vmEvent-D4Ubqkbq.js","assets/geometryEngine-s82Uc-OG.js","assets/geometryEngineBase-hNmXf8AX.js","assets/hydrated-CC1UoCrK.js","assets/OrientedImageryViewerViewModelAdapter3D-C7jLbvdO.js","assets/calcite-tooltip-BAYP_umi.js","assets/dom-Bb9h_pls.js","assets/floating-ui-Bi24_oLL.js","assets/debounce-BE9q2DI6.js","assets/openCloseComponent-C9eX_zZX.js","assets/FloatingArrow-DSHVPzyR.js","assets/calcite-action-nUAFESCb.js","assets/action-W5AlSpJC.js","assets/interactive-DP0XaYPR.js","assets/loadable-QAoPxwWP.js","assets/locale-CiqLNmAk.js","assets/key-DuBxtzvS.js","assets/observers-BDfujgVA.js","assets/component-CVleUxfT.js","assets/t9n-BUWevPjH.js","assets/icon-BWRRlyjd.js","assets/loader-DI4JVeCP.js","assets/calcite-action-group-DzEPgAgY.js","assets/action-group-BuhuSqSV.js","assets/conditionalSlot-bqgZ4YTq.js","assets/action-menu-BPjrKXqF.js","assets/array-l3358aeC.js","assets/popover-DmSCpKUv.js","assets/focusTrapComponent-CMnNxtIs.js","assets/Heading-DAjBEeC2.js","assets/calcite-action-bar-CKGzllii.js","assets/ExpandToggle-CWVmEX96.js","assets/calcite-label-D36Vj_AH.js","assets/label-NjdjENzu.js","assets/calcite-panel-BRPngiDd.js","assets/panel-BweYboDk.js","assets/scrim-CG0P7lnL.js","assets/calcite-slider-CmePdydA.js","assets/form-CZfgqAxW.js","assets/math-DGrr9aKX.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
import{bw as $,aR as le,g4 as Re,eM as Qe,j2 as Te,rV as Bt,eA as Ft,rW as z,ar as Dt,eV as dt,eW as ae,eB as Fi,v as l,z as re,c5 as Wt,w as jt,J as L,y as h,aN as Q,gg as It,gd as Ii,ei as qt,A as xe,h0 as ce,bv as Pi,jf as Ci,bm as Ri,rX as Zt,bH as se,hP as N,fw as Y,bJ as $i,aM as Ie,ep as ut,aS as Ut,fQ as Si,fO as zi,O as me,dm as mt,rY as Oi,lY as Pt,hn as pe,fv as Vi,U as Qt,rZ as Ai,ba as A,d3 as B,di as Ti,aa as Pe,ca as ee,mP as pt,bL as U,mQ as gt,P as yt,qy as Jt,qv as Ei,r_ as ki,bX as Li,cY as ie,aT as Kt,oo as Xt,B as Hi,gl as vt,bP as x,bR as ft,gx as wt,hD as Yt,iq as ei,r$ as Gi,s0 as Ni,gv as Bi,s1 as Di,s2 as ti,c8 as je,gz as Se,f0 as Ge,ln as Wi,aq as Ct,_ as ue,gD as ji,aW as Rt,cx as $t,k7 as _e,aZ as qi,a3 as Zi,W as Ui,gk as St,gm as Qi,rw as Ji,bK as Ki}from"./index-BfC8i6jT.js";import{M as Xi,u as Yi}from"./ImageryTileLayer-B-YZ2ypl.js";import bt from"./GraphicsLayer-B2JC83UW.js";import{w as ea,g as ta,u as zt,c as ia,P as aa,p as ii,a as ra,b as oa,d as ai,l as na}from"./OrientedImageryLayer-BJ2QFfLf.js";import{b as nt}from"./Circle-BB08Wuoo.js";import{$ as Ee}from"./Mesh-lqzZlCsM.js";import{m as ri}from"./lineSegment-DbTVMGoh.js";import{h as sa,a as la,w as ca}from"./MeshComponent-D498mY_W.js";import{l as _t}from"./MeshVertexAttributes-BD2PtWGl.js";import{B as oi,E as ha,g as Ot}from"./plane-ByuX_NXR.js";import da from"./ElevationLayer-DjnPzjXZ.js";import ua from"./ImageryLayer-Dimcsfbr.js";import{c as ma}from"./ElevationSamplerData-k1b1ey21.js";import{t as pa}from"./ElevationTile-nLRXAw2j.js";import{a as ga}from"./LercDecoder-BGMljx8H.js";import{d as ya,k as va,v as fa,X as wa}from"./sphere-BgvJtIjV.js";import{f as Je}from"./Viewshed.glsl-D2C0nY_-.js";import{e as ni}from"./vmEvent-D4Ubqkbq.js";import{rotate as Xe,intersect as ba,nearestCoordinate as _a}from"./geometryEngine-s82Uc-OG.js";import{N as Ma}from"./fetchRasterInfo-CRGzxPzd.js";import{l as Vt}from"./PolynomialTransform-CeuClFLJ.js";const Ke=new $({x:0,y:0,z:0,spatialReference:le.WebMercator}),qe=1e3,xa=114,Fa=120,Ia=50;function Pa(e,t,i){const[a,r,o,n]=t,[s,c,m,p]=i;return Ce(e,a,r,o,n,s,c,m,p)}function Ce(e,t,i,a,r,o,n,s,c){let m=!1;t.z===0&&i.z===0&&a.z===0&&r.z===0&&(t.z=i.z=a.z=r.z=1,e.z=1),t.z=t.z??1,i.z=i.z??1,a.z=a.z??1,r.z=r.z??1,o.z===0&&n.z===0&&s.z===0&&c.z===0&&(m=!0,o.z=n.z=s.z=c.z=1),o.z=o.z??1,n.z=n.z??1,s.z=s.z??1,c.z=c.z??1;const p=At(t,i,a,r),u=At(o,n,s,c),d=Bt(Ft(),p),g=Ft();g[0]=u[0]*d[0]+u[1]*d[4]+u[2]*d[8]+u[3]*d[12],g[1]=u[0]*d[1]+u[1]*d[5]+u[2]*d[9]+u[3]*d[13],g[2]=u[0]*d[2]+u[1]*d[6]+u[2]*d[10]+u[3]*d[14],g[3]=u[0]*d[3]+u[1]*d[7]+u[2]*d[11]+u[3]*d[15],g[4]=u[4]*d[0]+u[5]*d[4]+u[6]*d[8]+u[7]*d[12],g[5]=u[4]*d[1]+u[5]*d[5]+u[6]*d[9]+u[7]*d[13],g[6]=u[4]*d[2]+u[5]*d[6]+u[6]*d[10]+u[7]*d[14],g[7]=u[4]*d[3]+u[5]*d[7]+u[6]*d[11]+u[7]*d[15],g[8]=u[8]*d[0]+u[9]*d[4]+u[10]*d[8]+u[11]*d[12],g[9]=u[8]*d[1]+u[9]*d[5]+u[10]*d[9]+u[11]*d[13],g[10]=u[8]*d[2]+u[9]*d[6]+u[10]*d[10]+u[11]*d[14],g[11]=u[8]*d[3]+u[9]*d[7]+u[10]*d[11]+u[11]*d[15],g[12]=u[12]*d[0]+u[13]*d[4]+u[14]*d[8]+u[15]*d[12],g[13]=u[12]*d[1]+u[13]*d[5]+u[14]*d[9]+u[15]*d[13],g[14]=u[12]*d[2]+u[13]*d[6]+u[14]*d[10]+u[15]*d[14],g[15]=u[12]*d[3]+u[13]*d[7]+u[14]*d[11]+u[15]*d[15];const f=g[0]*e.x+g[1]*e.y+g[2]*e.z+g[3],v=g[4]*e.x+g[5]*e.y+g[6]*e.z+g[7],y=g[8]*e.x+g[9]*e.y+g[10]*e.z+g[11];let w=g[12]*e.x+g[13]*e.y+g[14]*e.z+g[15];return w===0&&(w=1),{x:f/w,y:v/w,z:m?0:y/w}}function At(e,t,i,a){const r=Ca([a.x,a.y,a.z,1],Bt(new Array(16),[e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,1,1,1,1])),o=r[0],n=r[1],s=r[2],c=new Array(16);return c[0]=o*e.x,c[1]=n*t.x,c[2]=s*i.x,c[3]=0,c[4]=o*e.y,c[5]=n*t.y,c[6]=s*i.y,c[7]=0,c[8]=o*e.z,c[9]=n*t.z,c[10]=s*i.z,c[11]=0,c[12]=o,c[13]=n,c[14]=s,c[15]=1,c}function Me(e,t,i,a,r=z()){return r[0]=e[0]+t[0]*i,r[1]=e[1]+t[1]*i,r[2]=e[2]+t[2]*(i/a),r}function k(e,t,i){const a=z();return a[0]=e[0]*t,a[1]=e[1]*t,a[2]=e[2]*(t/i),a}function ge(e,t){const[i,a,r]=e,o=z();return o[0]=i*t[0]+a*t[3]+r*t[6],o[1]=i*t[1]+a*t[4]+r*t[7],o[2]=i*t[2]+a*t[5]+r*t[8],o}function Ca(e,t){const[i,a,r,o]=e,n=new Array(4);return n[0]=i*t[0]+a*t[1]+r*t[2]+o*t[3],n[1]=i*t[4]+a*t[5]+r*t[6]+o*t[7],n[2]=i*t[8]+a*t[9]+r*t[10]+o*t[11],n[3]=i*t[12]+a*t[13]+r*t[14]+o*t[15],n}function Ve(e,t){const i=Math.PI/180,a=Fi();if(e==="OPK"){const r=Number(t[0])*i,o=Number(t[1])*i,n=Number(t[2])*i;a[0]=Math.cos(o)*Math.cos(n),a[1]=Math.cos(r)*Math.sin(n)+Math.sin(r)*Math.sin(o)*Math.cos(n),a[2]=Math.sin(r)*Math.sin(n)-Math.cos(r)*Math.sin(o)*Math.cos(n),a[3]=-Math.cos(o)*Math.sin(n),a[4]=Math.cos(r)*Math.cos(n)-Math.sin(r)*Math.sin(o)*Math.sin(n),a[5]=Math.sin(r)*Math.cos(n)+Math.cos(r)*Math.sin(o)*Math.sin(n),a[6]=Math.sin(o),a[7]=-Math.sin(r)*Math.cos(o),a[8]=Math.cos(r)*Math.cos(o)}else{const r=Number(t[0])*i,o=Number(t[1])*i,n=Number(t[2])*i;a[0]=Math.cos(r)*Math.cos(n)-Math.sin(r)*Math.cos(o)*Math.sin(n),a[1]=Math.sin(r)*Math.cos(n)*-1-Math.cos(r)*Math.cos(o)*Math.sin(n),a[2]=Math.sin(n)*Math.sin(o)*-1,a[3]=Math.cos(r)*Math.sin(n)+Math.sin(r)*Math.cos(o)*Math.cos(n),a[4]=Math.sin(r)*Math.sin(n)*-1+Math.cos(r)*Math.cos(o)*Math.cos(n),a[5]=Math.cos(n)*Math.sin(o),a[6]=Math.sin(r)*Math.sin(o)*-1,a[7]=Math.cos(r)*Math.sin(o)*-1,a[8]=Math.cos(o)}return a}function si(e,t,i){const a=Math.sin(i*Math.PI/180),r=Math.cos(i*Math.PI/180),o=[[e,0],[e,t],[0,t]];o.forEach((s,c)=>{o[c]=[r*s[0]-a*s[1],a*s[0]+r*s[1]]});const n={xmin:Math.min(0,o[0][0],o[1][0],o[2][0]),xmax:Math.max(0,o[0][0],o[1][0],o[2][0]),ymin:Math.min(0,o[0][1],o[1][1],o[2][1]),ymax:Math.max(0,o[0][1],o[1][1],o[2][1])};return{hfov:Math.abs(n.xmax-n.xmin),vfov:Math.abs(n.ymax-n.ymin)}}function Ra(e,t,i,a,r,o){const n=i*(t.x-e.x)+a*(t.y-e.y)+r*(t.z-e.z);if(n===0)return null;const s=-(i*e.x+a*e.y+r*e.z+o)/n;return{x:e.x+s*(t.x-e.x),y:e.y+s*(t.y-e.y),z:e.z+s*(t.z-e.z)}}function Mt(e,t){const i=Math.PI/180,a=e.y*i,r=e.x*i,o=e.z||0,n=t[0]*i,s=t[1]*i,c=t[2]/Math.sqrt(1-t[3]*Math.sin(n)**2),m=r-s,p=t[2]/Math.sqrt(1-t[3]*Math.sin(a)**2),u=t[3]*(c*Math.sin(n)-p*Math.sin(a));return{x:(p+o)*Math.cos(a)*Math.sin(m),y:(p+o)*(Math.sin(a)*Math.cos(n)-Math.sin(n)*Math.cos(a)*Math.cos(m))+u*Math.cos(n),z:(p+o)*(Math.sin(a)*Math.sin(n)+Math.cos(n)*Math.cos(a)*Math.cos(m))-c+u*Math.sin(n)}}function $a(e,t){const i=Math.PI/180,a=Number(e.x),r=Number(e.y),o=Number(e.z),n=t[0]*i,s=t[1]*i,c=t[2]/Math.sqrt(1-t[3]*Math.sin(n)**2),m=a/c,p=r/c,u=o/c,d=Math.cos(n)-Math.sin(n)*p+Math.cos(n)*u,g=Math.sin(n)+Math.cos(n)*p+Math.sin(n)*u,f=Math.sqrt(d**2+m**2),v=t[3]*c*Math.sin(n),y=n,w=Math.atan(g/f-(v-t[3]*(t[2]/Math.sqrt(1-t[3]*Math.sin(y)**2))*Math.sin(y))/(c*f)),b=Math.atan(g/f-(v-t[3]*(t[2]/Math.sqrt(1-t[3]*Math.sin(w)**2))*Math.sin(w))/(c*f)),_=Math.atan(g/f-(v-t[3]*(t[2]/Math.sqrt(1-t[3]*Math.sin(b)**2))*Math.sin(b))/(c*f)),F=Math.atan(g/f-(v-t[3]*(t[2]/Math.sqrt(1-t[3]*Math.sin(_)**2))*Math.sin(_))/(c*f)),I=Math.atan(a/(c*d))+s;return{x:I/i,y:F/i,z:a/(Math.cos(F)*Math.sin(I-s))-t[2]/Math.sqrt(1-t[3]*Math.sin(F)**2),spatialReference:{wkid:4326}}}function ke(e){return e&&Dt(e==null?void 0:e.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*e.y/dt.radius))):1}function st(e,t,i){const a=360/t,r=180/i;return{heading:(e.x-t/2)*a,pitch:90-(e.y-i/2)*r}}function Sa(e,t,i,a=qe/2){const{heading:r,pitch:o}=ci(e,a);return li(r,o,t,i)}function li(e,t,i,a){return{x:i/2+e/(360/i),y:a-t/(180/a),heading:e,pitch:t}}function ci(e,t){const i=Re(Math.acos(-e.z/t));return{heading:Re(Math.atan2(e.x,e.y)),pitch:i}}function lt(e,t,i=qe/2){return[i*(Math.sin(ae(e))*Math.sin(ae(t))),i*(Math.cos(ae(e))*Math.sin(ae(t))),i*Math.cos(ae(180-t))]}async function za(e,t,i){await Qe(t.spatialReference,e.spatialReference,null,i);const a=await Te(t,e.spatialReference,i);let r=Re(Math.atan2(a.y-e.y,a.x-e.x));return r=r>=0&&r<=90?90-r:r>90&&r<=180?360-r+90:90+Math.abs(r),r}function Ne(e,t,i){const a=Math.cos(i),r=Math.sin(i),o=[1,0,0,1,0,0],n=o[0]*a+o[2]*r,s=o[1]*a+o[3]*r,c=-o[0]*r+o[2]*a,m=-o[1]*r+o[3]*a;return o[0]=n,o[1]=s,o[2]=c,o[3]=m,[e*o[0]+t*o[2]+o[4],e*o[1]+t*o[3]+o[5]]}function Oa(e){return(e==null?void 0:e.type)===4}function Ye(e,t,i,a){return[[[i-e/Math.SQRT2,a-e/Math.SQRT2],[i+e/Math.SQRT2,a-e/Math.SQRT2],[i+t/Math.SQRT2,a-t/Math.SQRT2],[i-t/Math.SQRT2,a-t/Math.SQRT2]],[[i+e/Math.SQRT2,a-e/Math.SQRT2],[i+e/Math.SQRT2,a+e/Math.SQRT2],[i+t/Math.SQRT2,a+t/Math.SQRT2],[i+t/Math.SQRT2,a-t/Math.SQRT2]],[[i+e/Math.SQRT2,a+e/Math.SQRT2],[i-e/Math.SQRT2,a+e/Math.SQRT2],[i-t/Math.SQRT2,a+t/Math.SQRT2],[i+t/Math.SQRT2,a+t/Math.SQRT2]],[[i-e/Math.SQRT2,a+e/Math.SQRT2],[i-e/Math.SQRT2,a-e/Math.SQRT2],[i-t/Math.SQRT2,a-t/Math.SQRT2],[i-t/Math.SQRT2,a+t/Math.SQRT2]]]}function et(e,t,i){const[a,r,o,n]=e;return`M ${a.join(" ")} A ${t} ${t} 0 0 1 ${r.join(" ")} L ${o.join(" ")} A ${i} ${i} 0 0 0 ${n.join(" ")} Z`}function Va(e,t,i){const[a,r,o,n]=[...e,0];return[...Ye(a,r,t,i).map(s=>et(s,a,r)),...Ye(r,o,t,i).map(s=>et(s,r,o)),...Ye(o,n,t,i).map(s=>et(s,o,n))]}const Z="esri-oriented-imagery-viewer",Be=`${Z}__carousel`,tt=`${Z}__image-enhancement`,J=`${Z}__navigation`,Aa="--oi-navigation-tool-rotation-from",Ta="--oi-navigation-tool-rotation-to",P={addCoverage:`${Z}__body-additional-coverage`,addExpPoints:`${Z}__body-additional-camera-locations`,body:`${Z}__body`,carousel:`${Z}__carousel`,carouselContainer:`${Be}-container`,carouselContent:`${Be}-content`,carouselItem:`${Be}-item`,carouselItemWrapper:`${Be}-item-wrapper`,close:`${Z}__close`,currentCoverage:`${Z}__body-current-coverage`,dock:`${Z}--docked`,feature:`${J}-feature`,float:`${Z}--floating`,footprint:`${Z}__body-footprint`,imageEnhancementWrapper:`${tt}-wrapper`,imageEnhancementTools:`${tt}-tools`,imageEnhancementToolContainer:`${tt}-tool-container`,messageBox:`${Z}__message-box`,navigationPathOffset0:`${J}-feature-path-stop-offset-0`,navigationPathOffset1:`${J}-feature-path-stop-offset-1`,navigationWrapper:`${J}-wrapper`,navigationZoomed:`${J}-wrapper--zoomed`,north:`${J}-pointer-north`,outerSector:`${J}-sector-outer`,pointer:`${J}-pointer`,rotateWithAnimation:`${J}-animate`,selectedFeaturePath:`${J}-feature-path`,sector:`${J}-sector`,sectorCross:`${J}-sector-cross`,sectorDisabled:`${J}-sector-disabled`,sectorEnabled:`${J}-sector-enabled`,sectorSeparator:`${J}-sector-separator`,submenu:`${Z}__submenu`,viewer:`${Z}__viewer`,viewerContainer:`${Z}__viewer-container`},Tt=120,E=[21,36,51,60],Ea=3.5,it=["FAR_WEST","FAR_NORTH","FAR_EAST","FAR_SOUTH","WEST","NORTH","EAST","SOUTH","NEAR_WEST","NEAR_NORTH","NEAR_EAST","NEAR_SOUTH"],oe=23.937554159486076,ne=96.06244584051393,at={EAST:[oe,oe,ne,oe,60,oe],NORTH:[oe,ne,oe,oe,oe,60],SOUTH:[ne,oe,ne,ne,ne,60],WEST:[ne,ne,oe,ne,60,ne]};let ct=class{static getCameraOrientation(e){return ea(e)}static register(e,t,i){ta.set(e,{desc:t,constructor:i})}};ct=l([re("esri.layers.orientedImagery.core.cameraOrientationFactory")],ct);const ka=ct;function La(e){throw new xe("exposure-point:missing-default-value",`a value for ${e} is missing in default properties`)}function Ha(e,t){throw new xe("exposure-point:missing-attribute-value",`a value for ${e} is missing in attribute table`,{exposurePoint:t})}let R=class extends Wt(jt){constructor(t){super(t),this.cameraOrientation=null,this.elevation=null,this.elevationSource=null,this.name=null,this.sourceMap=null}read(t,i){const a={},{attributes:r,layer:o,geometry:n}=t,s={};for(const c in r)a[c.toLowerCase()]=r[c],s[c.toLowerCase()]=c;super.read({geometry:n,layer:o??{},sourceMap:s,...a},i)}write(t,i){const a=super.write(t,i),{sourceMap:r}=this;if(!r||!a)return a;const o={};for(const n in a){const s=r[n.toLowerCase()];s&&(o[s]=a[n])}return o}readCameraHeading(t,i){const{cameraheading:a,camheading:r,layer:o}=i;return a??r??o.cameraHeading}readCameraHeight(t,i){const{cameraheight:a,avghtag:r,layer:o}=i;return a??r??o.cameraHeight}readCamOffset(t,i){const{cameraoffset:a,camoffset:r}=i;return(a==null?void 0:a.split(";").map(Number))??(r==null?void 0:r.split(";").map(Number))??null}writeCameraOffset(t,i){t&&(i.cameraOffset=t.join(";"))}readCameraOrientation(t,i){const{cameraorientation:a,camori:r}=i;return a??r}readCameraPitch(t,i){const{camerapitch:a,campitch:r,layer:o}=i;return a??r??o.cameraPitch}readCameraRoll(t,i){const{cameraroll:a,camroll:r,layer:o}=i;return a??r??o.cameraRoll}readDepthImage(t,i){const{depthimage:a,depthimg:r,layer:o}=i,n=a??r??null,{depthImagePathPrefix:s,depthImagePathSuffix:c}=o??{};return zt(n,s,c)}readElevationSource(t,i){const{elevationsource:a,layer:r}=i,{demPathSuffix:o,demPathPrefix:n}=r;if(a){const s=this._parseIfJSON(a);return ia(s,n,o)}return r.effectiveElevationSource}readFarDistance(t,i){const{fardistance:a,fardist:r,layer:o}=i;return a??r??o.farDistance}readHFOV(t,i){const{horizontalfieldofview:a,hfov:r,layer:o}=i;return a??r??o.horizontalFieldOfView}readImageURL(t,i){const{imagepath:a,layer:r}=i;a||Ha("imagePath",this);const{imagePathPrefix:o,imagePathSuffix:n}=r;return zt(a,o,n)}readImageRotation(t,i){const{imagerotation:a,imgrot:r,layer:o}=i;return a??r??o.imageRotation}get isHorizontal(){return this.orientedImageryType==="horizontal"}get isInspection(){return this.orientedImageryType==="inspection"}get isNadir(){return this.orientedImageryType==="nadir"}get isOblique(){return this.orientedImageryType==="oblique"}get isSpherical(){return this.orientedImageryType==="360"}get location(){const{cameraOrientation:t,cameraHeight:i,elevation:a}=this;if(t){const{type:o,x:n,y:s,z:c,horizontalWKID:m}=t;return new $({x:n,y:s,z:c,spatialReference:{wkid:o===aa.LTP?4326:m}})}if(typeof i!="number")throw La("cameraHeight");const r=this.geometry.clone();return r.z=r.hasZ?r.z:(a??0)+i,r}readNearDistance(t,i){const{neardistance:a,neardist:r,layer:o}=i;return a??r??o.nearDistance}readOrientationAccuracy(t,i){const{accuracy:a,orientationaccuracy:r}=i;return(r==null?void 0:r.split(";").map(Number))??(a==null?void 0:a.split(";").map(Number))??null}writeOrientationAccuracy(t,i){t&&(i.orientationAccuracy=t.join(";"))}readOIType(t,i){const{orientedimagerytype:a,oitype:r,camerapitch:o,campitch:n,layer:s}=i,c=ii.read(a??r??s.orientedImageryType),m=o??n??s.cameraPitch;return c==="oblique"?m<10?"nadir":"oblique":c}readVFOV(t,i){const{verticalfieldofview:a,vfov:r,layer:o}=i;return a??r??o.verticalFieldOfView}_parseIfJSON(t){let i=null;try{i=JSON.parse(t)}catch(a){L.getLogger(this).error("couldn't parse the given elevation source JSON",t,a)}return i}};l([h({type:Date,json:{write:{enabled:!0,target:"aquisitionDate"},name:"acquisitiondate"}})],R.prototype,"acquisitionDate",void 0),l([h({type:Number,json:{write:!0,read:{source:["cameraheading","camheading","layer.cameraHeading"]}}})],R.prototype,"cameraHeading",void 0),l([Q("cameraHeading")],R.prototype,"readCameraHeading",null),l([h({type:Number,json:{write:!0}})],R.prototype,"cameraHeight",void 0),l([Q("cameraHeight",["cameraheight","avghtag","layer.cameraHeight"])],R.prototype,"readCameraHeight",null),l([h()],R.prototype,"cameraOffset",void 0),l([Q("cameraOffset",["cameraoffset","camoffset"])],R.prototype,"readCamOffset",null),l([It("cameraOffset")],R.prototype,"writeCameraOffset",null),l([h({json:{write:{writer:(e,t,i)=>{t[i]=e.toString()}}},type:ra}),Ii(e=>e?ka.getCameraOrientation(e):null)],R.prototype,"cameraOrientation",void 0),l([Q("cameraOrientation",["cameraorientation","camori"])],R.prototype,"readCameraOrientation",null),l([h({type:Number,json:{write:!0}})],R.prototype,"cameraPitch",void 0),l([Q("cameraPitch",["camerapitch","campitch","layer.cameraPitch"])],R.prototype,"readCameraPitch",null),l([h({type:Number,json:{write:!0}})],R.prototype,"cameraRoll",void 0),l([Q("cameraRoll",["cameraroll","camroll","layer.cameraRoll"])],R.prototype,"readCameraRoll",null),l([h({json:{write:!0},type:String})],R.prototype,"depthImage",void 0),l([Q("depthImage",["depthimage","depthimg"])],R.prototype,"readDepthImage",null),l([h({type:Number,json:{write:!0}})],R.prototype,"elevation",void 0),l([h({json:{write:!0},clonable:"reference"})],R.prototype,"elevationSource",void 0),l([Q("elevationSource",["elevationsource","layer.effectiveElevationSource"])],R.prototype,"readElevationSource",null),l([h({json:{name:"exposurestationid",write:{target:"exposureStationId"}},type:String})],R.prototype,"exposureStationId",void 0),l([h({type:Number,json:{write:!0}})],R.prototype,"farDistance",void 0),l([Q("farDistance",["fardistance","fardist","layer.farDistance"])],R.prototype,"readFarDistance",null),l([h({type:$,json:{name:"geometry"}})],R.prototype,"geometry",void 0),l([h({type:Number,json:{write:!0}})],R.prototype,"horizontalFieldOfView",void 0),l([Q("horizontalFieldOfView",["horizontalfieldofview","hfov","layer.horizontalFieldOfView"])],R.prototype,"readHFOV",null),l([h({json:{write:!0},type:String})],R.prototype,"imagePath",void 0),l([Q("imagePath",["imagepath"])],R.prototype,"readImageURL",null),l([h({type:Number,json:{write:!0}})],R.prototype,"imageRotation",void 0),l([Q("imageRotation",["imagerotation","imgrot","layer.imageRotation"])],R.prototype,"readImageRotation",null),l([h()],R.prototype,"isHorizontal",null),l([h()],R.prototype,"isInspection",null),l([h()],R.prototype,"isNadir",null),l([h()],R.prototype,"isOblique",null),l([h()],R.prototype,"isSpherical",null),l([h()],R.prototype,"location",null),l([h({json:{write:!0},type:String})],R.prototype,"name",void 0),l([h({type:Number,json:{write:!0}})],R.prototype,"nearDistance",void 0),l([Q("nearDistance",["neardistance","neardist","layer.nearDistance"])],R.prototype,"readNearDistance",null),l([h({json:{write:!0,name:"objectid"},type:Number})],R.prototype,"objectId",void 0),l([h()],R.prototype,"orientationAccuracy",void 0),l([Q("orientationAccuracy",["accuracy","orientationaccuracy"])],R.prototype,"readOrientationAccuracy",null),l([It("orientationAccuracy")],R.prototype,"writeOrientationAccuracy",null),l([qt(ii)],R.prototype,"orientedImageryType",void 0),l([Q("orientedImageryType",["orientedimagerytype","oitype","layer.orientedImageryType"])],R.prototype,"readOIType",null),l([h({type:Number,json:{name:"sortorder",write:{target:"sortOrder"}}})],R.prototype,"sortOrder",void 0),l([h({type:Object})],R.prototype,"sourceMap",void 0),l([h({type:Number,json:{write:!0}})],R.prototype,"verticalFieldOfView",void 0),l([Q("verticalFieldOfView",["verticalfieldofview","vfov","layer.verticalFieldOfView"])],R.prototype,"readVFOV",null),R=l([re("esri.layers.orientedImagery.core.ExposurePoint")],R);const Ze=R,ze={},Ga=1e3;async function Na(e,t){var s;const{point:i,queryParams:a}=e;if(i==null)return null;const r={};let o=e.layerInstanceOrURL;const n=i.spatialReference.isGeographic?ce(i.clone()):i.clone();if(r.outSpatialReference=n.spatialReference,a&&(r.maxRecordCountFactor=a.maxRecordCountFactor??5,r.outFields=a.outFields??["*"],r.where=a.where??"1=1",r.returnGeometry=a.returnGeometry??!0,r.outSpatialReference=a.outSpatialReference),typeof o=="string"&&(ze.layer&&ze.layer.url===o?o=ze.layer:((s=ze.layer)==null||s.destroy(),o=ze.layer=new oa({url:o}))),o)try{await o.load();const c=o,m=Da(n,(a==null?void 0:a.maximumDistance)??c.maximumDistance??Ga);r.returnZ=c.hasZ;const p=new Pi({geometry:m,...r}),u=await c.queryFeatures(p,t);return Ba(c)(u)}catch(c){Ci(c)}return null}function Ba(e){return t=>{const{features:i,spatialReference:a}=t;return i.forEach(r=>{r.geometry&&(r.geometry.spatialReference=a);const o=Ze.fromJSON({...r.toJSON(),layer:e});o&&(r.attributes=o),r.layer=e,r.spatialReference=a}),t}}function Da(e,t){const i=e.x-t,a=e.x+t,r=e.y-t,o=e.y+t;return new Ri({xmin:i,xmax:a,ymin:r,ymax:o,spatialReference:e.spatialReference})}function Wa(e){const{camera:t,features:i,selectedPoint:a}=e;if(!i.length)return[];e.currentImage??(e.currentImage={attributes:{cameraHeading:0,cameraPitch:0}});const r=ja(t,a,e.currentImage);return i.map(r)}function ja(e,t,i){return t.z??(t.z=0),t.elevation??(t.elevation=0),a=>{const{hfovWeight:r,vfovWeight:o,distanceWeight:n}=qa(a.attributes,e?"3d":"2d"),s=a.attributes,{cameraHeight:c,cameraHeading:m,cameraPitch:p,farDistance:u,horizontalFieldOfView:d,verticalFieldOfView:g,isOblique:f}=s,v=s.geometry,y=180*Math.atan2(v.y-t.y,v.x-t.x)/Math.PI,w=Zt(t,v);let b,_,F=d,I=g,S=!1;e?(b=e.heading,_=e.tilt,F=180,I=180,S=!0):!f||p<10?(b=m,_=p,S=!1):(b=i.attributes.cameraHeading,_=p,S=!0,F=180),b>180&&(b-=360);let C=1;v.spatialReference.isWebMercator&&(C=1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*v.y/dt.radius))));const T=Math.sqrt((Math.sqrt((t.x-v.x)**2+(t.y-v.y)**2)/C)**2+((t.z??0)-(t.elevation??0)-c)**2),O=90-180*Math.atan2(t.y-v.y,t.x-v.x)/Math.PI;let W=(Math.abs(O-b)>180?Math.abs(360-Math.abs(O-b)):Math.abs(O-b))/F;W=4*W+1;const K=180*Math.acos((s.cameraHeight-(t.z??0)+(t.elevation??0))/T)/Math.PI;let X=Math.abs(K-_)/I;X=4*X+1;let he=T/Math.sqrt(u**2+c**2);he=4*he+1;const be=r*W+o*X+n*he;let ye;if(S){const ve=m>180?m-360:m;ye=r*((Math.abs(O-ve)>180?Math.abs(360-Math.abs(O-ve)):Math.abs(O-ve))/d*4+1)+o*(Math.abs(K-p)/g*4+1)+n*he}else ye=be;return{suitability:be,trueSuitability:ye,feature:a,angle:y,distance:w,verticalAngle:Math.abs(180*Math.atan(w/c)/Math.PI)}}}function qa(e,t){const i="isOblique"in e?e:new Ze(e),{isOblique:a,isSpherical:r,isNadir:o}=i;return r?{hfovWeight:t==="2d"?0:1,vfovWeight:t==="2d"?0:.6,distanceWeight:t==="2d"?1:.5}:o?{hfovWeight:.25,vfovWeight:1,distanceWeight:1}:a?{hfovWeight:1,vfovWeight:.25,distanceWeight:1}:{hfovWeight:1,vfovWeight:1,distanceWeight:1}}const D=Math.PI/180;function hi(e){return e.isSpherical?Ja(e):Za(e)}function Za(e){const{horizontalFieldOfView:t,verticalFieldOfView:i,geometry:a,cameraHeading:r}=e,o=ke(a);let n=e.cameraPitch,s=e.cameraRoll,c=150;t>150&&(n=90,s=0,c=5);const m=Math.ceil(t/c),p=Ua(m,r,t);let u=e.farDistance?e.farDistance*o:e.cameraHeight*o/Math.cos(n*D);e.cameraPitch+i/2>=90&&(u=(e.farDistance||20)*o);const d=new se({spatialReference:a==null?void 0:a.spatialReference});d.imageID=e.objectId;let g=null;for(const f of p)g=Qa(f,n,s,e,a,u,o,i,t,m,d);return g.imageID=e.objectId,{polygon:d,frustum:g}}function Ua(e,t,i){const a=[];if(e%2==0)for(let r=0;r<e/2;r++)a.push(t-i/e*(r+.5),t+i/e*(r+.5));else{a.push(t);for(let r=1;r<e/2;r++)a.push(t-i/e*r,t+i/e*r)}return a.sort(),a}function Qa(e,t,i,a,r,o,n,s,c,m,p){const u=Ve("HPR",[e,t,i]),d=Xa(a,u),g=ge([0,0,-1],u),{x:f,y:v}=r,y=Me([f,v,a.cameraHeight],g,o,n),w=2*Math.tan(s*D/2)*o,b=2*Math.tan(c/m*D/2)*o,_=ge([0,1,0],u),F=ge([1,0,0],u),I=k(_,w/2,n),S=k(F,b/2,n),C=N(z(),I,S),T=Y(z(),I,S),O=di([Y(z(),y,C),Y(z(),y,T),N(z(),y,C),N(z(),y,T)],a.cameraHeight,r,n);return O.push(O[0]),p.addRing(O),d}function di(e,t,i,a){return e.map(r=>Ya(r,t,i,a))}function Ja(e){const{geometry:t,farDistance:i,objectId:a,nearDistance:r,cameraHeight:o}=e,n=ke(t),s=new nt({center:t.clone(),radius:i*n});if(s.imageID=a,r){const p=new nt({center:t.clone(),radius:r*n});s.addRing(p.rings[0])}const c=t.clone();c.z=o-i*n;const m=Ee.createSphere(c,{size:2*i*n});return m.imageID=a,{polygon:s,frustum:m}}function Ka(e,t){return e.contains(t)}function rt(e,t){return Math.sign(e)!==Math.sign(t)}function Xa(e,t,i){const{cameraHeight:a,cameraPitch:r,farDistance:o,geometry:n,horizontalFieldOfView:s,nearDistance:c,verticalFieldOfView:m}=e,p=ui(n),u=c<0?0:c*p;let d=a*p/Math.cos(r*D),g=!0;r+m/2>=90&&(d=(o??20)*p,g=!1);const f=2*Math.tan(m*D/2)*u,v=2*Math.tan(s*D/2)*u,y=2*Math.tan(m*D/2)*d,w=2*Math.tan(s*D/2)*d;let b,_;_=[0,0,-1],_=ge(_,t),b=Me([n.x,n.y,a],_,d,p),g&&(b[2]=0);const F=Me([n.x,n.y,a],_,u,p);let I=[0,1,0];I=ge(I,t);let S=[1,0,0];S=ge(S,t);let C=[],T=[];u?(T=[{faces:[4,0,3,4,7,3]},{faces:[5,1,2,5,6,2]},{faces:[4,0,1,4,5,1]},{faces:[6,2,3,6,7,3]}],C=C.concat(Y(z(),F,N(z(),k(I,f/2,p),k(S,v/2,p)))),C=C.concat(Y(z(),F,Y(z(),k(I,f/2,p),k(S,v/2,p)))),C=C.concat(N(z(),F,N(z(),k(I,f/2,p),k(S,v/2,p)))),C=C.concat(N(z(),F,Y(z(),k(I,f/2,p),k(S,v/2,p))))):(C=[n.x,n.y,a],T=[{faces:[0,1,2,0,2,3,0,3,4,0,4,1]}]),C=C.concat(Y(z(),b,N(z(),k(I,y/2,p),k(S,w/2,p)))),C=C.concat(Y(z(),b,Y(z(),k(I,y/2,p),k(S,w/2,p)))),C=C.concat(N(z(),b,N(z(),k(I,y/2,p),k(S,w/2,p)))),C=C.concat(N(z(),b,Y(z(),k(I,y/2,p),k(S,w/2,p))));const O=new _t({position:Float64Array.from(C)});return new Ee({vertexAttributes:O,components:T,spatialReference:n.spatialReference})}function Ya(e,t,i,a){{const r=Math.sqrt((e[2]-t)**2+(Math.sqrt((e[0]-i.x)**2+(e[1]-i.y)**2)/a)**2)*a,o=k(N(z(),[e[0],e[1],e[2]],[i.x,i.y,t]),1/r,1/a),n=t/(t-e[2]),s={x:(1-n)*i.x+n*e[0],y:(1-n)*i.y+n*e[1],z:(1-n)*t+n*e[2]},c=Math.sqrt((s.z-t)**2+(Math.sqrt((s.x-i.x)**2+(s.y-i.y)**2)/a)**2)*a,m=k(N(z(),[s.x,s.y,s.z],[i.x,i.y,t]),1/c,1/a);return rt(o[0],m[0])&&rt(o[1],m[1])&&rt(o[2],m[2])||e[2]>=0?[e[0],e[1],0]:[s.x,s.y,s.z]}}function er(e){const{spatialReference:t,x:i,y:a}=e.geometry,{cameraHeading:r,cameraPitch:o,farDistance:n,nearDistance:s}=e,c=ui(e.geometry),m=new se({spatialReference:t}),p=Math.abs(1.44*n*c);let u=Math.abs(1.44*s*c);(o<20||r==null)&&(u=p);const d=[];return d[0]={x:i+p*Math.sin((r-45)*D),y:a+p*Math.cos((r-45)*D)},d[1]={x:i+p*Math.sin((r+45)*D),y:a+p*Math.cos((r+45)*D)},d[2]={x:i+u*Math.sin((r+135)*D),y:a+u*Math.cos((r+135)*D)},d[3]={x:i+u*Math.sin((r+225)*D),y:a+u*Math.cos((r+225)*D)},m.addRing([[d[0].x,d[0].y,0],[d[1].x,d[1].y,0],[d[2].x,d[2].y,0],[d[3].x,d[3].y,0],[d[0].x,d[0].y,0]]),m}function ui(e){return e&&Dt(e==null?void 0:e.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*e.y/dt.radius))):1}function tr(e,t){const i=1+t/100;if(e.declaredClass==="esri.geometry.Circle"){const{radius:a,center:r}=e,o=new nt({radius:a*i,center:r});return e.rings.length>1&&o.addRing(e.rings[1]),o}if(e.declaredClass==="esri.geometry.Polygon"){const a=new se({spatialReference:e.spatialReference}),r=e.centroid;if(r){const o=[];for(let n=0;n<e.rings[0].length;n++){const s=Math.sqrt((r.x-e.rings[0][n][0])**2+(r.y-e.rings[0][n][1])**2),c=k(N(z(),[e.rings[0][n][0],e.rings[0][n][1],0],[r.x,r.y,0]),1/s,1),m=Me([r.x,r.y,0],c,s*i,1);o.push({x:m[0],y:m[1]})}a.addRing([[o[0].x,o[0].y,0],[o[1].x,o[1].y,0],[o[2].x,o[2].y,0],[o[3].x,o[3].y,0],[o[0].x,o[0].y,0]])}return a}return e}async function yo(e,t,i){const{cameraHeight:a,cameraLocation:r,cameraPitch:o,frustumVertices:n,horizontalFieldOfView:s,imageHeight:c,imageWidth:m,inSRS:p,outSRS:u,verticalFieldOfView:d,cameraRoll:g,imageRotation:f,options:v}=i,y=new le(p),w=new le(u),b=si(s,d,g??0),_=n.length>15;return o+b.vfov/2>=90?await nr(n,e,m,c,y,w,_,f,v):await ir(n,e,t,r,a,_,y,w,v)}async function ir(e,t,i,a,r,o,n,s,c){const m=ar(e,t,i,a,r);if(!m)return;const{farPlane:p,nearPlane:u}=m,d=await mi([...(u==null?void 0:u.vertexPositions)??e.slice(0,3),...p.vertexPositions],n,s,c);return new Ee({vertexAttributes:new _t({position:d}),components:gi(pi(o)),spatialReference:s})}function ar(e,t,i,a,r){const o=Et(e),n=Et(e,"near");if(!o)return;const{coefficients:s}=o,c=t.length;for(let m=0;m<c;m++){const p=sr([i[m][0],i[m][1]],s),u=i[m];u[2]=(u[2]>=0?p:u[2])??0;const d=[u[0]-a[0],u[1]-a[1],u[2]-(a[2]??r)];or(a,d,m,n),rr(a,d,m,o,i,p)}return{farPlane:o,nearPlane:n}}function rr(e,t,i,a,r,o){const{coefficients:n,vertexPositions:s}=a;if(o!=null&&o>=0)s.splice(3*i,3,...r[i]);else{const c=ut();oi(n,ri(e,t),c)&&s.splice(3*i,3,...c)}}function or(e,t,i,a){if(!a)return;const r=ut();oi(a.coefficients,ri(e,t),r)&&a.vertexPositions.splice(3*i,3,...r)}async function nr(e,t,i,a,r,o,n,s=0,c){const m=Math.cos((s??0)*D),p=Math.sin((s??0)*D),u=Math.abs(i*m+a*p),d=Math.abs(i*-p+a*m);let g,f,v=n?new Array:[e[0],e[1],e[2]],y=new Array;const w=t.length;for(let _=0;_<w;_++){const F=[u/2,d/2],I=t[_];f=[(I[0]-F[0])*m-(I[1]-F[1])*p+F[0],(I[0]-F[0])*p+(I[1]-F[1])*m+F[1]],n?(g=Ce({x:f[0],y:f[1],z:1},{x:0,y:0,z:1},{x:i,y:0,z:1},{x:i,y:a,z:1},{x:0,y:a,z:1},{x:e[0],y:e[1],z:e[2]},{x:e[3],y:e[4],z:e[5]},{x:e[6],y:e[7],z:e[8]},{x:e[9],y:e[10],z:e[11]}),v=v.concat([g.x,g.y,g.z]),g=Ce({x:f[0],y:f[1],z:1},{x:0,y:0,z:1},{x:i,y:0,z:1},{x:i,y:a,z:1},{x:0,y:a,z:1},{x:e[12],y:e[13],z:e[14]},{x:e[15],y:e[16],z:e[17]},{x:e[18],y:e[19],z:e[20]},{x:e[21],y:e[22],z:e[23]}),y=y.concat([g.x,g.y,g.z])):(g=Ce({x:f[0],y:f[1],z:1},{x:0,y:0,z:1},{x:i,y:0,z:1},{x:i,y:a,z:1},{x:0,y:a,z:1},{x:e[3],y:e[4],z:e[5]},{x:e[6],y:e[7],z:e[8]},{x:e[9],y:e[10],z:e[11]},{x:e[12],y:e[13],z:e[14]}),v=v.concat([g.x,g.y,g.z]))}v=v.concat(y);const b=await mi(v,r,o,c);return new Ee({vertexAttributes:new _t({position:b}),components:gi(pi(n)),spatialReference:o})}async function mi(e,t,i,a){if(t.equals(i))return e;const r=e.reduce((n,s,c)=>{const m=Math.floor(c/3);return n[m]||(n[m]=new Array),n[m].push(s),n},new Array),{points:o}=await Te(new $i(r,t),i,a);return Ie(a),o.flat()}function sr(e,t){if(t)return(-t[3]-t[0]*e[0]-t[1]*e[1])/t[2]}function Et(e,t="far"){const i=ha();let a;switch(t){case"far":if(a=Array.from(e.length===15?e.slice(3):e.slice(12)),Ot(i,a,!1))return{coefficients:i,vertexPositions:a};break;case"near":return a=Array.from(e.slice(0,12)),e.length===15||!Ot(i,a,!1)?void 0:{coefficients:i,vertexPositions:a}}}const pi=e=>e?[{faces:new Uint32Array([4,0,3,4,7,3])},{faces:new Uint32Array([5,1,2,5,6,2])},{faces:new Uint32Array([4,0,1,4,5,1])},{faces:new Uint32Array([6,2,3,6,7,3])}]:[{faces:new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1])}],gi=e=>e.map(t=>new sa(t)),De=Math.PI/180;async function $e(e,t,i=!1){if(!e)return[];e=e.map(o=>o.declaredClass==="esri.geometry.Point"?o:$.fromJSON(o));const{feature:a}=t,{attributes:r}=a;if(isNaN(parseFloat(r.elevation))){const o=await Ae([a.geometry],t);a.attributes.elevation=o[0].z}return Ae(e,t,i).then(o=>cr(o,t))}async function Ae(e,t,i=!1){var c;if(i)return e;const{feature:{attributes:{cameraOrientation:a,elevationSource:r,cameraHeight:o,location:n},elevationSample:s}}=t;return s?Promise.all(e.map(ht(s,t.options))):r&&(ai(r)||(c=r.url)!=null&&c.length)?lr(e,t):We(e,a&&typeof n.z=="number"?n.z-o:0)}async function lr(e,t){const{feature:i,options:a,footprintExtent:r}=t,o=i.attributes.elevationSource;if(!o)return e;if(ai(o)){const{constantElevation:c}=o;return typeof c!="number"?e:We(e,c)}const{url:n}=o;if(!n)return e;const{elevationSample:s}=i;if(!s){if(!r)return e;const c=r.clone(),{error:m,isSupported:p,isDynamic:u}=await na(n);if(!p){L.getLogger(o).warn(m);const{location:f,cameraHeight:v,cameraOrientation:y}=i.attributes;return We(e,y&&typeof f.z=="number"?f.z-v:0)}let d,g=e;try{if(u){d=new ua({url:n,format:"lerc",rasterFunction:{functionName:o.rasterFunction??"None"}}),await d.load(a);let f,v=512,y=512;const w=r.width/r.height;w>1?(y/=w,f=c.height/y):(v*=w,f=c.width/v);const b=await d.fetchImage(r,v,y,a),_=Ut.create({scales:[f],size:512,spatialReference:r.spatialReference}),F=new Si(null,0,0,0,zi(r)),I=new ga(b.pixelData.pixelBlock.pixels[0],v,y,0),S=new pa(F,I);i.elevationSample=new ma(S,_,void 0)}else d=new da(n),await d.load(),i.elevationSample=await d.createElevationSampler(c,a);g=await Promise.all(e.map(ht(i.elevationSample,a)))}catch(f){if(!me(f)){L.getLogger("esri.layers.orientedImagery.transformations.groundToImageUtils").warn(`#updateElevation() failed to update elevation using the provided elevation source URL: ${n}. Please provide a valid elevation source url.`,f);const{location:v,cameraHeight:y,cameraOrientation:w}=i.attributes;e=We(e,w&&typeof v.z=="number"?v.z-y:0)}}finally{d==null||d.destroy()}return g}return await Qe(e[0].spatialReference,s.spatialReference,null,t.options),Promise.all(e.map(ht(s,a)))}function ht(e,t){return Ie(t),async i=>{i.z=1;const a=e.queryElevation(mt(i,e.spatialReference));return a!=null&&a.z&&(i.z=(await Te(a,i.spatialReference,t)).z),i}}function We(e,t){return e.map(i=>(i.z=t,i))}function cr(e,t){var a;const{attributes:i}=t.feature;return i.isSpherical||i.horizontalFieldOfView===360?hr(e,t):(a=i.cameraOrientation)!=null&&a.isAdvanced?mr(e,t):Promise.resolve(ur(e,t))}async function hr(e,t){const i=Array.isArray(e)?e:[e],a=new Array,{location:r,cameraOrientation:o,cameraHeading:n}=t.feature.attributes,s=t.imageProperties.height??1,c=t.imageProperties.width??1;return await dr(r,i,n,c,s,a,o),a}async function dr(e,t,i,a,r,o,n){const s=e.spatialReference.isWGS84&&(n==null?void 0:n.type)!==4?ce(e):new $(e),{latitude:c,longitude:m,ellipsoidRadius:p,squaredEccentricity:u}=n??{};for(const d of t){const g=d.spatialReference.isWGS84&&(n==null?void 0:n.type)===4?new $(Mt(d,[c,m,p,u])):d.spatialReference.equals(s.spatialReference)?new $(d):await Te(d,s.spatialReference),f=Zt(s,g);g.x-=s.x,g.y-=s.y,g.z=(g.z??0)-(s.z??0);const v=ci(g,f);v.heading=(v.heading-i)%360;const{x:y,y:w}=li(v.heading,v.pitch,a,r);o.push(new $(y,w,Ke.spatialReference))}}function ur(e,t){var b;const{feature:i,imageProperties:a}=t,{width:r,height:o}=a,{attributes:n}=i,s=Ve("HPR",[n.cameraHeading,n.cameraPitch,n.cameraRoll]),c=Math.sin(n.imageRotation??0*De),m=Math.cos(n.imageRotation??0*De),p=r??1,u=o??1,d=[Math.abs(m*p+c*u),Math.abs(m*u-c*p)],g={horizontal:1/(2*Math.tan(n.horizontalFieldOfView*De/2)),vertical:1/(2*Math.tan(n.verticalFieldOfView*De/2))},f=[-g.horizontal,0,.5,0,g.vertical,.5,0,0,1];let v=new $(n.location);v.spatialReference.isWGS84&&((b=n.cameraOrientation)==null?void 0:b.type)!==4&&(v=ce(v));const y=v.spatialReference.isWebMercator?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*v.y/6378137))):1,w=Oi(new Array(9),s,f);return e.map(_=>{var K;let F=new $(_);if(F.spatialReference.isWGS84)if(((K=n.cameraOrientation)==null?void 0:K.type)===4){const X=n.cameraOrientation;F=new $(Mt(F,[X.latitude,X.longitude,X.ellipsoidRadius,X.squaredEccentricity]))}else F=new $(ce(F));const I=(F.z??0)-(v.z??0),S=(F.x-v.x)/y,C=(F.y-v.y)/y,T=(w[0]*S+w[1]*C+w[2]*I)/(w[6]*S+w[7]*C+w[8]*I),O=(w[3]*S+w[4]*C+w[5]*I)/(w[6]*S+w[7]*C+w[8]*I),W={x:T*d[0],y:O*d[1]};return{x:m*(W.x-d[0]/2)+c*(W.y-d[1]/2)+p/2,y:-c*(W.x-d[0]/2)+m*(W.y-d[1]/2)+u/2}})}function mr(e,t){var g;const{feature:i}=t,{attributes:a}=i,r=a.cameraOrientation;if(!r)throw new xe("groundToImageUtils:missing-camera-orientation-parameters","CameraOrientation Parameters are required to perform advanced transformations");let o=new $(a.location);o.spatialReference.isWGS84&&((g=a.cameraOrientation)==null?void 0:g.type)!==4&&(o=ce(o));const n=o.spatialReference.isWebMercator?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*o.y/6378137))):1;let s;if(r.declaredClass==="esri.layers.orientedImagery.core.CameraOrientationOPK"){const{omega:f,phi:v,kappa:y}=r;s=Ve("OPK",[f,v,y])}else{const{cameraHeading:f,cameraPitch:v,cameraRoll:y}=a;s=Ve("HPR",[f,v,y])}const{principalOffsetPoint:c,focalLength:m,radialDistortionCoefficients:p,affineTransformations:u,tangentialDistortionCoefficients:d}=r;return Promise.all(e.map(async f=>{let v;return f.spatialReference.equals(o.spatialReference)?(v=new $(f),y(v)):(await Qe(e[0].spatialReference,o.spatialReference,null,t.options),v=mt(f,o.spatialReference),y(v));function y(w){var xt;if(w.spatialReference.isWGS84)if(((xt=a.cameraOrientation)==null?void 0:xt.type)===4){const He=a.cameraOrientation;w=new $(Mt(w,[He.latitude,He.longitude,He.ellipsoidRadius,He.squaredEccentricity]))}else w=new $(ce(w));const b=(w.z??0)-(o.z??0),_=(w.x-o.x)/n,F=(w.y-o.y)/n,I=(s[0]*_+s[1]*F+s[2]*b)/(s[6]*_+s[7]*F+s[8]*b),S=(s[3]*_+s[4]*F+s[5]*b)/(s[6]*_+s[7]*F+s[8]*b),C=I**2+S**2;let T=0,O=0,W=0,K=0,X=0,he=0,be=0;p&&(T=p[0]??0,O=p[1]??0,W=p[2]??0),d&&(K=d[0],X=d[1]),c&&(he=c[0]??0,be=c[1]??0);const ye=1+(T||0)*C+(O||0)*C*C+(W||0)*C*C*C;let ve=I*ye+(K||0)*(C+2*I**2)+2*(X||0)*I*S,Le=S*ye+(X||0)*(C+2*S**2)+2*(K||0)*I*S;return ve=-(m??0)*ve+he,Le=-(m??0)*Le+be,{x:Number(u[0])+Number(u[1])*ve+Number(u[2])*Le,y:Number(u[3])+Number(u[4])*ve+Number(u[5])*Le}}}))}function kt(e,t){if(!e)return Promise.resolve([]);const i=t.feature;let a=i.attributes;return a instanceof Ze||(a=Ze.fromJSON(i),a&&(i.attributes=a)),pr(e,t)}function pr(e,t){const{attributes:i}=t.feature;if(i.isSpherical||i.horizontalFieldOfView===360){const{location:a,cameraOrientation:r,farDistance:o,cameraHeading:n,cameraHeight:s}=i;return gr(e,a,o,[t.imageProperties.width,t.imageProperties.height],n,s,r)}return yr(e,t)}async function gr(e,t,i,a,r,o,n){let s=new $(t);s.spatialReference.isGeographic&&s.spatialReference.isWGS84&&(n==null?void 0:n.type)!==4&&(s=ce(s));const c=ke(s),m=new Array,[p,u,d]=s.toArray(),g=ya([p,u,d??0],i*c),f=Ke.toArray();for(const v of e){let y,w;if(Pt(v.heading)&&Pt(v.pitch))y=v.heading,w=v.pitch;else{const S=st({x:v.x,y:v.y},a[0],a[1]);y=S.heading,w=S.pitch}y=(y+r)%360;const b=va([f[0],f[1],f[2]],lt(y,w)),_=fa([p,u,d??0],b.direction),F=ut();wa(g,_,F);const I=(s.z??0)-o;if(F[2]<I){const S=Math.abs((s.z-I)/-b.direction[2])*c;Me([s.x,s.y,s.z],b.direction,S,c,F)}else F[2]=I;m.push(new $(F,s.spatialReference))}return m}async function yr(e,t){const{feature:i,footprintExtent:a,options:r}=t,{attributes:{cameraHeight:o,cameraOrientation:n,cameraPitch:s,cameraRoll:c,elevationSource:m,horizontalFieldOfView:p,location:u,verticalFieldOfView:d},elevationSample:g}=i,f=Oa(n),{vfov:v}=si(p,d,c??0);let y=new $(u),w=!1;f&&(y=new $($a(y,[n.latitude,n.longitude,n.ellipsoidRadius,n.squaredEccentricity]))),y.spatialReference.isWGS84&&(w=!0,y=ce(y));const b=ke(y),_=wr(t,y,b),F=f?_.map(C=>pe(new $(C))):_,I=await $e(F,t,!0).then(C=>C.map(T=>({x:T.x,y:T.y,z:1}))),S=new Array;for(const C of e){const T={...C,z:1},O={...Pa(T,I,F),spatialReference:y.spatialReference},[W]=await $e([f?pe(new $(O)):new $(O)],t,!0);await _r(T,W,I,F,y,O,f,t);const K=i.attributes.clone();K.geometry=y.clone();const{polygon:X}=hi(K),he=X.rings[0].map(ye=>new $(ye,X.spatialReference)),be=await Te(m||g?await vr({cameraLocation:y,groundFootPrint:he,projectedPoint:O,webMercatorScalingFactor:b,vfov:v,shouldConvertToLatLong:w,isCameraOrientationLTP:f,imgPoint:T},t):new $(Oe(O,y,b,y.z-o,s,v,w)),a.spatialReference,r);S.push(be)}return S}async function vr(e,t){const{cameraLocation:i,groundFootPrint:a,projectedPoint:r,webMercatorScalingFactor:o,vfov:n,shouldConvertToLatLong:s,isCameraOrientationLTP:c,imgPoint:m}=e,{cameraHeight:p,cameraPitch:u}=t.feature.attributes;await Qe(i.spatialReference,t.footprintExtent.spatialReference,null,t.options);let d=await br(a,t),g=0,f=(i.z??0)-p,v=0;for(;v<10;){const y=Mr(d,i,r);if(!y||!fr([i.x,i.y,i.z],[y.x,y.y,y.z],[r.x,r.y,r.z]))return new $(Oe(r,i,o,f,u,n,s));const w=new $({x:y.x,y:y.y,z:y.z,spatialReference:i.spatialReference}),b=await $e([c?pe(w):w],t);if(g=Math.abs(m.x-b[0].x)+Math.abs(m.y-b[0].y),f=y.z,g<=1)return new $(Oe(r,i,o,f,u,n,s));v+=1;const{extent:_}=d,F=((_==null?void 0:_.width)??0)/10,I=((_==null?void 0:_.height)??0)/10;if(F<1||I<1)return new $(Oe(r,i,o,f,u,n,s));const{x:S,y:C}=y,T=await Ae(yi(F,I).map(([O,W])=>new $({x:S+O,y:C+W,spatialReference:i.spatialReference})),t,!1);T.push(T[0]),d=new se({rings:[T.map(O=>O.toArray())],spatialReference:i.spatialReference})}return new $(Oe(r,i,o,f,u,n,s))}const fr=(e,t,i)=>Vi(N(z(),t,e),N(z(),i,e))>0;function Oe(e,t,i,a,r,o,n){const s=Math.sqrt((e.z-t.z)**2+(Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2)/i)**2)*i,c=k(N(z(),[e.x,e.y,e.z],[t.x,t.y,t.z]),1/s,1/i);if(e.z<a||r+o/2<90){const m=Math.abs((t.z-a)/-c[2])*i,p=Me([t.x,t.y,t.z],c,m,i);e.x=p[0],e.y=p[1],e.z=p[2]}else e.z=a;return n?pe(new $(e)).toJSON():e}function wr(e,t,i){const{feature:a}=e,{attributes:r}=a,o=2*Math.tan(ae(r.verticalFieldOfView)/2)*r.farDistance*i,n=2*Math.tan(ae(r.horizontalFieldOfView)/2)*r.farDistance*i,s=Ve("HPR",[r.cameraHeading,r.cameraPitch,r.cameraRoll??0]),c=ge([0,0,-1],s),m=Me([t.x,t.y,t.z],c,r.farDistance*i,i),p=ge([0,1,0],s),u=ge([1,0,0],s),d=k(p,o/2,i),g=k(u,n/2,i),f=N(z(),d,g),v=Y(z(),d,g);return[Y(z(),m,f),Y(z(),m,v),N(z(),m,f),N(z(),m,v)].map(y=>{const[w,b,_]=y;return new $({x:w,y:b,z:_,spatialReference:t.spatialReference})})}async function br(e,t){const i=e[0].spatialReference.isWGS84?le.WebMercator:e[0].spatialReference,{cameraHeight:a,location:r,elevation:o}=t.feature.attributes,n=typeof r.z=="number"&&typeof o=="number"?r.z-o:a,s=di(e.map(({x:m,y:p,z:u})=>[m,p,u]),n,r,ke(r)),c=(await Ae(s.map(m=>new $(m,r.spatialReference)),t,!1)).map(m=>mt(m,i));return new se({hasZ:!0,rings:[c.map(m=>[m.x,m.y,m.z])],spatialReference:i})}async function _r(e,t,i,a,r,o,n,s){let c=0;const m=8;for(let p=0;p<=m;p+=1){if(c=Math.abs(e.x-t.x)+Math.abs(e.y-t.y),c<=1)return;const[u,d,g,f]=yi(c,c).map(([S,C])=>({...Ce({x:e.x+S,y:e.y+C,z:1},i[0],i[1],i[2],i[3],{x:a[0].x,y:a[0].y,z:a[0].z},{x:a[1].x,y:a[1].y,z:a[1].z},{x:a[2].x,y:a[2].y,z:a[2].z},{x:a[3].x,y:a[3].y,z:a[3].z}),spatialReference:r.spatialReference})),[v,y,w,b]=await $e(n?[pe(new $(u)),pe(new $(d)),pe(new $(g)),pe(new $(f))]:[new $(u),new $(d),new $(g),new $(f)],s,!0).then(S=>S.map(C=>({...C,z:0}))),{x:_,y:F,z:I}=Ce(e,v,y,w,b,u,d,g,f);o.x=_,o.y=F,o.z=I,[t]=await $e([n?pe(new $(o)):new $(o)],s,!0)}}function Mr(e,t,i){const a={x:e.rings[0][0][0],y:e.rings[0][0][1],z:e.rings[0][0][2]},r={x:e.rings[0][1][0],y:e.rings[0][1][1],z:e.rings[0][1][2]},o={x:e.rings[0][1][0],y:e.rings[0][1][1],z:e.rings[0][1][2]},n={x:e.rings[0][2][0],y:e.rings[0][2][1],z:e.rings[0][2][2]},s=(n.z-o.z)*(r.y-a.y)-(n.y-o.y)*(r.z-a.z),c=-((n.z-o.z)*(r.x-a.x)-(r.z-a.z)*(n.x-o.x)),m=(n.y-o.y)*(r.x-a.x)-(r.y-a.y)*(n.x-o.x),p=-(s*a.x+c*a.y+m*a.z);return Ra(t.toJSON(),i,s,c,m,p)}const yi=(e,t)=>[[-e,-t],[e,-t],[e,t],[-e,t]];function xr(e){return(e==null?void 0:e.type)==="3d"}function Fr(e){return(e==null?void 0:e.declaredClass)==="esri.Graphic"}function Lt(e){return/.*\.(tif|mrf)$/i.test(e??"")}function Ir(e){return Math.abs(e)>=135?"WEST":e<-45&&e>-135?"SOUTH":e<=45?"EAST":"NORTH"}function Pr(e,t){const i=e/t*E[2];return i<=E[0]?"NEAR":i<=E[1]?"":"FAR"}function Cr(e){return e&&e.url&&e.datasetFormat?e:null}function Rr(e){return typeof e=="string"&&e.length?e:Cr(e)}function $r(e){return(e==null?void 0:e.name)==="NoAttachmentError"}const vi=e=>`${e}:missing-property`,fi=(e,t)=>`Property ${t} is missing in ${e}`,wi=(e="esri.widgets.OrientedImageryViewer",t)=>{throw L.getLogger(e).error(t),t},Sr=async(e,t)=>{var i;try{const a=await Qt(e,{...t,method:"head"});return(i=a==null?void 0:a.getHeader)==null?void 0:i.call(a,"Content-Type")}catch(a){return L.getLogger("esri.widgets.OrientedImagery").error("failed to fetch Content-Type",a),null}};function zr(e,t){t!==0&&(e.xmin/=t,e.xmax*=t,e.ymin/=t,e.ymax*=t)}let de=class extends Wt(jt){constructor(t){super(t),this.maxFOV=0,this.minFOV=0,this.view=null,this.zoomFactor=5}get canZoomIn(){return!!this.view&&(this.minFOV===0||this.view.camera.fov>this.minFOV)}get canZoomOut(){return!!this.view&&(this.maxFOV===0||this.view.camera.fov<this.maxFOV)}};l([h({type:Boolean,readOnly:!0})],de.prototype,"canZoomIn",null),l([h({type:Boolean,readOnly:!0})],de.prototype,"canZoomOut",null),l([h({type:Number})],de.prototype,"maxFOV",void 0),l([h({type:Number})],de.prototype,"minFOV",void 0),l([h({type:Je})],de.prototype,"view",void 0),l([h({type:Number})],de.prototype,"zoomFactor",void 0),de=l([re("esri.widgets.PanoramicViewer.PanoramicZoomConditions")],de);const Ue=de;let we=class extends Ai{constructor(t){super(t),this.panoramicZoomConditions=new Ue,this.zoomTo=i=>{this.view.camera.fov=this.constrainFOV(i),this.view.camera=this.view.camera.clone()}}initialize(){this.addHandles([A(()=>{var t;return[(t=this.view)==null?void 0:t.ready,this.panoramicZoomConditions]},()=>{var t;(t=this.view)!=null&&t.ready&&(this.panoramicZoomConditions.view=this.view,this.zoomTo(this.view.camera.fov))},B),A(()=>[this.panoramicZoomConditions.maxFOV,this.panoramicZoomConditions.minFOV],([t,i])=>{t!=null&&i!=null&&this.zoomTo(this.view.camera.fov)},Ti)])}get canZoomIn(){return this.panoramicZoomConditions.canZoomIn}get canZoomOut(){return this.panoramicZoomConditions.canZoomOut}get state(){var t;return(t=this.view)!=null&&t.ready?"ready":"disabled"}set view(t){this._set("view",t)}constrainFOV(t){const{maxFOV:i,minFOV:a}=this.panoramicZoomConditions;return Pe(t,a,i)}zoomIn(){if(!this.canZoomIn)return;const t=this.view.camera.fov-this.panoramicZoomConditions.zoomFactor;this.zoomTo(t)}zoomOut(){if(!this.canZoomOut)return;const t=this.view.camera.fov+this.panoramicZoomConditions.zoomFactor;this.zoomTo(t)}};l([h()],we.prototype,"canZoomIn",null),l([h()],we.prototype,"canZoomOut",null),l([h({type:Ue})],we.prototype,"panoramicZoomConditions",void 0),l([h()],we.prototype,"state",null),l([h({type:Je})],we.prototype,"view",null),we=l([re("esri.widgets.PanoramicViewer.PanoramicZoomViewModel")],we);const Or=we;function Vr(e,t=Ke,i=qe){const a=t.clone();a.z=-qe/2;const r=Ee.createSphere(a,{size:i,densificationFactor:2,vertexSpace:"georeferenced",material:new la({colorTexture:new ca({data:e})})});if(r.components[0].trustSourceNormals=!0,r.vertexAttributes.uv){const o=r.vertexAttributes.uv.length??0;for(let n=0;n<o;n++)r.vertexAttributes.uv[2*n+0]=1-r.vertexAttributes.uv[2*n+0],r.vertexAttributes.uv[2*n+1]=r.vertexAttributes.uv[2*n+1]}return r.centerAt(a),r}function Ar(e){return new ee({geometry:e,symbol:new pt({symbolLayers:new U([new gt])})})}function ot(e,t){return 2*Re(Math.atan(Math.tan(ae(e/2))*Math.sqrt(t**2+1)))}const Fe={autoLoad:"auto-load",default:"default",navigation:"navigation",fovConstraint:"fov-constraint",clickAction:"image-click-action"};let H=class extends yt.EventedAccessor{constructor(t){super(t),this._startPosition=null,this._targetPosition=null,this._graphics=new bt({elevationInfo:{mode:"relative-to-ground"}}),this._imageGraphic=null,this._loadController=null,this._map=new Jt({ground:new Ei({opacity:0,navigationConstraint:null}),layers:new U([this._graphics])}),this._zoomViewModel=null,this.autoLoad=!1,this.clickAction="none",this.imageSize=null,this.imageSource=null,this.pitch=90,this.state="ready",this.yaw=0,this._addNavigationHandles=()=>{this.imageRenderer.basemapTerrain.suspended=!0,this.imageRenderer.constraints.tilt.max=180,this.removeHandles(Fe.navigation),this.addHandles([this.imageRenderer.on("mouse-wheel",this._handleWheel),this.imageRenderer.on("double-click",this._handleDoubleClick),this.imageRenderer.on("drag",this._handleDrag),this.imageRenderer.on("key-down",i=>{const a=["+","-","Shift","_","=","ArrowUp","ArrowDown","ArrowRight","ArrowLeft"],r=i.key;a.includes(r)&&i.stopPropagation()})],Fe.navigation)},this._addHFOVHandles=()=>{this.removeHandles(Fe.fovConstraint),this.addHandles(A(()=>[this.maxHFOV,this.minHFOV],()=>{this._zoomViewModel&&(this._zoomViewModel.panoramicZoomConditions=new Ue({view:this.imageRenderer,maxFOV:this.maxHFOV,minFOV:this.minHFOV}))},B),Fe.fovConstraint)},this._addZoomHandles=()=>{this._zoomViewModel=new Or({view:this.imageRenderer,panoramicZoomConditions:new Ue({maxFOV:this.maxHFOV,minFOV:this.minHFOV})});const i=new ki({viewModel:this._zoomViewModel});this.imageRenderer.ui.add(i,"top-left"),this._addHFOVHandles()},this._cancelLoadWithController=()=>{var i;(i=this._loadController)==null||i.abort(),this._loadController=null},this._handleDoubleClick=i=>{i.stopPropagation(),i.native.ctrlKey?this._zoomOut():this._zoomIn()},this._handleDrag=i=>{i.stopPropagation();const{action:a,x:r,y:o}=i;switch(a){case"start":this._startPosition=this._targetPosition={x:r,y:o};break;case"update":this._targetPosition={x:r,y:o},this._updateCameraHeadingAndTilt()}},this._handleImageClick=i=>{if(this.state==="image-loaded"&&this.imageRenderer.ready)switch(this.clickAction){case"emit":i.stopPropagation(),this.emit("click",i);break;case"hittest":i.stopPropagation(),i.async(async()=>{const a=await this.imageRenderer.hitTest(i.screenPoint,{include:this._graphics});this.emit("hittest-response",a)});break;case"pixel-location":{if(i.stopPropagation(),!this.imageSize||!i.mapPoint)return void this.emit("pixel-location",null);const a=Sa(i.mapPoint,this.imageSize[0],this.imageSize[1]);this.emit("pixel-location",{...a,spatialReference:le.WebMercator,meshVertex:i.mapPoint});break}}},this._handleWheel=i=>{const a=i.deltaX??i.native.deltaX;i.stopPropagation(),a>0||i.deltaY>0?this._zoomOut():this._zoomIn()},this._loadWithController=()=>{this._cancelLoadWithController(),this._loadController=new AbortController,this.loadImage(this._loadController)},this._zoomIn=()=>{var i;return(i=this._zoomViewModel)==null?void 0:i.zoomIn()},this._zoomOut=()=>{var i;return(i=this._zoomViewModel)==null?void 0:i.zoomOut()},this.addGraphic=(i,a)=>this.state==="image-loaded"&&!this._graphics.graphics.includes(i)&&(this._graphics.graphics.add(i,a),!0),this.addManyGraphics=i=>{if(this.state!=="image-loaded")return!1;const a=i.filter(r=>!this._graphics.graphics.includes(r));return this._graphics.graphics.addMany(a),!0},this.clearGraphics=()=>{this._graphics.graphics.removeAll()},this.clearImage=()=>{this.imageSize=null,this._removeImageSphere()},this.removeGraphic=i=>!(this.state!=="image-loaded"||!this._graphics.graphics.includes(i))&&(this._graphics.remove(i),!0),this.removeManyGraphics=i=>{if(this.state!=="image-loaded")return!1;const a=i.filter(r=>this._graphics.graphics.includes(r));return this._graphics.removeMany(a),!0},this._imageRenderer=new Je({map:this._map,viewingMode:"local",camera:{position:Ke},environment:{atmosphereEnabled:!1,starsEnabled:!1,lighting:{type:"virtual"}},popupEnabled:!1,spatialReference:le.WebMercator,ui:{components:["attribution"]}})}initialize(){this.state="initialized",this.addHandles([A(()=>this.imageSource,()=>{this.imageSource&&this.autoLoad&&this._loadWithController()},B),A(()=>this.fov,()=>{this._reloadCamera()},B),A(()=>this.yaw,t=>{this.camera.heading=t,this._reloadCamera()},B),A(()=>this.pitch,t=>{this.camera.tilt=t,this._reloadCamera()},B),Li(()=>this.imageRenderer.ready,()=>{this._addNavigationHandles(),this._addZoomHandles()},B),A(()=>this.clickAction,t=>{this.removeHandles(Fe.clickAction),t!=="none"&&this.addHandles(this.imageRenderer.on("click",this._handleImageClick))},B)],Fe.default)}get camera(){return this.imageRenderer.camera}set camera(t){t&&(this.imageRenderer.camera=t.clone())}get fov(){return this.camera.fov}set fov(t){var i;Number.isFinite(t)&&((i=this._zoomViewModel)==null||i.zoomTo(t))}get hfov(){const{fov:t}=this.camera,{size:[i,a]}=this.imageRenderer,r=i/a,o=Math.atan(r);return 2*Re(Math.atan(Math.tan(ae(t/2))*Math.sin(o)))}get imageRenderer(){return this._imageRenderer}get maxHFOV(){const{size:[t,i]}=this.imageRenderer;return ot(Fa,t/i)}get minHFOV(){const{size:[t,i]}=this.imageRenderer;return ot(Ia,t/i)}get vfov(){const{fov:t}=this.camera,{size:[i,a]}=this.imageRenderer,r=i/a,o=Math.atan(r);return 2*Re(Math.atan(Math.tan(ae(t/2))*Math.cos(o)))}async _loadImageInternal(t,i){let a;this.state="image-loading";try{a=(await Qt(t,{responseType:"image",...i})).data}catch(r){throw me(r)?this.state="image-load-aborted":this.state="image-load-error",r}return this._updateImageSphere(a,i)}_reloadCamera(){this.camera=this.camera.clone()}_removeImageSphere(){this._imageGraphic&&(this._graphics.remove(this._imageGraphic),this._imageGraphic=ie(this._imageGraphic)),this.state="ready",this.imageSize=null}_updateCameraHeadingAndTilt(){if(!this._startPosition||!this._targetPosition)return;const t=this.camera.heading+(this._startPosition.x-this._targetPosition.x)/this.imageRenderer.width*this.camera.fov;this.yaw=(t+360)%360;const i=this.camera.tilt-(this._startPosition.y-this._targetPosition.y)/this.imageRenderer.height*this.imageRenderer.camera.tilt;this.pitch=Math.min(179.5,Math.max(.5,i)),this._startPosition=this._targetPosition}async _updateImageSphere(t,i){await Kt(i);const{size:[a,r]}=this.imageRenderer;return this._imageGraphic=Ar(Vr(t)),this._graphics.add(this._imageGraphic),this.fov=ot(xa,a/r),this.state="image-loaded",this.imageSize=[t.width,t.height],this._imageGraphic.geometry}async loadImage(t){return this._removeImageSphere(),this.imageSource?this._loadImageInternal(this.imageSource,t):wi(this.declaredClass,new xe(vi("panoramic-viewer"),fi("PanoramicViewerViewModel","imageSource")))}};l([h()],H.prototype,"_graphics",void 0),l([h()],H.prototype,"_imageGraphic",void 0),l([h()],H.prototype,"_imageRenderer",void 0),l([h()],H.prototype,"_loadController",void 0),l([h()],H.prototype,"_map",void 0),l([h()],H.prototype,"_zoomViewModel",void 0),l([h({type:Boolean})],H.prototype,"autoLoad",void 0),l([h({type:Xt})],H.prototype,"camera",null),l([qt(new Hi({emit:"emit",hittest:"hittest",none:"none","pixel-location":"pixel-location"}))],H.prototype,"clickAction",void 0),l([h({type:Number})],H.prototype,"fov",null),l([h({readOnly:!0})],H.prototype,"hfov",null),l([h({readOnly:!0})],H.prototype,"imageRenderer",null),l([h()],H.prototype,"imageSize",void 0),l([h()],H.prototype,"imageSource",void 0),l([h({readOnly:!0})],H.prototype,"maxHFOV",null),l([h({readOnly:!0})],H.prototype,"minHFOV",null),l([h({type:Number})],H.prototype,"pitch",void 0),l([h()],H.prototype,"state",void 0),l([h({readOnly:!0})],H.prototype,"vfov",null),l([h({type:Number})],H.prototype,"yaw",void 0),H=l([re("esri.widgets.PanoramicViewer.PanoramicViewerViewModel")],H);const bi=H,Tr="esri-panoramic-viewer";let j=class extends vt{constructor(t){super(t),this.viewModel=new bi,this._afterContainerCreate=i=>{this.imageRenderer.container=i},this.addGraphic=(i,a)=>{this.viewModel.addGraphic(i,a)},this.addManyGraphics=i=>{this.viewModel.addManyGraphics(i)},this.clearGraphics=()=>{this.viewModel.clearGraphics()},this.clearImage=()=>{this.viewModel.clearImage()},this.loadImage=i=>this.viewModel.loadImage(i),this.removeGraphic=i=>{this.viewModel.removeGraphic(i)},this.removeManyGraphics=i=>{this.viewModel.removeManyGraphics(i)}}get autoLoad(){return this.viewModel.autoLoad}set autoLoad(t){this.viewModel.autoLoad=t}get camera(){return this.viewModel.camera}set camera(t){t&&(this.viewModel.camera=t)}get clickAction(){return this.viewModel.clickAction}set clickAction(t){this.viewModel.clickAction=t}get fov(){return this.camera.fov}set fov(t){this.viewModel.fov=t}get hfov(){return this.viewModel.hfov}get icon(){return"360-view"}set icon(t){this._overrideIfSome("icon",t)}get imageRenderer(){return this.viewModel.imageRenderer}get imageSize(){return this.viewModel.imageSize}get imageSource(){return this.viewModel.imageSource}set imageSource(t){this.viewModel.imageSource=t}get pitch(){return this.viewModel.pitch}set pitch(t){this.viewModel.pitch=t}get state(){return this.viewModel.state}get vfov(){return this.viewModel.vfov}get yaw(){return this.viewModel.yaw}set yaw(t){this.viewModel.yaw=t}render(){return x("div",{afterCreate:this._afterContainerCreate,bind:this,class:this.classes(ft.widget,Tr)})}};l([h({type:Boolean})],j.prototype,"autoLoad",null),l([h({type:Xt})],j.prototype,"camera",null),l([h()],j.prototype,"clickAction",null),l([h({type:Number})],j.prototype,"fov",null),l([h({readOnly:!0,type:Number})],j.prototype,"hfov",null),l([h()],j.prototype,"icon",null),l([h({readOnly:!0,type:Je})],j.prototype,"imageRenderer",null),l([h({readOnly:!0})],j.prototype,"imageSize",null),l([h()],j.prototype,"imageSource",null),l([h({type:Number})],j.prototype,"pitch",null),l([h({readOnly:!0})],j.prototype,"state",null),l([h({readOnly:!0,type:Number})],j.prototype,"vfov",null),l([ni(["click","hittest-response","pixel-location"]),h({type:bi})],j.prototype,"viewModel",void 0),l([h({type:Number})],j.prototype,"yaw",null),j=l([re("esri.widgets.PanoramicViewer")],j);const Er=j,kr=new wt({size:15,style:"circle",color:[255,102,102,.5],outline:null}),Lr=new wt({size:10,style:"circle",color:[0,128,192,.5],outline:null}),_o=new Yt({style:"solid",color:[0,128,192,.5],outline:null}),Mo=new Yt({style:"solid",color:[255,102,102,.5],outline:null}),Ht=new wt({size:10,style:"diamond",color:[255,102,102],outline:null}),Hr=new ei({symbolLayers:new U([new Gi({size:10,material:{color:"red"},resource:{primitive:"x"},outline:{color:"black",size:1}})])}),Gr=new ei({symbolLayers:new U([new Ni({width:9,height:9,depth:9,material:{color:[255,102,102]},resource:{primitive:"diamond"},castShadows:!1})])}),Gt=new Bi({data:{type:"CIMSymbolReference",symbol:{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,size:10,frame:{xmin:-5,ymin:-5,xmax:5,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[0,1.4142135623730951],[3.585786437626905,5],[5,3.585786437626905],[1.4142135623730951,0],[5,-3.585786437626905],[3.585786437626905,-5],[0,-1.4142135623730951],[-3.585786437626905,-5],[-5,-3.585786437626905],[-1.4142135623730951,0],[-5,3.585786437626905],[-3.585786437626905,5],[0,1.4142135623730951]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,width:1,color:[0,0,0,100]},{type:"CIMSolidFill",enable:!0,color:[255,0,0,255]}]}}]}]}}}),xo=new pt({symbolLayers:new U([new gt({material:{color:[255,102,102,.5]},edges:null})])}),Fo=new pt({symbolLayers:new U([new gt({material:{color:[0,128,192,.25]},edges:null})])}),Nt={click:"click-handle",enhancements:"enhancements-handle",rotation:"rotation-handle"};let G=class extends yt.EventedAccessor{constructor(e){super(e),this._imageChanged=!1,this._panConstraint=null,this._image=null,this._loadController=null,this._overlays=new bt,this._map=new Jt,this.autoLoad=!1,this.clickAction="none",this.error=null,this.imageSource=null,this.imageRotation=0,this.state="ready",this._cancelLoadWithController=()=>{var t;(t=this._loadController)==null||t.abort(),this._loadController=null},this._createImageHandles=()=>{this.removeHandles(Nt.enhancements),this.addHandles(A(()=>[this.brightness,this.contrast,this.sharpness],([t,i,a])=>{var r;(r=this.image)!=null&&r.loaded&&(this.image.effect=`contrast(${10*(i+10)}%) brightness(${10*(t+10)}%)`,this.sharpenImage(this.image,a))},B))},this._createPanConstraint=()=>{const{image:t,imageRenderer:i}=this,a=r=>{if(!(t&&i&&r.targetGeometry&&t.serviceRasterInfo))return r;const{extent:o}=t.serviceRasterInfo,{constraints:n,rotation:s,width:c,height:m}=i,{extent:p}=Xe(se.fromExtent(o),s),{width:u,height:d}=p,g=r.targetGeometry.clone(),f=n.scaleToZoom(r.scale),v=1/2**f,y=c/m;let w=v*u,b=v*d;f&&(u/c>d/m?b=w/y:w=b*y);const _=p.clone();return _.xmin+=w/2,_.xmax-=w/2,_.ymin+=b/2,_.ymax-=b/2,r.targetGeometry=_a(_,g).coordinate,this.state="image-loaded",r};return{constrain:a,applyPanConstraint:a}},this._createResizeHandles=t=>{t.removeHandles("resize"),t.addHandles(A(()=>{if(!this.imageRenderer.ready)return;const{extent:i}=t.serviceRasterInfo,{width:a,height:r,rotation:o}=this.imageRenderer,{extent:n}=Xe(se.fromExtent(i),o),{width:s,height:c}=n;return Math.max(s/a,c/r)},i=>{if(!this.imageRenderer||i==null)return;const{constraints:a,scale:r,spatialReference:o}=this.imageRenderer,n=a.minScale,s=Di(o),c=.25*s,m=s*i;let p=m;const u=[];for(;p>c;)u.push(p),p/=2;u.push(p);const{lods:d}=Ut.create({scales:u});if(a.set({minScale:m,lods:d}),this._imageChanged)return this.imageRenderer.scale=m,void(this._imageChanged=!1);this.imageRenderer.scale=Math.abs(r-n)<=1e-6?m:r},B),"resize")},this._loadImageInternal=(t,i={})=>{this.clearImage(),this.error=null,this._imageChanged=!0,this.state="image-loading";const a=typeof t=="string",r=a?void 0:t.datasetFormat,o=a?t:t.url,{customParameters:n,options:s}=i;return this._image=new Xi({ioConfig:{skipExtensions:["aux.xml","jgw"],skipMapInfo:!0,datasetFormat:r},url:o,customParameters:n}),this._image.when(c=>{this._updatePanConstraint(),this._createResizeHandles(c),this._map.add(c),this.state="image-loaded"},c=>{me(c)?this.state="image-load-aborted":(this.state="image-load-error",this.error=c,L.getLogger(this).error(`error occurred while loading image ${a?t:JSON.stringify(t)}`,c),this.imageSource=null)}),this._image.load(s)},this._loadWithController=()=>{this._cancelLoadWithController(),this._loadController=new AbortController,this.loadImage(this._loadController)},this._updatePanConstraint=()=>{this._panConstraint&&this.imageRenderer.constraints.customConstraints.remove(this._panConstraint),this._panConstraint=this._createPanConstraint(),this.imageRenderer.constraints.customConstraints.add(this._panConstraint)},this.addGraphic=(t,i)=>{this._overlays.graphics.add(t,i)},this.addManyGraphics=t=>{this._overlays.addMany(t)},this.clearGraphics=()=>{this._overlays.graphics.removeAll()},this.clearImage=()=>{this.image&&(this._map.layers.remove(this.image),this._image=ie(this._image))},this.loadImage=t=>{const{customParameters:i,imageSource:a}=this;return a?this._loadImageInternal(a,{customParameters:i,options:t}):wi(this.declaredClass,new xe(vi("image-viewer"),fi("ImageViewerViewModel","imageSource")))},this.removeGraphic=t=>{this._overlays.remove(t)},this.removeManyGraphics=t=>{this._overlays.removeMany(t)},this._imageRenderer=new ti({constraints:{snapToZoom:!0,rotationEnabled:!1},map:this._map,popupEnabled:!1,spatialReference:le.WebMercator,ui:{components:["zoom"]}})}initialize(){this.state="initialized",this.addHandles([A(()=>this.imageSource,e=>{e&&this.autoLoad&&this._loadWithController()},B),A(()=>{var e;return(e=this.image)==null?void 0:e.loaded},()=>{this._createImageHandles()}),A(()=>this.imageRotation,()=>{this._rotateImage()}),A(()=>this.imageRenderer.map,(e,t)=>{t==null||t.layers.remove(this._overlays),e==null||e.layers.add(this._overlays)},je),A(()=>this.imageRenderer.map.allLayers.length,e=>{e&&this.imageRenderer.map.layers.reorder(this._overlays,e-1)},B),A(()=>this.clickAction,e=>{this.removeHandles(Nt.click),e!=="none"&&this.addHandles(this.imageRenderer.on("click",t=>{var i,a;if((i=this.image)!=null&&i.loaded&&this.imageRenderer.ready)switch(e){case"emit":t.stopPropagation(),this.emit("click",t);break;case"hittest":t.stopPropagation(),t.async(async()=>{const r=await this.imageRenderer.hitTest(t.screenPoint,{include:this._overlays});this.emit("hittest-response",r)});break;case"pixel-location":{if(t.stopPropagation(),!((a=this.image)!=null&&a.serviceRasterInfo)||!t.mapPoint)return void this.emit("pixel-location",null);const{extent:r,pixelSize:o}=this.image.serviceRasterInfo,n=(t.mapPoint.x-r.xmin)*o.x,s=(r.ymax-t.mapPoint.y)*o.y,c=new $({x:n,y:s,spatialReference:r.spatialReference});this.emit("pixel-location",c);break}}}))},B)])}get brightness(){return this._get("brightness")??0}set brightness(e){this._set("brightness",Pe(e,-10,10))}get contrast(){return this._get("contrast")??0}set contrast(e){this._set("contrast",Pe(e,-10,10))}get image(){return this._image}get imagePointsInView(){var p,u,d;const{extent:e,ready:t}=this.imageRenderer,i=this.imageRotation,a=(p=this.image)==null?void 0:p.fullExtent,r=(u=this.image)==null?void 0:u.serviceRasterInfo,o=((d=this._imageRenderer.allLayerViews.find(({layer:g})=>g===this.image))==null?void 0:d.attached)===!0;if(!(t&&e&&a&&r&&o))return null;const n=Xe(se.fromExtent(e),i),s=se.fromExtent(a),c=ba(n,s),{rings:m}=c;return m.flat().map(([g,f])=>({x:(g-r.extent.xmin)*r.pixelSize.x,y:(r.extent.ymax-f)*r.pixelSize.y}))}get imageSize(){const{image:e}=this;if(!(e!=null&&e.raster))return null;const{width:t,height:i}=e.raster.rasterInfo;return[t,i]}get imageRenderer(){return this._imageRenderer}get imageView(){return this.imageRenderer.allLayerViews.find(e=>e.layer===this.image)}get sharpness(){return this._get("sharpness")??0}set sharpness(e){this._set("sharpness",Pe(e,0,1))}_rotateImage(){this.imageRenderer.constraints.rotationEnabled=!0,this.imageRenderer.rotation=this.imageRotation,this.imageRenderer.constraints.rotationEnabled=!1}sharpenImage(e,t){if(!t)return void(e.rasterFunction=null);const i=[0,-1*t,0,-1*t,4*t+1,-1*t,0,-1*t,0],a=new Ma({functionName:"Convolution",functionArguments:{type:Vt.userDefined,cols:3,rows:3,kernel:i,convolutionType:Vt.userDefined}});e.rasterFunction=a}};l([h()],G.prototype,"_image",void 0),l([h()],G.prototype,"_imageRenderer",void 0),l([h()],G.prototype,"_loadController",void 0),l([h()],G.prototype,"_overlays",void 0),l([h()],G.prototype,"_map",void 0),l([h({type:Boolean})],G.prototype,"autoLoad",void 0),l([h({type:Number})],G.prototype,"brightness",null),l([h()],G.prototype,"clickAction",void 0),l([h({type:Number})],G.prototype,"contrast",null),l([h({type:Object})],G.prototype,"customParameters",void 0),l([h({type:xe})],G.prototype,"error",void 0),l([h({readOnly:!0})],G.prototype,"image",null),l([h({readOnly:!0})],G.prototype,"imagePointsInView",null),l([h({readOnly:!0})],G.prototype,"imageSize",null),l([h({cast:Rr})],G.prototype,"imageSource",void 0),l([h({readOnly:!0})],G.prototype,"imageRenderer",null),l([h({type:Number})],G.prototype,"imageRotation",void 0),l([h()],G.prototype,"imageView",null),l([h({type:Number})],G.prototype,"sharpness",null),l([h()],G.prototype,"state",void 0),G=l([re("esri.widgets.OrientedImageryViewer.components.ImageViewerViewModel")],G);const _i=G,Nr="esri-image-viewer";let q=class extends vt{constructor(){super(...arguments),this.viewModel=new _i,this._afterContainerCreate=e=>{this.imageRenderer.container=e},this.addGraphic=(e,t)=>{this.viewModel.addGraphic(e,t)},this.addManyGraphics=e=>{this.viewModel.addManyGraphics(e)},this.clearGraphics=()=>{this.viewModel.clearGraphics()},this.clearImage=()=>{this.viewModel.clearImage()},this.loadImage=async e=>this.viewModel.loadImage(e),this.removeGraphic=e=>{this.viewModel.removeGraphic(e)},this.removeManyGraphics=e=>{this.viewModel.removeManyGraphics(e)}}get autoLoad(){return this.viewModel.autoLoad}set autoLoad(e){this.viewModel.autoLoad=e}get brightness(){return this.viewModel.brightness}set brightness(e){this.viewModel.brightness=e}get clickAction(){return this.viewModel.clickAction}set clickAction(e){this.viewModel.clickAction=e}get contrast(){return this.viewModel.contrast}set contrast(e){this.viewModel.contrast=e}get customParameters(){return this.viewModel.customParameters}set customParameters(e){this.viewModel.customParameters=e}get error(){return this.viewModel.error}get imageSize(){var t;const e=(t=this.viewModel.image)==null?void 0:t.serviceRasterInfo;return e?[e.width,e.height]:[0,0]}get imagePointsInView(){return this.viewModel.imagePointsInView}get imageRenderer(){return this.viewModel.imageRenderer}get imageRotation(){return this.viewModel.imageRotation}set imageRotation(e){this.viewModel.imageRotation=e}get imageSource(){return this.viewModel.imageSource}set imageSource(e){this.viewModel.imageSource=e}get sharpness(){return this.viewModel.sharpness}set sharpness(e){this.viewModel.sharpness=e}get state(){return this.viewModel.state}render(){return x("div",{afterCreate:this._afterContainerCreate,bind:this,class:this.classes(ft.widget,Nr)})}};l([h({type:Boolean})],q.prototype,"autoLoad",null),l([h({type:Number}),h()],q.prototype,"brightness",null),l([h()],q.prototype,"clickAction",null),l([h({type:Number})],q.prototype,"contrast",null),l([h({type:Object})],q.prototype,"customParameters",null),l([h({readOnly:!0})],q.prototype,"error",null),l([h()],q.prototype,"imageSize",null),l([h({readOnly:!0})],q.prototype,"imagePointsInView",null),l([h({readOnly:!0,type:ti})],q.prototype,"imageRenderer",null),l([h()],q.prototype,"imageRotation",null),l([h()],q.prototype,"imageSource",null),l([ni(["click","hittest-response","pixel-location"]),h({type:_i})],q.prototype,"viewModel",void 0),l([h({type:Number})],q.prototype,"sharpness",null),l([h({readOnly:!0})],q.prototype,"state",null),q=l([re("esri.widgets.OrientedImageryViewer.components.ImageViewer")],q);const Br=q,fe={click:"view-click",imageClick:"image-click",interactionHandles:"interaction-handles",footprintHandles:"footprint-handles"},Dr=new Set(["JPG","JPEG"]),Wr=/\.(\w+)$/,jr=e=>e==="FA";let M=class extends yt.EventedAccessor{constructor(e){super(e),this.additionalFeatures=new U,this.bestFeatureAngle=0,this.coverageFrustums=new U,this.coveragePolygons=new U,this.currentBestFeature=null,this.currentCoverageVisible=!0,this.determineWorkflowForFeature=()=>{Se(this._featureChangedTask),this._featureChangedTask=Ge(async t=>{const{currentBestFeature:i,selectedPoint:a,view:r}=this;if(r==null||r.closePopup(),i&&a){this._initialCurrentCoverageUpdate=!0;try{await this._updatePointsAndPolygons({signal:t}),await this._loadImage({signal:t})}catch(o){me(o)||(this.loadImageError(o),L.getLogger(this).error("#loadIImage()","error occured while loading image",o))}}})},this.disabled=!1,this.displayMessage={key:"onLoadMessage",type:"info"},this.drawFootprint=()=>{this.bestFeatureFootprint&&this.updateCurrentCoveragePolygon(this.bestFeatureFootprint)},this.features=new U,this.isAdditionalCoverageVisible=!1,this.isAdditionalPointSourcesVisible=!1,this.layer=null,this.localPort=null,this.mapImageConversionToolState=!1,this.navigatorCurrentBestFeature=null,this.pointSources=new U,this.previousFeatureAngle=0,this.selectedPoint=null,this.shouldShowSelectedImage=!1,this.updateFootprint=async(t,i)=>{var a;this.state==="image-loaded"&&await((a=this._adapter)==null?void 0:a.updateFootprint(t,i))},this.updateFootprintPanorama=async(t,i)=>{var a;await((a=this._adapter)==null?void 0:a.updateFootprintPanorama(t,i))},this._adapter=null,this.additionalFootprints=new U,this.additionalCameraLocations=new U,this.bestFeatureCurrentFootprint=null,this._fetchFeaturesController=null,this._highlightedFeatureHandle=null,this._imageViewer=new Br,this.bestFeatureFootprint=null,this._initialCurrentCoverageUpdate=!0,this._loading=!1,this._overlays=new bt({listMode:"hide",internal:!0,elevationInfo:{mode:"absolute-height"}}),this._panoramicViewer=new Er,this._referencePointOnGround=null,this._referencePointOnImage=null,this._sectorData=null,this._crossSymbol=null,this.footprintExtent=null,this._featureChangedTask=null,this._openPopupTask=null,this._suitabilities=null,this._transformController=new AbortController,this._updateFootprintTask=null,this.highlight=t=>{var a;if(!this._overlaysView)return;this.removeHighlight();const i=this.additionalFootprints.find(({attributes:{imageID:r}})=>r===Number(t));this._highlightedFeatureHandle=i?(a=this._overlaysView)==null?void 0:a.highlight(i):null},this.loadImageFromSource=async(t,i)=>{var m;const{mode:a,imageRotation:r,options:o}=i,n=typeof t=="string",s=n?t:t.url;let c=n?((m=t.match(Wr))==null?void 0:m[1])??"":t.datasetFormat;if(!c){const p=await Sr(s,{...i.options});p&&(c=p.split("/")[1]),c??(c="UNKNOWN FORMAT")}switch(a){case"default":{this._imageViewer.imageSource={datasetFormat:c.toUpperCase(),url:s};const p=new URL(s);this._imageViewer.customParameters=Object.fromEntries(p.searchParams),this._imageViewer.imageRotation=r??0,await this._imageViewer.loadImage(o);break}case"panoramic":if(this._loading=!0,Dr.has(c.toUpperCase())){const{selectedPoint:p}=this,{pitch:u,yaw:d,cameraLocation:g,viewAngle:f}=i;this._panoramicViewer.imageSource=s;let v=d??0;typeof f=="number"?v=f-v:g&&p&&(v=await za(g,p)-v),this._panoramicViewer.pitch=u??0,this._panoramicViewer.yaw=v,this._loading=!1,await this._panoramicViewer.loadImage(o)}else this.setMessage("unsupportedPanoramicImageryError","error",void 0,{datasetFormat:c});break}},this.loadImageViewer=t=>{this._imageViewer.container=t},this.loadPanoramicViewer=t=>{this._panoramicViewer.container=t},this.removeHighlight=()=>{var t;return(t=this._highlightedFeatureHandle)==null?void 0:t.remove()},this.toggleImageAttributes=()=>{Se(this._openPopupTask),this._openPopupTask=Ge(async t=>{const{currentBestFeature:i,popupEnabled:a,layer:r,view:o}=this;if(o==null||o.closePopup(),!(o&&i&&a&&r))return;const{attributes:n,geometry:s}=i,c=new ee({geometry:s,attributes:n.toJSON(),popupTemplate:r.popupTemplate});Ie(t),await o.openPopup({features:[c],location:n.location.clone()})})},this._getImageSourceFromAttachment=async(t,i,a)=>{var c;const r=new Wi({objectIds:[i]}),o=await t.queryAttachments(r,a),n=(c=o[`${i}`])==null?void 0:c[0],s=n==null?void 0:n.url;if(!s)throw new xe("NoAttachmentError","no attachments found",{[t.objectIdField]:i,layer:t});return{datasetFormat:n.contentType.split("/")[1].toUpperCase(),url:s}},this._loadImage=async t=>{const{currentBestFeature:i,layer:a,mode:r}=this;if(this.clearGraphics(),!a||!i||r==="none")return;const{attributes:o}=i,{imagePath:n,imageRotation:s,cameraHeading:c,cameraRoll:m,cameraPitch:p,objectId:u,cameraOrientation:d,location:g}=o,f=(m??0)+(s??0),v=g.spatialReference.isWGS84&&(d==null?void 0:d.type)!==4?ce(g):new $(g);let y=n;if(jr(n))try{y=await this._getImageSourceFromAttachment(a,u,t)}catch(w){return me(w)?void 0:$r(w)?(L.getLogger(this).error(w),void this.setMessage("noAttachment","error",`${a.objectIdField}: ${u}`)):(L.getLogger(this).error(w,{[a.objectIdField]:u,layer:a}),void this.setMessage("imageLoadError","error",`query-attachments-failed:${a.objectIdField} ${u}`))}try{await this.loadImageFromSource(y,{imageRotation:f,options:t,pitch:p,yaw:c,mode:r,cameraLocation:v}),Ie(t),await this.transformAndPlotSelectedLocation(t)}catch(w){me(w)||this.loadImageError(w)}},this._mapImageConversionToolViewClickHandler=t=>{t.stopPropagation(),t.preventDefault(),t.mapPoint&&this.plotMapPoint(t.mapPoint)},this._viewClickHandler=t=>{t.pointerType==="mouse"&&t.button!==0||(t.stopPropagation(),t.preventDefault(),t.mapPoint&&this.loadBestImage(t.mapPoint))},this.plotSelectedPointOnImage=async(t,i)=>{if(await Kt(i),!t)return;const a=new $({...Ct(t)?t.toJSON():t,spatialReference:le.WebMercator});if(this.mode==="default")a.x-=.5,a.y=.5-a.y,this._crossSymbol=new ee({geometry:a,symbol:Gt}),this._imageViewer.addGraphic(this._crossSymbol,0);else if(this.mode==="panoramic"){const{imageSize:r}=this._panoramicViewer;if(!r)return;const[o,n]=r,{heading:s,pitch:c}=st(t,o,n),m=lt(s,c);this._crossSymbol=new ee({geometry:new $(m,le.WebMercator),symbol:Hr}),this._panoramicViewer.addGraphic(this._crossSymbol,0)}},this.handleSectorClick=this.handleSectorClick.bind(this),this.searchBestImage=this.searchBestImage.bind(this),this.transformAndPlotReferencePointOnImage=this.transformAndPlotReferencePointOnImage.bind(this),this.updateSuitabilities=this.updateSuitabilities.bind(this),this.determineWorkflowForFeature=this.determineWorkflowForFeature.bind(this),this.selectBestFeature=this.selectBestFeature.bind(this),this.drawFootprint=this.drawFootprint.bind(this)}initialize(){this.addHandles([A(()=>this.view,async e=>{if(e){switch(this._loading=!0,e.type){case"2d":{const{default:t}=await ue(()=>import("./OrientedImageryViewerViewModelAdapter2D-C1FYagzU.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166]));this._adapter=new t(this);break}case"3d":{const{default:t}=await ue(()=>import("./OrientedImageryViewerViewModelAdapter3D-C7jLbvdO.js"),__vite__mapDeps([167,1,2,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166]));this._adapter=new t(this);break}}this._loading=!1}else this._adapter=null},B),A(()=>{var e;return(e=this.view)==null?void 0:e.map},(e,t)=>{t==null||t.layers.remove(this._overlays),e==null||e.layers.add(this._overlays)},je),A(()=>{var e,t,i;return(i=(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.allLayers)==null?void 0:i.length},e=>{var t,i;e&&((i=(t=this.view)==null?void 0:t.map)==null||i.layers.reorder(this._overlays,e-1))},je),A(()=>[this.state,this.mapImageConversionToolState,this.view],()=>{if(this.removeHandles(fe.click),this.state==="disabled"||this.view==null)return;const e=this.mapImageConversionToolState&&this.state==="image-loaded"?this._mapImageConversionToolViewClickHandler:this._viewClickHandler;this.addHandles(this.view.on("click",e,ji.WIDGET),fe.click),this.removeHandles(fe.imageClick);const{mapImageConversionToolState:t,mode:i}=this;if(t&&i!=="none")switch(i){case"default":this._imageViewer.clickAction="pixel-location",this.addHandles(this._imageViewer.on("pixel-location",async a=>{var o;this.plotReferencePointOnImage(a);const r=this.currentBestFeature;if(r){const n=(await kt([a.toJSON()],{feature:r,imageProperties:{width:this._imageViewer.imageSize[0],height:this._imageViewer.imageSize[1]},options:{signal:(o=this._transformController)==null?void 0:o.signal},footprintExtent:this.footprintExtent}))[0];n&&this.plotReferencePointOnGround(n)}}),fe.imageClick);break;case"panoramic":this._panoramicViewer.clickAction="pixel-location",this.addHandles(this._panoramicViewer.on("pixel-location",async a=>{var n;this.plotReferencePointOnImage(a);const r=this.currentBestFeature,{imageSize:o}=this._panoramicViewer;if(r&&a&&o){const s=(await kt([a],{feature:r,imageProperties:{width:o[0],height:o[1]},options:{signal:(n=this._transformController)==null?void 0:n.signal},footprintExtent:this.footprintExtent}))[0];s&&this.plotReferencePointOnGround(s)}}),fe.imageClick)}},B),A(()=>this.bestFeatureAngle,(e,t)=>{this.previousFeatureAngle=t??0},B),A(()=>this.currentBestFeature,(e,t)=>{this.determineWorkflowForFeature(e,t)},{sync:!0}),A(()=>this.mode,e=>{switch(this.removeHandles(fe.interactionHandles),e){case"default":this.addHandles(A(()=>this._imageViewer.imagePointsInView,t=>{t&&(Se(this._updateFootprintTask),this._updateFootprintTask=Ge(async i=>{await this.updateFootprint(t,{signal:i})}))},{...B,equals:(t,i)=>Rt(t,i,$t)}),fe.interactionHandles);break;case"panoramic":this.addHandles(A(()=>{const{currentBestFeature:t}=this,{imageSize:i,vfov:a,hfov:r,pitch:o,yaw:n}=this._panoramicViewer;return t&&i?[a,r,n,o]:null},t=>{if(!t||this.state==="image-loading")return;const[i,a,r,o]=t;Se(this._updateFootprintTask),this._updateFootprintTask=Ge(async n=>{await this.updateFootprintPanorama({verticalFieldOfView:i,horizontalFieldOfView:a,yaw:r,pitch:o},{signal:n})})},{...B,equals:(t,i)=>Rt(t,i,$t)}),fe.interactionHandles)}},B),A(()=>[this.brightness,this.contrast,this.sharpness],()=>{const{_imageViewer:e,brightness:t,contrast:i,mode:a,sharpness:r}=this;a==="default"&&(e.brightness=t,e.contrast=i,e.sharpness=r)},B)])}destroy(){var e,t;this._updateFootprintTask=Se(this._updateFootprintTask),this._cancelFetchingFeatures(),this.coverageFrustums.destroy(),this.coveragePolygons.destroy(),this.pointSources.destroy(),this.additionalFootprints.destroy(),this.additionalCameraLocations.destroy(),this.bestFeatureFootprint=ie(this.bestFeatureFootprint),this.bestFeatureCurrentFootprint=ie(this.bestFeatureCurrentFootprint),this._crossSymbol=ie(this._crossSymbol),this._referencePointOnGround=ie(this._referencePointOnGround),this._referencePointOnImage=ie(this._referencePointOnImage),this._overlays&&((t=(e=this.view)==null?void 0:e.map)==null||t.remove(this._overlays)),this._overlays.destroy()}get activeLayer(){return _e(L.getLogger(this),"activeLayer",{replacement:"layer"}),this.layer}set activeLayer(e){_e(L.getLogger(this),"activeLayer",{replacement:"layer"}),this.layer=e}get activeViewer(){const{_imageViewer:e,_panoramicViewer:t,mode:i}=this;switch(i){case"default":return e;case"panoramic":return t;default:return null}}get brightness(){return this._get("brightness")??0}set brightness(e){this._set("brightness",e>10?10:e<-10?-10:e)}get contrast(){return this._get("contrast")??0}set contrast(e){this._set("contrast",Pe(e,-10,10))}get featureCount(){var e;return((e=this.features)==null?void 0:e.length)??0}get imageGalleryEnabled(){var e;return Lt((e=this.currentBestFeature)==null?void 0:e.attributes.imagePath.trim())}get imageLoaded(){return _e(L.getLogger(this),"imageLoaded",{replacement:'Use OrientedImageryViewer.state === "image-loaded"',version:"4.29",warnOnce:!0}),this.state==="image-loaded"}get imagePointsInView(){const{mode:e,_imageViewer:t}=this;return e==="default"?t.imagePointsInView:null}get mode(){var a;const e=(a=this.currentBestFeature)==null?void 0:a.attributes;if(!e)return"none";const{horizontalFieldOfView:t,isSpherical:i}=e;return t===360||i?"panoramic":"default"}get popupEnabled(){return this.layer!==null&&this.layer.popupEnabled}get referencePoint(){var e;return(e=this._referencePointOnGround)==null?void 0:e.geometry}get sectorData(){const{_sectorData:e}=this;return e?it.map(t=>e[t]):null}get sharpness(){return this._get("sharpness")??0}set sharpness(e){this._set("sharpness",Pe(e,0,1))}get state(){const{mode:e,disabled:t}=this;if(t)return"disabled";if(this._loading)return"image-loading";switch(e){case"default":return this._imageViewer.state;case"panoramic":return this._panoramicViewer.state}return"ready"}get thumbnails(){const{features:e}=this;return e?new U(e.map(({attributes:{imagePath:t,objectId:i,cameraRoll:a,imageRotation:r}})=>{const o=t.trim();return Lt(o)?{url:o,objectId:i,rotation:(a??0)+(r??0)}:null}).filter(qi)):null}set view(e){this._set("view",e)}get _overlaysView(){var e;return(e=this.view)==null?void 0:e.layerViews.find(({layer:t})=>t===this._overlays)}filterByFootprints(e,t){const i=[],a=[],r=[];return e.forEach(o=>{const{layer:{coveragePercent:n},attributes:s}=o;let c;const{polygon:m,frustum:p}=hi(s);if(c=m.clone(),s.isInspection&&(c=er(s)),n&&(c=tr(c,n)),Ka(c,t)){r.push(o);const{cameraHeading:u,geometry:d,objectId:g,cameraHeight:f}=s,v=d.clone();v.z=f,v.imageID=g,this.pointSources.push(v),u!==-999&&(i.push(m),p&&a.push(p))}}),{features:r,polygons:i,frustums:a}}getCurrentCoveragePolygon(){return this.bestFeatureCurrentFootprint}getCurrentBestFeaturePolygon(){return this.bestFeatureFootprint}handleSectorClick(e){var i;if(isNaN(e))return;const t=(i=this._sectorData)==null?void 0:i[it[e]];t!=null&&t.length&&this._updateCurrentBestFeature(t.at(0))}handleFeatureClick(e){var r;const{sector:t,featureIndexInSector:i}=e;if(isNaN(i))return;const a=(r=this._sectorData)==null?void 0:r[t];a!=null&&a.length&&this._updateCurrentBestFeature(a.at(i))}async loadBestImage(e){var t,i;this._loading=!0,(t=this.view)==null||t.closePopup(),this.displayMessage=null,this.selectedPoint=e.spatialReference.isGeographic?ce(e):e.clone(),this.features.removeAll(),this.currentBestFeature=null,this.additionalFeatures.removeAll(),this.additionalFootprints.removeAll(),this.additionalCameraLocations.removeAll(),this.bestFeatureCurrentFootprint=ie(this.bestFeatureCurrentFootprint),(i=this._overlays)==null||i.removeAll(),await this._fetchFeaturesWithController(e)}loadImageError(e){L.getLogger(this).error("oriented-imagery-viewer:load-image",e),this.setMessage("imageLoadError","error",e.message)}async plotMapPoint(e){var t;return this.plotReferencePoint(e),this.transformAndPlotReferencePointOnImage({feature:this.currentBestFeature,selectedLocation:e,options:{signal:(t=this._transformController)==null?void 0:t.signal}})}plotReferencePointOnGround(e){var t,i,a;this._referencePointOnGround&&((t=this._overlays)==null||t.remove(this._referencePointOnGround),this._referencePointOnGround.destroy()),e!=null&&(this._referencePointOnGround=new ee({geometry:new $({...e.toJSON()}),symbol:Ht}),this.view?(i=this._overlays)==null||i.add(this._referencePointOnGround):this.emit("plot-ground-point",{data:{point:(a=this._referencePointOnGround)==null?void 0:a.geometry}}))}plotReferencePointOnImage(e){if(this.state==="image-loaded")switch(this._referencePointOnImage&&(this._imageViewer.removeGraphic(this._referencePointOnImage),this._panoramicViewer.removeGraphic(this._referencePointOnImage),this._referencePointOnImage.destroy()),this.mode){case"default":{const t=Ct(e)?e.toJSON():e;t.x-=.5,t.y=.5-t.y,this._referencePointOnImage=new ee({geometry:new $({spatialReference:this._imageViewer.imageRenderer.spatialReference,...t}),symbol:Ht}),this._imageViewer.addGraphic(this._referencePointOnImage,0);break}case"panoramic":{const{imageSize:t}=this._panoramicViewer;if(!t)return;const[i,a]=t,{heading:r,pitch:o}=st(e,i,a),n=lt(r,o);this._referencePointOnImage=new ee({geometry:new $(n,le.WebMercator),symbol:Gr}),this._panoramicViewer.addGraphic(this._referencePointOnImage,0);break}}}resetImage(){switch(this.setMessage("onLoadMessage","info"),this.mode){case"default":this._imageViewer.clearImage(),this._imageViewer.clearGraphics();break;case"panoramic":this._panoramicViewer.clearGraphics()}this._cancelFetchingFeatures()}async searchBestImage(e,t){try{const i=await Na(e,t);i&&await this._processFeatureResponse(i,e.point,{signal:t==null?void 0:t.signal})}catch(i){me(i)||(this.setMessage("imageLoadError","error",i.message),L.getLogger(this).error("error occurred while finding best image",i))}}selectBestFeature(e){var t;this.currentBestFeature=(t=this.features)==null?void 0:t.find(({attributes:i})=>i.objectId===Number(e))}setAdditionalCameraLocationsVisibility(e){this.additionalCameraLocations.forEach(t=>{t.visible=e})}setAdditionalCoverageVisibility(e){this.additionalFootprints.forEach(t=>{t.visible=e})}setCurrentCoverageVisibility(e){this.bestFeatureCurrentFootprint&&(this.bestFeatureCurrentFootprint.visible=e),this.currentBestFeatureLocation&&(this.currentBestFeatureLocation.visible=e)}setMapImageConversionToolState(e){this.mapImageConversionToolState=e}async transformAndPlotReferencePointOnImage(e){var s;const{selectedLocation:t,options:i}=e,a=(s=this.bestFeatureFootprint)==null?void 0:s.geometry,r=Zi(a)&&a.contains(t),o=(a==null?void 0:a.type)==="mesh"&&(a==null?void 0:a.extent.contains(t));if(!r&&!o)return;const n=await this.transformPoint(t,i);return n?(this.plotReferencePointOnImage(n),{x:n.x,y:n.y}):void 0}updateSuitabilities(e){this._suitabilities=e.sort((i,a)=>i.suitability-a.suitability);const t=this._suitabilities.map(i=>i.feature);this._updateFeatures(t),this._groupFeaturesBySectors(),this._initialCurrentCoverageUpdate=!0}_cancelFetchingFeatures(e){const t=this._fetchFeaturesController;t&&t.abort(e),this._fetchFeaturesController=null}async _fetchFeatures(e,t){if(!this.view)return;const i=this.layer;if(i){const a={include:i},r=this.view.toScreen(e);if(!r)return;const o=await this.view.hitTest(r,a);this._processHitTestResults(i,o,t)}}async _fetchFeaturesWithController(e){this._cancelFetchingFeatures();const t=new AbortController,{signal:i}=t;this._fetchFeaturesController=t;try{await this._fetchFeatures(e,{signal:i}).finally(()=>{this._fetchFeaturesController=null})}catch(a){this.setMessage("imageLoadError","error"),L.getLogger(this).error("error occurred while fetching features",a)}}_groupFeaturesBySectors(){const{_suitabilities:e,additionalFeatures:t,currentBestFeature:i,features:a}=this;if(!(e&&t&&i&&a))return void(this._sectorData=null);this._sectorData={};for(const s of it)this._sectorData[s]=new U;const r=e.map((s,c)=>({...s,featureIndex:c}));r.sort((s,c)=>s.trueSuitability-c.trueSuitability);const o=r.map(({distance:s})=>s),n=Math.max(...o);r.forEach(s=>{var S,C;const{distance:c,angle:m,featureIndex:p}=s,u=c/n*E[2],d=Pr(c,n),g=Ir(m);if(!this._sectorData)return;const f=E[3]+u*Math.sin(m*Math.PI/180),v=E[3]+u*Math.cos(m*Math.PI/180);let y;const w=a.at(p),b=w===this.currentBestFeature,_=((S=this.currentBestFeature)==null?void 0:S.attributes.cameraPitch)&&((C=this.currentBestFeature)==null?void 0:C.attributes.cameraPitch)<5;if(b&&_)y=-90;else{const T=f-E[3],O=v-E[3],W=O/Math.sqrt(T**2+O**2);let K=180*Math.acos(W)/Math.PI;(T<0&&O<0||T<0&&O>0)&&(K*=-1),y=K}const F=d===""?g:`${d}_${g}`;b&&(y===this.bestFeatureAngle?this.previousFeatureAngle=y:this.bestFeatureAngle=y,this.navigatorCurrentBestFeature=_?null:{x:f,y:v,direction:g});const I=this._sectorData[F];I.add({angle:m,featureIndex:p,x:f,y:v,objectID:w.attributes.objectId,sector:F,featureIndexInSector:I.length})})}async _processFeatureResponse(e,t,i){var d;const{features:a}=e;if(!(a!=null&&a.length))return this.setMessage("noImageError","error"),void(this.currentBestFeature=null);this.coveragePolygons.removeAll(),this.coverageFrustums.removeAll(),this.pointSources.removeAll();const{features:r,polygons:o,frustums:n}=this.filterByFootprints(a,t);if(!r.length)return this.setMessage("noImageError","error"),void(this.currentBestFeature=null);this.coveragePolygons.addMany(o),this.coverageFrustums.addMany(n);const s=new se({spatialReference:o[0].spatialReference});for(const{rings:g}of o)s.addRing(g[0]);const c=[];for(const{geometry:g}of r)s.contains(g)||c.push(g);s.addRing(c);const m=s.extent;let p;if(zr(m,2),this.footprintExtent=m,(d=this.view)==null?void 0:d.supportsGround)try{p=await this.view.map.ground.createElevationSampler(m,i)}catch(g){me(g)||L.getLogger(this).error(g)}if(r[0].elevationSample=p,(p||r[0].attributes.elevationSource)&&m){const g=await Ae([t],{feature:r[0],footprintExtent:m,options:i});if(g[0]){const f=g[0];t.elevation=f.z}}r[0].elevationSample&&r.forEach(g=>{g.elevationSample=r[0].elevationSample}),this._suitabilities=Wa({features:r,selectedPoint:t,camera:xr(this.view)?this.view.camera:null,currentImage:this.currentBestFeature}),this.updateSuitabilities(this._suitabilities);const u=this._suitabilities.map(g=>g.feature);this.currentBestFeature=u[0],this._loading=!1}async _processHitTestResults(e,t,i){var c;const{screenPoint:a,results:[r]}=t,o=(r==null?void 0:r.type)==="graphic"&&this.shouldShowSelectedImage,n=(r==null?void 0:r.mapPoint)??((c=this.view)==null?void 0:c.toMap(a));if(!n)return;const s={layerInstanceOrURL:e,point:n,queryParams:{where:e.definitionExpression??"1=1",maximumDistance:e.maximumDistance,objectIds:o?[r.graphic.getAttribute(e.objectIdField)]:void 0}};await this.searchBestImage(s,i)}_updateFeatures(e){if(!e.length)return this.currentBestFeature=null,void this.additionalFeatures.removeAll();this.features.removeAll(),this.features.addMany(e),this.currentBestFeature=e[0],e.length>1?this.additionalFeatures.addMany(e.slice(1)):this.additionalFeatures.removeAll()}async _updatePointsAndPolygons(e){var o;const{pointSources:t,currentBestFeature:i,currentCoverageVisible:a,isAdditionalPointSourcesVisible:r}=this;if(i){this.additionalFootprints.removeAll(),this.additionalCameraLocations.removeAll(),this.bestFeatureCurrentFootprint&&(this.bestFeatureCurrentFootprint.destroy(),this.bestFeatureCurrentFootprint=null,this.bestFeatureFootprint=null),await((o=this._adapter)==null?void 0:o.createFootprints(e)),Ie(e);for(const n of t)n.imageID===i.attributes.objectId?this.currentBestFeatureLocation=new ee({attributes:{imageID:n.imageID},geometry:n,symbol:kr,visible:a}):this.additionalCameraLocations.push(new ee({attributes:{imageID:n.imageID},geometry:n,symbol:Lr,visible:r}))}}_updateCurrentBestFeature(e){var a,r,o;if(!e)return;this.currentBestFeature=(a=this.features)==null?void 0:a.at(e.featureIndex);const t=((r=this.currentBestFeature)==null?void 0:r.attributes.cameraPitch)&&((o=this.currentBestFeature)==null?void 0:o.attributes.cameraPitch)<5;let i;if(t)i=-90;else{const n=e.x-E[3],s=e.y-E[3],c=s/Math.sqrt(n**2+s**2);let m=180*Math.acos(c)/Math.PI;(n<0&&s<0||n<0&&s>0)&&(m*=-1),i=m}i===this.bestFeatureAngle?this.previousFeatureAngle=i:this.bestFeatureAngle=i,this.navigatorCurrentBestFeature=t?null:{x:e.x,y:e.y,direction:e.sector.includes("_")?e.sector.split("_")[1]:e.sector}}clearGraphics(){this._imageViewer.clearGraphics(),this._panoramicViewer.clearGraphics()}plotReferencePoint(e){"mapPoint"in e?this.plotReferencePointOnGround(e.mapPoint):this.plotReferencePointOnGround(e)}setMessage(e,t,i,a){this._loading=!1,this.displayMessage={key:e,type:t,data:i,map:a}}async transformAndPlotSelectedLocation(e){const{currentBestFeature:t,selectedPoint:i,state:a}=this;if(this._crossSymbol&&(this._panoramicViewer.removeGraphic(this._crossSymbol),this._imageViewer.removeGraphic(this._crossSymbol),this._crossSymbol=ie(this._crossSymbol)),!i||!t||a!=="image-loaded")return;let r;try{r=await this.transformPoint(i,e),Ie(e),await this.plotSelectedPointOnImage(r,e)}catch(o){me(o)||L.getLogger(this).error("failed to transform map point to pixel, cross symbol will not be plotted on image",{error:o,selectedPoint:i,feature:t})}}async transformPoint(e,t){var r,o,n;if(this.mode==="none")return;const i=this.currentBestFeature,a=await $e([e],{feature:i,imageProperties:this.mode==="default"?this._imageViewer.viewModel.image.serviceRasterInfo:{width:(r=this._panoramicViewer.imageSize)==null?void 0:r[0],height:(o=this._panoramicViewer.imageSize)==null?void 0:o[1]},options:t},((n=this.view)==null?void 0:n.type)==="3d");if(a.length)return a[0]}updateCurrentCoveragePolygon(e){var u,d,g;const{additionalFootprints:t,additionalCameraLocations:i,currentBestFeature:a,currentBestFeatureLocation:r,currentCoverageVisible:o,selectedPoint:n,view:s,_adapter:c}=this,{attributes:{objectId:m},elevationSample:p}=a;if(this._initialCurrentCoverageUpdate){if((u=this._overlays)==null||u.removeAll(),this._initialCurrentCoverageUpdate=!1,this.bestFeatureCurrentFootprint=ie(this.bestFeatureCurrentFootprint),e&&(e.visible=o,this.bestFeatureCurrentFootprint=e),s){const f=[...t,...i,this.bestFeatureCurrentFootprint,r].filter(Fr);s.supportsGround&&p&&(c!=null&&c.updateGroundElevation)&&c.updateGroundElevation(f,p),n&&f.push(new ee({geometry:n.clone(),symbol:Gt.clone(),attributes:{imageID:m}})),this._overlays.graphics.addMany(f)}}else if(s){this.bestFeatureCurrentFootprint&&((d=this._overlays)==null||d.remove(this.bestFeatureCurrentFootprint),this.bestFeatureCurrentFootprint=ie(this.bestFeatureCurrentFootprint));const f=this.bestFeatureCurrentFootprint&&this._overlays?this._overlays.graphics.indexOf(this.bestFeatureCurrentFootprint):-1;e&&(this.bestFeatureCurrentFootprint=e,s!=null&&s.supportsGround&&p&&(c!=null&&c.updateGroundElevation)&&c.updateGroundElevation([e],p),e.visible=this.currentCoverageVisible,(g=this._overlays)==null||g.graphics.add(this.bestFeatureCurrentFootprint,f>=0?f:this._overlays.graphics.length-1))}}};l([h()],M.prototype,"activeLayer",null),l([h({readOnly:!0})],M.prototype,"activeViewer",null),l([h()],M.prototype,"additionalFeatures",void 0),l([h()],M.prototype,"bestFeatureAngle",void 0),l([h({type:Number})],M.prototype,"brightness",null),l([h({type:Number})],M.prototype,"contrast",null),l([h()],M.prototype,"coverageFrustums",void 0),l([h()],M.prototype,"coveragePolygons",void 0),l([h()],M.prototype,"currentBestFeature",void 0),l([h()],M.prototype,"currentCoverageVisible",void 0),l([h({json:{write:!1}})],M.prototype,"determineWorkflowForFeature",void 0),l([h()],M.prototype,"disabled",void 0),l([h()],M.prototype,"displayMessage",void 0),l([h()],M.prototype,"drawFootprint",void 0),l([h({readOnly:!0})],M.prototype,"featureCount",null),l([h()],M.prototype,"features",void 0),l([h({readOnly:!0})],M.prototype,"imageGalleryEnabled",null),l([h({readOnly:!0})],M.prototype,"imageLoaded",null),l([h()],M.prototype,"imagePointsInView",null),l([h()],M.prototype,"isAdditionalCoverageVisible",void 0),l([h()],M.prototype,"isAdditionalPointSourcesVisible",void 0),l([h()],M.prototype,"layer",void 0),l([h({type:Number})],M.prototype,"localPort",void 0),l([h()],M.prototype,"mapImageConversionToolState",void 0),l([h({readOnly:!0,value:"none"})],M.prototype,"mode",null),l([h()],M.prototype,"navigatorCurrentBestFeature",void 0),l([h()],M.prototype,"pointSources",void 0),l([h({readOnly:!0})],M.prototype,"popupEnabled",null),l([h()],M.prototype,"previousFeatureAngle",void 0),l([h()],M.prototype,"referencePoint",null),l([h({readOnly:!0})],M.prototype,"sectorData",null),l([h()],M.prototype,"selectedPoint",void 0),l([h({type:Number})],M.prototype,"sharpness",null),l([h()],M.prototype,"shouldShowSelectedImage",void 0),l([h({readOnly:!0})],M.prototype,"state",null),l([h({readOnly:!0})],M.prototype,"thumbnails",null),l([h()],M.prototype,"updateFootprint",void 0),l([h()],M.prototype,"updateFootprintPanorama",void 0),l([h({value:null})],M.prototype,"view",null),l([h()],M.prototype,"_adapter",void 0),l([h({type:U.ofType(ee)})],M.prototype,"additionalFootprints",void 0),l([h({type:U.ofType(ee)})],M.prototype,"additionalCameraLocations",void 0),l([h()],M.prototype,"bestFeatureCurrentFootprint",void 0),l([h()],M.prototype,"_fetchFeaturesController",void 0),l([h()],M.prototype,"_highlightedFeatureHandle",void 0),l([h()],M.prototype,"_imageViewer",void 0),l([h({type:ee})],M.prototype,"bestFeatureFootprint",void 0),l([h()],M.prototype,"_initialCurrentCoverageUpdate",void 0),l([h()],M.prototype,"_loading",void 0),l([h()],M.prototype,"_overlays",void 0),l([h({readOnly:!0})],M.prototype,"_overlaysView",null),l([h()],M.prototype,"_panoramicViewer",void 0),l([h()],M.prototype,"_referencePointOnGround",void 0),l([h()],M.prototype,"_referencePointOnImage",void 0),l([h()],M.prototype,"currentBestFeatureLocation",void 0),l([h()],M.prototype,"_sectorData",void 0),l([h()],M.prototype,"footprintExtent",void 0),M=l([re("esri.widgets.OrientedImageryViewer.OrientedImageryViewerViewModel")],M);const Mi=M;let te=class extends Ui{constructor(){super(...arguments),this.closeButton=!0,this.coverageMenu=!0,this.imageEnhancement=!0,this.imageGallery=!0,this.mapImageConversionTool=!0,this.navigationTool=!0,this.title=!0,this.viewerTools=!0,this.showPopupsAction=!0}};l([h({type:Boolean,nonNullable:!0})],te.prototype,"closeButton",void 0),l([h({type:Boolean,nonNullable:!0})],te.prototype,"coverageMenu",void 0),l([h({type:Boolean,nonNullable:!0})],te.prototype,"imageEnhancement",void 0),l([h({type:Boolean,nonNullable:!0})],te.prototype,"imageGallery",void 0),l([h({type:Boolean,nonNullable:!0})],te.prototype,"mapImageConversionTool",void 0),l([h({type:Boolean,nonNullable:!0})],te.prototype,"navigationTool",void 0),l([h({type:Boolean,nonNullable:!0})],te.prototype,"title",void 0),l([h({type:Boolean,nonNullable:!0})],te.prototype,"viewerTools",void 0),l([h({type:Boolean,nonNullable:!0})],te.prototype,"showPopupsAction",void 0),te=l([re("esri.widgets.OrientedImageryViewer.OrientedImageryViewerVisibleElements")],te);const xi=te;let V=class extends vt{constructor(e,t){super(e,t),this.dockEnabled=!1,this.galleryOpened=!1,this.imageEnhancementToolActive=!1,this.navigationToolActive=!1,this.viewModel=new Mi,this.messagesCommon=null,this.visibleElements=new xi,this._navigationToolExpanded=!1,this._navigationTool=null,this._actionItems=new Map,this._galleryController=new AbortController,this._galleryObserver=new IntersectionObserver(this._lazyLoadImage.bind(this)),this._highlight=i=>{var r;const a=(r=i.target)==null?void 0:r.dataset.objectid;a&&this.viewModel.highlight(a)},this._removeHighlight=()=>this.viewModel.removeHighlight(),this._scaleNavigationTool=()=>{this._navigationToolExpanded=!this._navigationToolExpanded},this._toogleImageAttributes=()=>{this.viewModel.toggleImageAttributes()},this._loadImageFromGallery=this._loadImageFromGallery.bind(this),this._registerGalleryItem=this._registerGalleryItem.bind(this),this._unregisterGalleryItem=this._unregisterGalleryItem.bind(this),this._renderViewerContainer=this._renderViewerContainer.bind(this),this.loadImageFromSource=this.loadImageFromSource.bind(this),this.updateSuitabilities=this.updateSuitabilities.bind(this)}initialize(){this.addHandles([A(()=>{var e;return[(e=this.viewModel)==null?void 0:e.bestFeatureAngle,this._navigationTool]},([e,t])=>{t&&this._updateNavigationTool(t)},je),A(()=>this.currentCoverageVisible,e=>this._onCurrentCoverageVisibilityChange(e)),A(()=>this.isAdditionalCoverageVisible,e=>this._onAdditionalCoverageVisibilityChange(e)),A(()=>this.isAdditionalPointSourcesVisible,e=>this._onAdditionalCameraLocationsVisibility(e))])}loadDependencies(){return Qi({tooltip:()=>ue(()=>import("./calcite-tooltip-BAYP_umi.js"),__vite__mapDeps([168,1,2,169,170,171,172,173])),action:()=>ue(()=>import("./calcite-action-nUAFESCb.js"),__vite__mapDeps([174,175,1,2,169,176,177,178,179,180,181,182,183,184])),"action-group":()=>ue(()=>import("./calcite-action-group-DzEPgAgY.js"),__vite__mapDeps([185,186,1,2,187,180,177,178,169,179,182,188,189,175,176,181,183,184,190,170,171,191,172,192,173])),"action-bar":()=>ue(()=>import("./calcite-action-bar-CKGzllii.js"),__vite__mapDeps([193,1,2,187,180,169,177,178,179,182,194,186,188,189,175,176,181,183,184,190,170,171,191,172,192,173])),label:()=>ue(()=>import("./calcite-label-D36Vj_AH.js"),__vite__mapDeps([195,1,2,196,169,181])),panel:()=>ue(()=>import("./calcite-panel-BRPngiDd.js"),__vite__mapDeps([197,198,1,2,169,176,177,180,188,189,179,175,178,181,182,183,184,190,170,171,191,172,192,173,199])),slider:()=>ue(()=>import("./calcite-slider-CmePdydA.js"),__vite__mapDeps([200,1,2,169,201,176,179,196,181,177,178,180,202]))})}destroy(){this._galleryController.abort(),this._galleryObserver.disconnect()}get activeLayer(){return _e(L.getLogger(this),"activeLayer",{replacement:"layer"}),this.layer}set activeLayer(e){_e(L.getLogger(this),"activeLayer",{replacement:"layer"}),this.layer=e}get currentBestFeature(){return this.viewModel.currentBestFeature}set currentBestFeature(e){this.viewModel.currentBestFeature=e}get currentCoverageVisible(){return this.viewModel.currentCoverageVisible}set currentCoverageVisible(e){this.viewModel.currentCoverageVisible=e}get disabled(){return this.viewModel.disabled}set disabled(e){this.viewModel.disabled=e}get displayMessage(){return this.viewModel.displayMessage}set drawFootprint(e){this.viewModel.drawFootprint=e}get drawFootprint(){return this.viewModel.drawFootprint}get features(){return this.viewModel.features}get imagePointsInView(){return this.viewModel.imagePointsInView}get isDocked(){return _e(L.getLogger(this),"isDocked",{replacement:"dockEnabled"}),this.dockEnabled}set isDocked(e){_e(L.getLogger(this),"isDocked",{replacement:"dockEnabled"}),this.dockEnabled=e}get icon(){return"oriented-imagery-widget"}set icon(e){this._overrideIfSome("icon",e)}get imageGalleryEnabled(){return this.viewModel.imageGalleryEnabled}get isAdditionalCoverageVisible(){return this.viewModel.isAdditionalCoverageVisible}set isAdditionalCoverageVisible(e){this.viewModel.isAdditionalCoverageVisible=e}get isAdditionalPointSourcesVisible(){return this.viewModel.isAdditionalPointSourcesVisible}set isAdditionalPointSourcesVisible(e){this.viewModel.isAdditionalPointSourcesVisible=e}get mapImageConversionToolState(){return this.viewModel.mapImageConversionToolState}set mapImageConversionToolState(e){this.viewModel.mapImageConversionToolState=e}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get popupEnabled(){const{popupEnabled:e,state:t}=this.viewModel;return t==="image-loaded"&&e}get referencePoint(){return this.viewModel.referencePoint??null}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}set determineWorkflowForFeature(e){this.viewModel.determineWorkflowForFeature=e}get determineWorkflowForFeature(){return this.viewModel.determineWorkflowForFeature}set updateFootprint(e){this.viewModel.updateFootprint=e}get updateFootprint(){return this.viewModel.updateFootprint}async _getThumbnailPixelBlockInternal(e,t){const{level:i,offset:a,size:r}=this._getMaxLevelRasterParameters(e);try{const{pixelBlock:o}=await e.fetchRawPixels(i,a,r,t);return o}catch(o){L.getLogger(this).warn("failed to create canvas with pixel data",o)}return null}_getMaxLevelRasterParameters(e){const{storageInfo:t,width:i,height:a}=e.rasterInfo,{maximumPyramidLevel:r,pyramidScalingFactor:o}=t,n=o??2;return{level:r,offset:{x:0,y:0},size:{width:Math.ceil(i/n**r),height:Math.ceil(a/n**r)}}}async _getThumbnailPixelBlock(e){const{signal:t}=this._galleryController;try{const i=await Yi.open({url:e,signal:t});return i?await this._getThumbnailPixelBlockInternal(i,{signal:t}):null}catch(i){L.getLogger(this).error("failed to create thumbnail",i)}return null}_handleBrightnessChange(e){this.viewModel.brightness=e.target.value??0}_handleContrastChange(e){this.viewModel.contrast=e.target.value??0}_handleSharpnessChange(e){this.viewModel.sharpness=e.target.value??0}_lazyLoadImage(e,t){e.forEach(async i=>{if(i.isIntersecting){const a=i.target,r=a.getAttribute("data-src"),o=a.getAttribute("data-rotation"),n=o?parseFloat(o)%360:null;if(!r)return;const s=await this._getThumbnailPixelBlock(r);if(!s)return;a.width=s.width,a.height=s.height;const c=a.getContext("2d");if(!c)return;const m=c.createImageData(a.width,a.height);if(m.data.set(s.getAsRGBA()),typeof n=="number"&&n!==0){const p=ae(n),u=document.createElement("canvas"),d=u.getContext("2d");if(d){u.width=m.width,u.height=m.height,d.putImageData(m,0,0);const g=Ne(0,0,p),f=Ne(m.width,0,p),v=Ne(m.width,m.height,p),y=Ne(0,m.height,p),w=Math.max(g[0],f[0],v[0],y[0])-Math.min(g[0],f[0],v[0],y[0]),b=Math.max(g[1],f[1],v[1],y[1])-Math.min(g[1],f[1],v[1],y[1]),_=Math.min(a.width/w,a.height/b);return c.save(),c.clearRect(0,0,a.width,a.height),c.translate(a.width/2,a.height/2),c.rotate(p),c.scale(_,_),c.drawImage(u,-m.width/2,-m.height/2,m.width,m.height),c.restore(),t.unobserve(a)}L.getLogger(this).warn("oriented-imagery-viewer:image-gallery","failed to apply rotation on thumbnail")}c.putImageData(m,0,0),t.unobserve(a)}})}_loadImageFromGallery(e){var a;const{target:t}=e;if(!t)return;const i=t.getAttribute("data-objectid");i&&((a=this.viewModel.currentBestFeature)==null?void 0:a.attributes.objectId)!==Number(i)&&this.viewModel.selectBestFeature(i)}_onAdditionalCoverageVisibilityChange(e){this.viewModel.setAdditionalCoverageVisibility(e)}_onAdditionalCameraLocationsVisibility(e){this.viewModel.setAdditionalCameraLocationsVisibility(e)}_onCurrentCoverageVisibilityChange(e){this.viewModel.setCurrentCoverageVisibility(e)}_registerGalleryItem(e){this._galleryObserver.observe(e)}_renderActionTooltips(){return[...this._actionItems].map(([e,t])=>x("calcite-tooltip",{key:e,referenceElement:t},x("span",null,e)))}_renderBody(){return x("div",{class:P.body},this._renderViewerContainer(),this._renderImageGallery(),this._renderImageEnhancementTools(),this._renderNavigation())}_renderImageEnhancementTools(){const{imageEnhancementToolActive:e,viewModel:{brightness:t,contrast:i,sharpness:a}}=this;return e&&x("calcite-panel",{bind:this,class:P.imageEnhancementWrapper,closable:!0,closed:!e,heading:this.messages.imageEnhancement,key:this.messages.imageEnhancement,onCalcitePanelClose:this._toggleImageEnhancementToolState},x("div",{class:P.imageEnhancementTools},x("div",{class:P.imageEnhancementToolContainer},x("calcite-label",null,this.messages.brightness,x("calcite-slider",{bind:this,labelTicks:!0,max:10,min:-10,ticks:5,value:t,onCalciteSliderInput:this._handleBrightnessChange}))),x("div",{class:P.imageEnhancementToolContainer},x("calcite-label",null,this.messages.contrast,x("calcite-slider",{bind:this,labelTicks:!0,max:10,min:-10,ticks:5,value:i,onCalciteSliderInput:this._handleContrastChange}))),x("div",{class:P.imageEnhancementToolContainer},x("calcite-label",null,this.messages.sharpness,x("calcite-slider",{bind:this,labelTicks:!0,max:1,min:0,step:.1,ticks:.5,value:a,onCalciteSliderInput:this._handleSharpnessChange})))),x("calcite-action",{bind:this,icon:"reset",onclick:this._resetImageTools,slot:"header-actions-end",text:this.messagesCommon.reset}))}_renderImageGallery(){const{container:e,galleryOpened:t,imageGalleryEnabled:i,viewModel:{thumbnails:a}}=this;return i&&t&&e&&a?x("calcite-panel",{bind:this,class:P.carousel,closable:!0,closed:!t,heading:this.messages.imageGallery,key:this.messages.imageGallery,onCalcitePanelClose:this._toggleImageGallery},x("div",{class:P.carouselContainer},this._renderThumbnails(a))):null}_renderMapImageConversionTool(){const{mapImageConversionToolState:e,viewModel:{state:t}}=this;return x("calcite-action",{active:e,afterCreate:this._storeActionElement,bind:this,disabled:t!=="image-loaded",icon:"image-pin",onclick:this._toggleMapImageConversionToolState,text:this.messages.mapImageConversionTool})}_renderNavigation(){const{viewModel:{sectorData:e,navigatorCurrentBestFeature:t,currentBestFeature:i,state:a}}=this;if(!this.container||!i)return null;let r,o,n,s,c;if(t){const{x:y,y:w,direction:b}=t,[_,F,I,S]=at[b];r=`M ${y} ${w} L ${_} ${F} A ${E[2]} ${E[2]} 0 0 1 ${I} ${S} Z`,o=y,s=w,n=at[b][4],c=at[b][5]}const m=y=>{var b;const w=(b=y.target.dataset)==null?void 0:b.sector;w&&this.viewModel.handleSectorClick(+w)},p=y=>{const w=y.target.dataset;if(!w)return;const{featureIndexInSector:b,sector:_}=w;b&&_&&this.viewModel.handleFeatureClick({sector:_,featureIndexInSector:+b})},u=y=>{y.removeEventListener("click",p)},d=i.attributes.objectId,g=e==null?void 0:e.map(y=>y==null?void 0:y.items).filter(Boolean).flatMap(y=>y==null?void 0:y.map(({x:w,y:b,objectID:_,featureIndexInSector:F,sector:I})=>x("circle",{afterRemoved:u,class:this.classes(P.feature,{selected:d===_}),cx:w,cy:b,"data-feature-index-in-sector":F,"data-sector":I,key:`${P.feature}-${_}`,onclick:p,r:Ea}))),f=y=>{y.removeEventListener("click",m)},v=this.classes({[P.navigationWrapper]:!0,[P.navigationZoomed]:this._navigationToolExpanded});return this.navigationToolActive&&a==="image-loaded"?x("div",{bind:this,class:v,key:this.messages.navigationTool},x("svg",{afterCreate:y=>this._storeNavigationToolReference(y),class:Ji()?J:P.rotateWithAnimation,focusable:"false",height:Tt,role:"img",width:Tt,xmlns:"http://www.w3.org/2000/svg"},x("defs",null,x("linearGradient",{gradientUnits:"userSpaceOnUse",id:`${this.id}-coverage-fill`,x1:o,x2:n,y1:s,y2:c},x("stop",{class:P.navigationPathOffset0,offset:0}),x("stop",{class:P.navigationPathOffset1,offset:1}))),x("g",null,x("circle",{class:this.classes(P.sector,P.outerSector),cx:E[3],cy:E[3],onclick:this._scaleNavigationTool,r:E[3]}),x("circle",{class:P.sector,cx:E[3],cy:E[3],r:E[2]}),x("circle",{class:P.sector,cx:E[3],cy:E[3],r:E[1]}),x("circle",{class:P.sector,cx:E[3],cy:E[3],r:E[0]}),x("path",{class:P.pointer,d:"M 56.5 6.06217782649107 L 60 0 L 63.5 6.06217782649107 Z",key:`${P.pointer}-west`}),x("path",{class:this.classes(P.pointer,P.north),d:"M 113.93782217350893 56.5 L 120 60 L 113.93782217350893 63.5 Z",key:`${P.pointer}-north`}),x("path",{class:P.pointer,d:"M 56.5 113.93782217350893 L 60 120 L 63.5 113.93782217350893 Z",key:`${P.pointer}-east`}),x("path",{class:P.pointer,d:"M 6.06217782649107 56.5 L 0 60 L 6.06217782649107 63.5 Z",key:`${P.pointer}-south`}),x("path",{class:this.classes(P.sector,P.sectorSeparator),d:"M 23.937554159486076 23.937554159486076 L 96.06244584051393 96.06244584051393 M 23.937554159486076 96.06244584051393 L 96.06244584051393 23.937554159486076",key:P.sectorSeparator}),Va([E[2],E[1],E[0]],E[3],E[3]).map((y,w)=>{var b;return x("path",{afterRemoved:f,class:this.classes(P.sector,(b=e==null?void 0:e[w])!=null&&b.length?P.sectorEnabled:P.sectorDisabled),d:y,"data-sector":`${w}`,key:`${P.sector}-${w}`,onclick:m})}),x("path",{class:this.classes(P.sector,P.sectorCross),d:"M 56.4 56.4 L 63.53 63.53 M 63.53 56.4 L 56.4 63.53",key:P.sectorCross}),g,i.attributes.cameraPitch>=5&&r?x("path",{class:P.selectedFeaturePath,d:r,fill:`url(#${this.id}-coverage-fill)`,key:P.selectedFeaturePath}):null))):null}_renderNavigationTool(){const{state:e}=this.viewModel;return x("calcite-action",{active:this.navigationToolActive,afterCreate:this._storeActionElement,bind:this,disabled:e!=="image-loaded",icon:"explore",onclick:this._toggleNavigationTool,text:this.messages.navigationTool})}_renderImageEnhancementTool(){const{state:e,mode:t}=this.viewModel;return x("calcite-action",{active:this.imageEnhancementToolActive,afterCreate:this._storeActionElement,bind:this,disabled:t!=="default"||e!=="image-loaded",icon:"sliders-horizontal",onclick:this._toggleImageEnhancementToolState,text:this.messages.imageEnhancement})}_renderMenuBarContainer(){const{currentCoverageVisible:e,isAdditionalCoverageVisible:t,isAdditionalPointSourcesVisible:i,imageGalleryEnabled:a}=this;return x("calcite-action-bar",{expandDisabled:!0,layout:"horizontal",slot:"action-bar"},x("calcite-action-group",{expanded:!0},x("calcite-action",{active:e,afterCreate:this._storeActionElement,bind:this,class:P.currentCoverage,icon:"trapezoid-area",onclick:this._toggleCurrentCoverage,text:this.messages.currentFootprint}),x("calcite-action",{active:t,afterCreate:this._storeActionElement,bind:this,class:P.addCoverage,icon:"trapezoid-area",onclick:this._toggleAdditionalCoverage,text:this.messages.additionalFootprints}),x("calcite-action",{active:i,afterCreate:this._storeActionElement,bind:this,class:P.addExpPoints,icon:"circle-area",onclick:this._toggleAdditionalCameraLocations,text:this.messages.additionalCameraLocations})),x("calcite-action-group",{layout:"horizontal"},this.visibleElements.mapImageConversionTool?this._renderMapImageConversionTool():null,this.visibleElements.navigationTool?this._renderNavigationTool():null,this.visibleElements.imageEnhancement?this._renderImageEnhancementTool():null),x("calcite-action-group",null,x("calcite-action",{active:this.galleryOpened,afterCreate:this._storeActionElement,bind:this,disabled:!a,icon:"images",onclick:this._toggleImageGallery,text:this.messages.imageGallery,textEnabled:!0}),this.visibleElements.showPopupsAction?this._renderPopupAction():null),this._renderActionTooltips())}_renderMessageBox(){const{messages:e,viewModel:{displayMessage:t}}=this;if(!t)return null;const{data:i,key:a,map:r}=t,o=`${r?Ki(e[a],r):e[a]}`;return x("span",{class:P.messageBox},i?`${o} ${i}`:o)}_renderPopupAction(){return x("calcite-action",{afterCreate:this._storeActionElement,bind:this,disabled:!this.popupEnabled,icon:"popup",onclick:this._toogleImageAttributes,text:this.messages.showPopups,textEnabled:!0})}_renderThumbnails(e){const{currentBestFeature:t}=this.viewModel;return t?x("div",{class:P.carouselContent},e.items.map(({url:i,objectId:a,rotation:r},o)=>x("div",{class:`${P.carouselItemWrapper}${t.attributes.objectId===a?"--selected":""}`,key:`${P.carouselItemWrapper}-${o}`},x("canvas",{afterCreate:this._registerGalleryItem,afterRemoved:this._unregisterGalleryItem,alt:`thumbnail-${a}`,class:P.carouselItem,"data-objectid":`${a}`,"data-rotation":`${r}`,"data-src":i,onclick:this._loadImageFromGallery,onmouseenter:this._highlight,onmouseleave:this._removeHighlight})))):null}_renderViewerContainer(){return x("div",{class:P.viewerContainer},this._renderImageViewer(),this._renderPanoramicViewer(),this._renderMessageBox())}_renderImageViewer(){const{displayMessage:e,loadImageViewer:t,mode:i}=this.viewModel,a=`${P.viewer}${e||i!=="default"?"--hide":""}`;return x("calcite-panel",{afterCreate:t,bind:this,class:a})}_renderPanoramicViewer(){const{displayMessage:e,loadPanoramicViewer:t,mode:i}=this.viewModel,a=`${P.viewer}${e||i!=="panoramic"?"--hide":""}`;return x("calcite-panel",{afterCreate:t,bind:this,class:a})}_resetImageTools(){this.viewModel.sharpness=this.viewModel.brightness=this.viewModel.contrast=0}_storeActionElement(e){this._actionItems.set(e.text,e)}_storeNavigationToolReference(e){this._navigationTool=e}_toggleAdditionalCameraLocations(){this.isAdditionalPointSourcesVisible=!this.isAdditionalPointSourcesVisible}_toggleAdditionalCoverage(){this.isAdditionalCoverageVisible=!this.isAdditionalCoverageVisible}_toggleCurrentCoverage(){this.currentCoverageVisible=!this.currentCoverageVisible}_toggleImageEnhancementToolState(e){e.stopPropagation(),this.imageEnhancementToolActive=!this.imageEnhancementToolActive,this.imageEnhancementToolActive&&(this.galleryOpened&&(this.galleryOpened=!1),this.navigationToolActive&&(this.navigationToolActive=!1))}_toggleImageGallery(e){e.stopPropagation(),this.galleryOpened=!!this.imageGalleryEnabled&&!this.galleryOpened,this.galleryOpened&&(this.imageEnhancementToolActive&&(this.imageEnhancementToolActive=!1),this.navigationToolActive&&(this.navigationToolActive=!1))}_toggleNavigationTool(){this.navigationToolActive=!this.navigationToolActive,this.navigationToolActive&&(this.galleryOpened&&(this.galleryOpened=!1),this.imageEnhancementToolActive&&(this.imageEnhancementToolActive=!1))}_toggleMapImageConversionToolState(){this.mapImageConversionToolState=!this.mapImageConversionToolState}_unregisterGalleryItem(e){this._galleryObserver.unobserve(e)}_updateNavigationTool(e){const{previousFeatureAngle:t,bestFeatureAngle:i}=this.viewModel,a=(i-t+540)%360-180;e.style.setProperty(Aa,`${t}deg`),e.style.setProperty(Ta,`${t+a}deg`)}loadBestImage(e){this.viewModel.loadBestImage(e)}loadImageFromSource(e,t){return this.viewModel.loadImageFromSource(e,t)}async plotMapPoint(e){return this.viewModel.plotMapPoint(e)}plotReferencePointOnGround(e){this.viewModel.plotReferencePointOnGround(e)}plotReferencePointOnImage(e){this.viewModel.plotReferencePointOnImage(e)}resetImage(){this.viewModel.resetImage()}render(){const{dockEnabled:e,viewModel:{state:t}}=this;return x("div",{class:this.classes(ft.widget,Z)},x("calcite-panel",{bind:this,class:e?P.dock:P.float,heading:this.visibleElements.title?this.messages.title:void 0,loading:t==="image-loading"},this.visibleElements.coverageMenu?this._renderMenuBarContainer():null,this._renderBody()))}updateSuitabilities(e){this.viewModel.updateSuitabilities(e)}};l([h()],V.prototype,"activeLayer",null),l([h()],V.prototype,"currentBestFeature",null),l([h()],V.prototype,"currentCoverageVisible",null),l([h()],V.prototype,"disabled",null),l([h()],V.prototype,"dockEnabled",void 0),l([h()],V.prototype,"drawFootprint",null),l([h()],V.prototype,"features",null),l([h()],V.prototype,"imagePointsInView",null),l([h()],V.prototype,"isDocked",null),l([h()],V.prototype,"galleryOpened",void 0),l([h()],V.prototype,"icon",null),l([h()],V.prototype,"imageEnhancementToolActive",void 0),l([h({readOnly:!0})],V.prototype,"imageGalleryEnabled",null),l([h()],V.prototype,"isAdditionalCoverageVisible",null),l([h()],V.prototype,"isAdditionalPointSourcesVisible",null),l([h()],V.prototype,"mapImageConversionToolState",null),l([h()],V.prototype,"layer",null),l([h()],V.prototype,"navigationToolActive",void 0),l([h({type:Mi})],V.prototype,"viewModel",void 0),l([h(),St("esri/widgets/OrientedImageryViewer/t9n/OrientedImageryViewer")],V.prototype,"messages",void 0),l([h(),St("esri/t9n/common")],V.prototype,"messagesCommon",void 0),l([h({readOnly:!0})],V.prototype,"popupEnabled",null),l([h()],V.prototype,"referencePoint",null),l([h()],V.prototype,"view",null),l([h({type:xi,nonNullable:!0})],V.prototype,"visibleElements",void 0),l([h()],V.prototype,"determineWorkflowForFeature",null),l([h()],V.prototype,"updateFootprint",null),l([h()],V.prototype,"_navigationToolExpanded",void 0),l([h()],V.prototype,"_navigationTool",void 0),V=l([re("esri.widgets.OrientedImageryViewer")],V);const qr=V,Io=Object.freeze(Object.defineProperty({__proto__:null,default:qr},Symbol.toStringTag,{value:"Module"}));export{kt as E,li as I,yo as L,Fo as M,mi as N,Io as O,hi as a,_o as b,Mo as c,xo as u};
