import{aY as V,kc as k,v,y as h,z as I,W as U,cX as _,ba as g,A as d,kd as w,J as f,cZ as L,kb as M,b5 as b,ke as H,bL as E,kf as P,kg as C,kh as N}from"./index-BfC8i6jT.js";import{t as T}from"./utils-Dt6qaqiQ.js";const S=(e,r)=>{for(const o of e)if(o.type==="feature"||o.type==="subtype-group"){if(!o.url)continue;const i=V(o.url).url.path,t=r.get(i);if(t)t.layers.push(o);else{const n=new k({url:i}),s=[o];r.set(i,{featureService:n,layers:s})}}else o.type==="group"&&S(o.layers,r)};function $(e){const r=new Map;return S(e,r),r}let u=class extends U{constructor(e){super(e),this._portalLookup=new Map,this._updatingHandlesLoad=new _,this._updatingHandlesExecute=new _,this.advancedEditingUserTypeExtensionLookup=new Map,this.executionError=void 0,this.featureServiceLookup=new Map,this.loadError=void 0,this.serverVersionLookup=new Map,this.serviceNameLookup=new Map,this.userLookup=new Map,this.versionIdentifierLookup=new Map,this.versionInfoLookup=new Map,this.versionManagementServiceLookup=new Map,this.versioningStateLookup=new Map,this.view=null,this.versioningStates=null}initialize(){this._viewChangeHandle(),this.addHandles([g(()=>this.view,()=>{this._resetAllLookupProperties(),this._viewChangeHandle()}),g(()=>this.versioningStates,()=>{this._resetVersioningLookupProperties(),this._setVersioningStatesLookups()})])}destroy(){this._updatingHandlesLoad.destroy(),this._updatingHandlesExecute.destroy()}get state(){return this._updatingHandlesLoad.updating?"loading":this.loadError?"disabled":this._updatingHandlesExecute.updating?"executing":this.executionError?"failed":"ready"}async alterVersion(e){return this._updatingHandlesExecute.addPromise(this._alterVersionInternal(e))}async changeVersion(e,r,o){return this._updatingHandlesExecute.addPromise(this._changeVersionInternal(e,r,o))}async createVersion(e){return this._updatingHandlesExecute.addPromise(this._createVersionInternal(e))}async deleteVersion(e,r,o){return this._updatingHandlesExecute.addPromise(this._deleteVersionInternal(e,r,o))}async getVersionInfos(e){return this._updatingHandlesExecute.addPromise(this._getVersionInfosInternal(e))}async _alterVersionInternal(e){if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new d("version-management-view-model:load-error",this.loadError);this._setExecutionError();const r=this.versioningStateLookup.get(e.featureServerUrl);if(!r)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new d("version-management-view-model:execution-error",this.executionError);if(!this.serverVersionLookup.has(e.featureServerUrl)||this.serverVersionLookup.get(e.featureServerUrl)<=11.1)throw this._logError("version-management-view-model:execution-error","no-valid-enterprise-version"),new d("version-management-view-model:execution-error",this.executionError);if(!this.advancedEditingUserTypeExtensionLookup.get(e.featureServerUrl))throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new d("version-management-view-model:execution-error",this.executionError);const{featureServerUrl:o,versionIdentifier:i,...t}=e,n=await r.alterVersion(i,t).catch(s=>{throw this._logExecutionError(s),s});return await this.getVersionInfos(o),n}async _changeVersionInternal(e,r,o){if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new d("version-management-view-model:load-error",this.loadError);this._setExecutionError();const i=this.versioningStateLookup.get(e);if(!i)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new d("version-management-view-model:execution-error",this.executionError);const t={name:r,guid:o};return await i.changeVersion(t).catch(n=>{throw this._logExecutionError(n),n})}_updateVersionableItems(e){this._updatingHandlesLoad.addPromise((async()=>{w(e.added).forEach(r=>{const o=r.featureServiceUrl,i=this.versioningStateLookup.get(o);i&&(i.versionableItems.find(t=>t.versionableItem===r.versionableItem)||i.versionableItems.add(r))}),w(e.removed).forEach(r=>{const o=r.featureServiceUrl,i=this.versioningStateLookup.get(o);if(!i)return void this._logError("version-management-view-model:execution-error","no-version-management-service-found");const t=i.versionableItems.find(n=>n.versionableItem===r.versionableItem);t&&i.versionableItems.remove(t)})})())}async _createVersionInternal(e){var m,p,c;if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new d("version-management-view-model:load-error",this.loadError);this._setExecutionError();const r=e.featureServerUrl,o=this.versioningStateLookup.get(r);if(!o)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new d("version-management-view-model:execution-error",this.executionError);const i=this.advancedEditingUserTypeExtensionLookup.get(e.featureServerUrl),t=this.userLookup.get(r).toUpperCase(),n=this._isEmptyString(e.ownerName)?t:(m=e.ownerName)==null?void 0:m.trim().toUpperCase();if(n!==t){if(this.serverVersionLookup.get(r)<=11.1)throw this._logError("version-management-view-model:execution-error","versioning-api-error"),new d("version-management-view-model:execution-error",this.executionError);if(!i)throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new d("version-management-view-model:execution-error",this.executionError)}let s=await((p=this.versioningStateLookup.get(r))==null?void 0:p.getVersionInfos());if((n==null?void 0:n.toUpperCase())==="SDE"&&e.versionName.toUpperCase()==="DEFAULT"||s!=null&&s.find(l=>l.versionIdentifier.name.toUpperCase()===(n+"."+e.versionName).toUpperCase()||l.versionIdentifier.name.toUpperCase()===(t+"."+e.versionName).toUpperCase()))throw this._logError("version-management-view-model:execution-error","no-valid-version-name"),new d("version-management-view-model:execution-error",this.executionError);const a=await o.versionManagementService.createVersion({versionName:e.versionName,access:n!==t?"public":e.access,description:e.description}).catch(l=>{throw this._logExecutionError(l),l});if(n!==t){const{guid:l,name:y}=a.versionIdentifier,x={featureServerUrl:r,versionIdentifier:{guid:l,name:y},access:e.access,ownerName:n};await this.alterVersion(x)||this.deleteVersion(r,t+"."+e.versionName,a.versionIdentifier.guid)}return await this.getVersionInfos(r),s=await((c=this.versioningStateLookup.get(r))==null?void 0:c.getVersionInfos()),s==null?void 0:s.find(l=>l.versionIdentifier.guid===a.versionIdentifier.guid)}async _deleteVersionInternal(e,r,o){if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new d("version-management-view-model:load-error",this.loadError);this._setExecutionError();const i=this.versioningStateLookup.get(e);if(!i)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new d("version-management-view-model:execution-error",this.executionError);if(this.serverVersionLookup.get(e)<=11.1)throw this._logError("version-management-view-model:execution-error","versioning-api-error"),new d("version-management-view-model:execution-error",this.executionError);if(!this.advancedEditingUserTypeExtensionLookup.get(e))throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new d("version-management-view-model:execution-error",this.executionError);const t={name:r,guid:o};return await i.deleteVersion(t).catch(n=>{throw this._logExecutionError(n),new d("version-management-view-model:execution-error",this.executionError)})}async _getVersionInfosInternal(e){var n,s;if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new d("version-management-view-model:load-error",this.loadError);this._setExecutionError();const r=(n=this.featureServiceLookup.get(e))==null?void 0:n.featureService;if(!r)throw this._logError("version-management-view-model:execution-error","no-feature-service-found"),new d("version-management-view-model:execution-error",this.executionError);r.loaded||await r.load().catch(a=>{throw this._logExecutionError(a),a});const o=r.url;this.serverVersionLookup.set(o,((s=r.sourceJSON)==null?void 0:s.currentVersion)??0),this.serverVersionLookup.get(o)<=11.1&&this.advancedEditingUserTypeExtensionLookup.set(o,!1);const i=this.userLookup.get(e);this._portalLookup.get(e)&&i?this.advancedEditingUserTypeExtensionLookup.set(o,await T(this._portalLookup.get(e),i,"advediting")):this.advancedEditingUserTypeExtensionLookup.set(o,!1);const t=this.versioningStateLookup.get(e);if(!t)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new d("version-management-view-model:execution-error",this.executionError);return t.loaded||await t.load().catch(a=>{throw this._logExecutionError(a),a}),await t.getVersionInfos(!0).catch(a=>{throw this._logExecutionError(a),a})}_isEmptyString(e){return!e||e.trim().length===0}_logError(e,r){switch(f.getLogger(this).error(new d(e,r)),e){case"version-management-view-model:load-error":this._setLoadError(r);break;case"version-management-view-model:execution-error":this._setExecutionError(r)}}_logExecutionError(e){this._logError("version-management-view-model:execution-error",e.message)}async _viewChangeHandle(){this._updatingHandlesLoad.addPromise((async()=>{if(this._setLoadError(),!this.view)return void this._setLoadError("no-view-property");if(this.view&&this.view.type!=="2d")return void this._logError("version-management-view-model:load-error","sceneView-not-supported");this.removeHandles("map-change-handle"),this.addHandles([g(()=>{var r;return(r=this.view)==null?void 0:r.map},()=>{this._resetAllLookupProperties(),this._mapChangeHandle(this.versioningStates)})],"map-change-handle");const e=await this._getVersioningStates();await this._mapChangeHandle(e)})())}async _mapChangeHandle(e){this._updatingHandlesLoad.addPromise((async()=>{this._setLoadError(),this.removeHandles("map-layers-tables-change-handle"),this.addHandles([L(()=>{var r;return(r=this.view)==null?void 0:r.map.allLayers},"change",r=>{(r.added.some(({type:o})=>o==="feature")||r.removed.some(({type:o})=>o==="feature")||r.added.some(({type:o})=>o==="subtype-group")||r.removed.some(({type:o})=>o==="subtype-group"))&&(this._resetServiceRelatedLookupProperties(),this._propertiesChangeInternal(this.versioningStates),this._updateVersionableItems(r))}),L(()=>{var r;return(r=this.view)==null?void 0:r.map.allTables},"change",r=>{(r.added.some(({type:o})=>o==="feature")||r.removed.some(({type:o})=>o==="feature")||r.added.some(({type:o})=>o==="subtype-group")||r.removed.some(({type:o})=>o==="subtype-group"))&&(this._resetServiceRelatedLookupProperties(),this._propertiesChangeInternal(this.versioningStates),this._updateVersionableItems(r))})],"map-layers-tables-change-handle"),await this._propertiesChangeInternal(e)})())}async _propertiesChangeInternal(e){this._updatingHandlesLoad.addPromise((async()=>{var t;const r=n=>n.type==="feature",{allLayers:o,allTables:i}=this.view.map;if(this._setLoadError(),this.featureServiceLookup=$([...o.filter(r),...i.filter(r)]),this.featureServiceLookup.size){this._updateFeatureServiceLookup(e),this.serviceNameLookup=new Map;for(const n of this.featureServiceLookup.values()){const{featureService:s,featureService:{url:a}}=n;if(!this.serviceNameLookup.has(a)){if(s.loaded||await s.load().catch(l=>{f.getLogger(this).error(l)}),!s.versionManagementServiceUrl){this.featureServiceLookup.delete(a);continue}const m=await M(a),p=new b({authMode:"immediate",url:m});await p.load().catch(l=>{f.getLogger(this).error(l)});const c=(t=p.user)==null?void 0:t.username;if(!s.loaded||!p.loaded||!c)continue;this.serviceNameLookup.set(H(a),a.split("/").at(-2)),this.userLookup.set(a,c),this._portalLookup.set(a,p)}}this.removeHandles("versioning-states-change-handle"),e.forEach(n=>this._handleVersioningStateLookupUpdate(n)),await this._updateVersioningStates(e),this.versioningStates=e}else this._logError("version-management-view-model:load-error","no-feature-services")})())}_updateFeatureServiceLookup(e){for(const r of e){const o=r.featureServiceUrl;if(!this.featureServiceLookup.has(o)){const i=new k({url:o}),t=r.versionableItems.toArray().flatMap(n=>n.type==="network"?null:n.versionableItem);this.featureServiceLookup.set(o,{featureService:i,layers:t})}}}async _updateVersioningStates(e){for(const r of this.featureServiceLookup.values()){const o=r.featureService;if(o.versionManagementServiceUrl){if(!e.find(i=>i.featureServiceUrl===o.url)&&o.versionManagementServiceUrl){const i=new E(w(r.layers)),t=new P({versionManagementService:new C({url:o.versionManagementServiceUrl}),versionableItems:i});e.add(t),this._handleVersioningStateLookupUpdate(t)}await this.getVersionInfos(o.url)}}}async _getVersioningStates(){return this.versioningStates&&this.versioningStates.length?this.versioningStates:this.view?await N(this.view,!1):(this._logError("version-management-view-model:load-error","no-view-property"),new E)}_handleVersioningStateLookupUpdate(e){var r;this.versioningStateLookup.set(e.featureServiceUrl,e),this._addHandlesToVersioningState(e),this.versionIdentifierLookup.set(e.featureServiceUrl,(r=e.currentVersionInfo)==null?void 0:r.versionIdentifier),this.versionManagementServiceLookup.set(e.featureServiceUrl,e.versionManagementService)}async _setVersioningStatesLookups(){this._updatingHandlesLoad.addPromise((async()=>{this.versioningStates&&(this.removeHandles("versioning-states-change-handle"),this._updateFeatureServiceLookup(this.versioningStates),this.versioningStates.forEach(e=>this._handleVersioningStateLookupUpdate(e)),await this._updateVersioningStates(this.versioningStates))})())}_addHandlesToVersioningState(e){this.addHandles([g(()=>e.versionInfos,()=>{this.versionInfoLookup.set(e.featureServiceUrl,e.versionInfos)}),g(()=>{var r;return(r=e.currentVersionInfo)==null?void 0:r.versionIdentifier},()=>{var r;this.versionIdentifierLookup.set(e.featureServiceUrl,(r=e.currentVersionInfo)==null?void 0:r.versionIdentifier)})],"versioning-states-change-handle")}_resetVersioningLookupProperties(){this.versionIdentifierLookup=new Map,this.versionInfoLookup=new Map,this.versionManagementServiceLookup=new Map,this.versioningStateLookup=new Map}_resetAllLookupProperties(){this._portalLookup=new Map,this.advancedEditingUserTypeExtensionLookup=new Map,this.serverVersionLookup=new Map,this.userLookup=new Map,this.versioningStates=new E,this._resetVersioningLookupProperties(),this._resetServiceRelatedLookupProperties()}_resetServiceRelatedLookupProperties(){this.featureServiceLookup=new Map,this.serviceNameLookup=new Map}_setExecutionError(e){this._set("executionError",e)}_setLoadError(e){this._set("loadError",e)}};v([h()],u.prototype,"_portalLookup",void 0),v([h()],u.prototype,"advancedEditingUserTypeExtensionLookup",void 0),v([h({readOnly:!0})],u.prototype,"executionError",void 0),v([h()],u.prototype,"featureServiceLookup",void 0),v([h({readOnly:!0})],u.prototype,"loadError",void 0),v([h()],u.prototype,"serverVersionLookup",void 0),v([h()],u.prototype,"serviceNameLookup",void 0),v([h({readOnly:!0})],u.prototype,"state",null),v([h()],u.prototype,"userLookup",void 0),v([h()],u.prototype,"versionIdentifierLookup",void 0),v([h()],u.prototype,"versionInfoLookup",void 0),v([h()],u.prototype,"versionManagementServiceLookup",void 0),v([h()],u.prototype,"versioningStateLookup",void 0),v([h()],u.prototype,"view",void 0),v([h()],u.prototype,"versioningStates",void 0),u=v([I("esri.widgets.VersionManagement.VersionManagementViewModel")],u);const O=u;export{O as default};
