import{cU as Ye,eT as Qn,g2 as Ve,eU as et,aR as J,oj as nt,fB as D,fD as rn,fx as R,eC as le,fw as L,g3 as De,fv as G,fy as j,ep as d,eq as ne,ft as _,g4 as O,fu as Xe,ok as tt,eW as b,lH as at,eD as ue,bm as Oe,fE as ye,eA as Ee,fY as it,ol as rt,eu as ot,g5 as He,h0 as st,om as Ie,on as ct,oo as te,bw as h,f$ as Fe,fA as lt,dm as on,op as ut,J as ft,aM as T,j2 as k,fV as Ue,dy as mt,ao as dt,eL as sn,gf as Ge,A as cn,oq as pt,or as gt,os as ht,mS as yt,il as wt,ca as xt,fa as ln,cc as un,bJ as vt,h6 as Ce,fR as Qe,dB as Mt,fs as x,eO as Rt,jo as bt,eo as Tt,ot as St,ou as $t,ov as zt,eB as Gt}from"./index-BfC8i6jT.js";import{u as Ct}from"./computeTranslationToOriginAndRotation-DK7GzGeb.js";import{c as fe,i as me}from"./projectPointToVector-C0Qwzs7z.js";import{t as ae,c as fn}from"./projectVectorToPoint-sjRZ-2WD.js";import{n as Z}from"./projectVectorToVector-C51LtB8f.js";import{l as At}from"./frustum-Bdr-rFEQ.js";import{u as Pt}from"./scaleUtils-DL5-S4xE.js";import{T as Dt,b as we}from"./ElevationProvider-BU9L4pxM.js";import{l as Ot,f as Et}from"./spatialReferenceEllipsoidUtils-6vOoKuZD.js";import{l as Ht,s as It}from"./earthUtils-B4BKKXMy.js";import{r as Ft}from"./spatialReferenceSupport-BIiDjE2t.js";function Ut(e){return Ye(e,Ot)||Qn(e)?{wkid:Ve.GCSMARS2000}:Ye(e,Et)||et(e)?{wkid:Ve.GCSMOON2000}:J.WGS84}function Ya(e,n,t,i){return e.renderCoordsHelper.fromRenderCoords(n.eye,de,i)!=null&&nt(t,de)}function jt(e,n){return e.elevationProvider?e.elevationProvider.getElevation(n[0],n[1],n[2],e.renderCoordsHelper.spatialReference,"ground")??0:0}function K(e,n,t,i){const a=e.state.camera.clone();n&&t&&i&&(a.eye=n,a.center=t,a.up=i),_t(e,a.ray,A)||D(A,a.center);const r=e.state.constraints,o=r.minimumPoiDistance;if(rn(a.eye,A)<o){const s=r.collision.enabled;D(F,a.viewForward),R(F,F,o),s?a.eye=le(de,A,F):L(A,a.eye,F);const c=e.renderCoordsHelper,l=c.getAltitude(a.eye),u=r.collision.elevationMargin;s&&l<u&&(le(F,A,a.eye),a.eye=c.setAltitude(de,u,a.eye),L(A,a.eye,F))}return a.center=A,a}function en(e,n,t){if(!e.state.isGlobal||!e.stateManager.constraintsManager)return!1;const i=jt(e,n),a=e.stateManager.constraintsManager.nearFarHeuristic,{far:r}=a.compute(n,t,e.renderDataExtent,i,qt),o=r*r;return rn(n,t)>o}function _t(e,n,t){let i=nn[e.viewingMode];i||(i=Dt(e.state.viewingMode),i.options.backfacesTerrain=!e.state.isGlobal,i.options.invisibleTerrain=!0,nn[e.viewingMode]=i);const{isGlobal:a}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(n,i,t)||en(e,n.origin,t))||!(!e.renderCoordsHelper.intersectManifold(n,0,t)||en(e,n.origin,t))||!!a&&kt(n,t,De(e.spatialReference).radius)}function kt(e,n,t){const i=G(e.origin,e.origin)-t*t,a=i>0?Math.sqrt(i)/3:1;return R(n,e.direction,a/j(e.direction)),L(n,n,e.origin),!0}const nn={},de=d(),A=d(),F=d(),qt={near:0,far:0},Bt=d(),re=d();function mn(){return{direction:d(),up:d()}}function dn(e,n,t,i,a){let r=ne(Bt,e),o=G(r,i);const s=o>0;o=Math.abs(o),o>.99&&(o=Math.abs(G(n,i)),o<.99?(D(r,n),s&&R(r,r,-1)):r=null);let c=0;if(r){R(re,i,G(i,r)),le(r,r,re);const u=G(r,a)/(j(r)*j(a));_(re,r,a),c=(G(re,i)>0?1:-1)*O(Xe(u))}const l=O(Xe(-G(i,e)/j(e)));return t?(t.heading=c,t.tilt=l,t):{heading:c,tilt:l}}const pn=ye(0,1,0),gn=ye(0,0,1),V=Ee(),$=d(),z=d();function hn(e,n,t,i=mn()){const{direction:a,up:r}=i;return tt(V,-b(n)),at(V,V,b(t)),ue(a,gn,V),R(a,a,-1),ue(r,pn,V),i}function Lt(e,n,t,i){return dn(n,t,i,gn,pn)}function Zt(e,n,t,i){const a=hn(e,t,i),r=d();return R(r,a.direction,-n),L(r,r,e),{up:a.up,eye:r,heading:t,tilt:i}}function Wt(e){return O(e)}function Jt(e){return b(e)}function yn(e,n,t,i,a){const r=e.renderSpatialReference,o=e.map&&e.spatialReference||n.spatialReference;return fe(n,$,r),fe(n,z,r),$[0]-=t/2,z[0]+=t/2,$[1]-=i/2,z[1]+=i/2,Z($,r,$,o),Z(z,r,z,o),a?(a.xmin=$[0],a.ymin=$[1],a.xmax=z[0],a.ymax=z[1],a.spatialReference=o):a=new Oe($[0],$[1],z[0],z[1],o),a}const Kt=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:Lt,eyeForCenterWithHeadingTilt:Zt,eyeTiltToLookAtTilt:Jt,headingTiltToDirectionUp:hn,lookAtTiltToEyeTilt:Wt,toExtent:yn},Symbol.toStringTag,{value:"Module"})),wn=ye(0,0,1),xn=ne(d(),ye(1,1,1)),Nt=new Ie(-180,180),X=Ee(),P=d(),q=d();function vn(e,n,t,i=mn()){_(P,e,wn),G(P,P)===0&&_(P,e,xn),it(X,-b(n),e),rt(X,X,-b(t),P);const{up:a,direction:r}=i;return _(a,P,e),ne(a,a),ue(a,a,X),ne(r,e),ot(r,r),ue(r,r,X),i}function Yt(e,n,t,i){const a=P,r=q;return ne(a,e),_(q,a,wn),G(q,q)===0&&_(q,a,xn),_(r,q,a),dn(n,t,i,a,r)}function Vt(e,n,t,i){const a={eye:d(),up:null,tilt:i,heading:t},r=P;r[0]=e[0],r[1]=e[2],r[2]=-e[1];const o=n,s=b(t),c=b(i),l=Math.sin(s),u=Math.cos(s),g=Math.sin(c),f=Math.cos(c),y=j(r);let p;if(Math.abs(c)<1e-8)p=o+y;else{const Ne=y/g,Vn=He(o/Ne),Xn=Math.PI-c-Vn;p=Ne*Math.sin(Xn)}const S=f*o,C=o*o*(g*g),H=u*u*C,I=p-S,w=I*I,Y=H*(H+w-r[1]*r[1]);if(Y<0)return R(a.eye,r,p/y),a.tilt=0,oe(a,e);const Le=Math.sqrt(Y),Ze=r[1]*I,We=H+w;let Je;if(Je=u>0?-Le+Ze:Le+Ze,Math.abs(We)<1e-8)return y<1e-8?(a.eye[0]=0,a.eye[1]=0,a.eye[2]=o):R(a.eye,r,p/y),a.tilt=0,Se(a.eye),oe(a,e);a.eye[1]=Je/We;const Nn=l*l*C,Re=g*o,Yn=u*Re*a.eye[1],Ke=a.eye[1]*a.eye[1],ie=1-Ke,be=Math.sqrt(ie),Te=H*Ke+Nn-2*Yn*be*I+ie*w;return Math.abs(Te)<1e-8?(R(a.eye,r,p/y),a.tilt=0,Se(a.eye),oe(a,e)):(a.eye[0]=(ie*(p*r[0]-S*r[0])-Re*be*(r[0]*a.eye[1]*u+r[2]*l))/Te,a.eye[2]=(ie*(p*r[2]-S*r[2])-Re*be*(r[2]*a.eye[1]*u-r[0]*l))/Te,R(a.eye,a.eye,p),Se(a.eye),oe(a,e))}function Se(e){const n=e[1];e[1]=-e[2],e[2]=n}function oe(e,n){const t=vn(n,e.heading,e.tilt);return e.up=t.up,e}function Xt(e,n,t){const i=j(n),a=Math.sqrt(t*t+i*i-2*t*i*Math.cos(Math.PI-e)),r=He(t/(a/Math.sin(e)));return O(e-r)}function Qt(e,n,t){const i=b(e),a=j(n);return He(t/(a/Math.sin(i)))+i}function Mn(e,n,t,i,a){let r,o,s,c;const l=n.latitude,u=De(e.spatialReference).radius,g=n.longitude,f=Ht(l,t,u)/2;r=g-f,o=g+f;const y=b(l),p=(1+Math.sin(y))/(1-Math.sin(y)),S=(p+1)*Math.tan(i/u/2),C=S*S;function H(w){const Y=Math.PI/2;return(w=ct.normalize(w,-Y))>Y&&(w=Math.PI-w),w}if(s=1.5*Math.PI-2*Math.atan(.5*(S+Math.sqrt(4*p+C))),c=s+i/u,s=H(s),c=H(c),c<s){const w=c;c=s,s=w}if(s=Math.max(O(s),-90),c=Math.min(O(c),90),o=Nt.monotonic(r,o),o-r>180){const w=(o-r-180)/2;r+=w,o-=w}const I=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:J.WGS84;return a?(a.xmin=r,a.ymin=s,a.xmax=o,a.ymax=c,a.spatialReference=I):a=new Oe(r,s,o,c,I),e.spatialReference&&e.spatialReference.isWebMercator&&st(a,!1,a),a}const ea=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:Yt,eyeForCenterWithHeadingTilt:Vt,eyeTiltToLookAtTilt:Qt,headingTiltToDirectionUp:vn,lookAtTiltToEyeTilt:Xt,toExtent:Mn},Symbol.toStringTag,{value:"Module"})),Rn=()=>ft.getLogger("esri.views.3d.support.cameraUtils"),bn=39.37,Tn=96,Ae=1,na=8,ta=5,Sn=1,tn=d(),aa={heading:0,tilt:0},ee=d(),ia=new Ie(-20037508342788905e-9,20037508342788905e-9),ra=new Ie(-180,180);var v;function E(e){return e.spatialReference??J.WGS84}function N(e){return e.viewingMode==="global"?ea:Kt}function Va(e,n,t,i,a){return N(e).headingTiltToDirectionUp(n,t,i,a)}function oa(e,n){if(n==null)return null;const t=e.renderSpatialReference,i=N(e).headingTiltToDirectionUp,a=d();if(!fe(n.position,a,t))return null;const r=i(a,n.heading,n.tilt);R(r.direction,r.direction,e.state.camera.distance),L(r.direction,r.direction,a);const o=K(e,a,r.direction,r.up);return o.fov=b(n.fov),o.row=n.layout.row,o.rows=n.layout.rows,o.column=n.layout.column,o.columns=n.layout.columns,o}(function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"})(v||(v={}));const B=d();function xe(e,n,t){const i=e.renderSpatialReference,a=_e(e,n.eye,n.viewForward,n.up,aa);let r=E(e);return Z(n.eye,i,B,r)||(r=J.WGS84,Z(n.eye,i,B,r)),t==null?t=new te(new h(B,r),a.heading,a.tilt,O(n.fov)):(t.position.x=B[0],t.position.y=B[1],t.position.z=B[2],t.position.spatialReference=r,t.heading=a.heading,t.tilt=a.tilt,t.fov=O(n.fov)),t.layout.row=n.row,t.layout.rows=n.rows,t.layout.column=n.column,t.layout.columns=n.columns,t}function je(e,n,t){const i=e.state.camera,a=i.width/2/i.pixelRatio;return e.renderCoordsHelper.viewingMode===Fe.Global&&t!=null&&(n*=Math.cos(b(t))),n/=e.renderCoordsHelper.unitInMeters,a/(Tn*bn/n)/Math.tan(i.fovX/2)}function W(e,n,t){const i=e.state.camera,a=n*Math.tan(i.fovX/2),r=i.width/2/i.pixelRatio;let o=Tn*bn/(r/a);return e.renderCoordsHelper.viewingMode===Fe.Global&&t!=null&&(o/=Math.cos(b(t))),o*e.renderCoordsHelper.unitInMeters}async function $n(e,n,t,i,a,r){return zn(e,n,je(e,t,n.latitude),i,a,r)}function sa(e,n,t,i,a,r){return kn(e,Cn(e,i.heading,i.tilt,n,t,a),i.fov,r)}async function zn(e,n,t,i,a,r){const o=await An(e,i.heading,i.tilt,n,t,a,r);return T(r),qn(e,o,i.fov,r)}function _e(e,n,t,i,a){return N(e).directionToHeadingTilt(n,t,i,a)}function Gn(e,n){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(n,ee,e.spatialReference)&&e.elevationProvider&&(we(e.elevationProvider,ee)??0)>ee[2]-Sn)}async function ca(e,n,t){if(Gn(e,n))return!0;const{elevationProvider:i,spatialReference:a,renderCoordsHelper:r}=e;if(i==null||!r.fromRenderCoords(n,ee,a))return!1;const[o,s,c]=ee,l=await i.queryElevation(o,s,c,a,"ground",t)??0;return T(t),l>c-Sn}async function la(e,n,t){const i=d();if(n==null)return D(i,e.state.camera.center);if(n instanceof h){const{renderSpatialReference:a,basemapTerrain:r,elevationProvider:o}=e,s=n.spatialReference;if(await me(n,i,a,0,{signal:t}),T(t),n.z==null&&r!=null&&o!=null){const c=await o.queryElevation(n.x,n.y,n.z??0,s,"ground",t);T(t),c!=null&&e.renderCoordsHelper.setAltitude(i,c)}return i}return D(i,n)}function ua(e,n){const t=d();if(n==null)return D(t,e.state.camera.center);if(n instanceof h){if(!fe(n,t,e.renderSpatialReference))return null;const{basemapTerrain:i,elevationProvider:a}=e;if(n.z==null&&i!=null&&a!=null){const r=we(a,n);r!=null&&e.renderCoordsHelper.setAltitude(t,r)}return t}return D(t,n)}function Cn(e,n,t,i,a,r){return Pn(e,n,t,i instanceof h?i:null,ua(e,i),a,r)}async function An(e,n,t,i,a,r,o){const s=i instanceof h?i:null,c=await la(e,i,o);return T(o),Dn(e,n,t,s,c,a,r,o)}function Pn(e,n,t,i,a,r,o){if(a==null||!i&&(i=new h({spatialReference:E(e)}),!ae(a,e.renderSpatialReference,i)))return null;const s=On(e,n,t,a,r,o);if(En(e,t,o)&&Gn(e,s.eye)){const{tilt:c,mode:l}=Hn(e,t,a,r);return Pn(e,n,c,i,a,r,l)}return In(s,a)}async function Dn(e,n,t,i,a,r,o,s){i||(i=new h({spatialReference:E(e)}),await fn(a,e.renderSpatialReference,i,{signal:s})||(i=null)),T(s);const c=On(e,n,t,a,r,o);if(En(e,t,o)&&await ca(e,c.eye,s)){T(s);const{tilt:l,mode:u}=Hn(e,t,a,r);return Dn(e,n,l,i,a,r,u,s)}return In(c,a)}function On(e,n,t,i,a,r){const o=da(e,n,t,i,a=Math.max(a,e.state.constraints.minimumPoiDistance),r);return(0,N(e).eyeForCenterWithHeadingTilt)(i,a,o.heading,o.tilt)}function En(e,n,t){const i=e.map.ground.navigationConstraint;return t===v.ADJUST&&e.viewingMode==="global"&&n>0&&(i==null||i.type==="stay-above")}function Hn(e,n,t,i){const a=_n(e,t,i,ga(e,i,n,t));return{tilt:a,mode:n-a<1?v.LOCKED:v.ADJUST}}function In(e,n){return{...e,center:lt(n)}}function Fn(e,n){const{state:t,spatialReference:i}=e,a=n.spatialReference;return t.isGlobal&&Ft(a,Fe.Global)||t.isLocal&&i.equals(a)}function Un(e,n){let t,i,a;if(e.state.isGlobal){const u=new h(n.xmin,n.ymin,n.spatialReference),g=new h(n.xmax,n.ymax,n.spatialReference),f=n.spatialReference.isGeographic?ra:ia;t=new h({x:f.center(u.x,g.x),y:(g.y+u.y)/2,z:n.zmax!=null&&n.zmin!=null?(n.zmax+n.zmin)/2:void 0,spatialReference:n.spatialReference});const y=De(n.spatialReference),p=It(t,u,g);i=p.lon,a=p.lat,f.diff(u.x,g.x)>f.range/2&&(i+=y.halfCircumference),i=Math.min(i,y.halfCircumference),a=Math.min(a,y.halfCircumference)}else{const u=e.renderSpatialReference??n.spatialReference;u.equals(n.spatialReference)||(n=on(n,u)),i=n.xmax-n.xmin,a=n.ymax-n.ymin;const g=n.zmax!=null&&n.zmin!=null?(n.zmax+n.zmin)/2:void 0;t=new h({x:n.xmin+.5*i,y:n.ymin+.5*a,z:g,spatialReference:u})}const r=n.zmax!=null&&n.zmin!=null?n.zmax-n.zmin:0,o=e.state.camera,s=1/Math.tan(o.fovX/2),c=1/Math.tan(o.fovY/2),l=1/Math.tan(o.fov/2);return{center:t,distance:Math.max(.5*i*s,.5*a*c,.5*r*l)/Ae}}async function jn(e,n,t,i,a,r){const o=Fn(e,n)?n:await k(n,e.spatialReference,{signal:r});T(r);const{center:s,distance:c}=Un(e,o),l=await An(e,t,i,s,c,a,r);return T(r),qn(e,l,e.camera.fov,r)}function fa(e,n,t,i,a,r){let o;try{o=Fn(e,n)?n:on(n,e.spatialReference)}catch{return null}const{center:s,distance:c}=Un(e,o),l=Cn(e,t,i,s,c,a);return l==null?null:kn(e,l,e.camera.fov,r)}function Xa(e,n,t){const i=e.renderSpatialReference,a=new h({spatialReference:E(e)});if(!ae(t,i,a))return null;const r=Math.tan(n.fovX/2),o=Math.tan(n.fovY/2),s=ut(n.eye,t),c=2*s*r*Ae,l=2*s*o*Ae;return e.viewingMode==="global"?Mn(e,a,c,l):yn(e,a,c,l)}function ma(e,n,t){const i=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(t/i)/Math.LN2>na)return!0;const a=n,r=e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;return Ue(a,r)/(Math.tan(.5*e.state.camera.fov)*i)>ta}function da(e,n,t,i,a,r){let o=0;return r===v.ADJUST&&ma(e,i,a)?(n=0,o=pa(e,a,t,i)):o=ke(e,i,a,t),o=e.state.constraints.clampTilt(a,o),{heading:n,tilt:t=_n(e,i,a,o)}}const pe=.7;function pa(e,n,t,i){const a=ke(e,i,n,t);if(!e.state.constraints.tilt)return a;const r=e.state.constraints.tilt(n);r.max=Math.min(r.max,.5*Math.PI);const o=r.min*(1-pe)+r.max*pe;return Math.min(a,o)}function ga(e,n,t,i){let a=ke(e,i,n,t);if(!e.state.constraints.tilt)return a;const r=e.state.constraints.tilt(n);return a=Math.min(a,.5*Math.PI),r.min*(1-pe)+a*pe}function _n(e,n,t,i){return N(e).lookAtTiltToEyeTilt(i,n,t)}function ke(e,n,t,i){return N(e).eyeTiltToLookAtTilt(i,n,t)}function kn(e,n,t,i){if(n==null)return null;const a=e.renderSpatialReference,r=new h({spatialReference:E(e)});return ae(n.eye,a,r)?(i??(i=new te),i.position=r,i.heading=n.heading,i.tilt=n.tilt,i.fov=t,i):null}async function qn(e,n,t,i){const a=e.renderSpatialReference,r=new h({spatialReference:E(e)});return await fn(n.eye,a,r,{signal:i}),T(i),new te(r,n.heading,n.tilt,t)}function Qa(e,n){var i;const t=(i=e.basemapTerrain)==null?void 0:i.tilingScheme;if(t)return t.levelAtScale(n);Rn().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function ha(e,n){var i;const t=(i=e.basemapTerrain)==null?void 0:i.tilingScheme;if(t)return t.scaleAtLevel(n);Rn().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function Bn(e,n){const{renderSpatialReference:t}=e,i=Ut(t);let a=null;try{Z(n.center,t,tn,i)&&(a=tn[1])}catch{}return W(e,n.distance,a)}const ya=.66;function Ln(e){return 360-un.normalize(e)}function ve(e){return un.normalize(360-e)}function wa(e,n,t){const i=n.camera;if(i!=null)return xa(i,E(e));const{targetGeometry:a}=n;if(a==null)return null;const{camera:r,mode:o}=Wn(e,n.rotation,t);if(a.type==="point")return Ma(e,n,a,r,o);const s=a.extent;return s==null?null:fa(e,s,r.heading,r.tilt,o)}async function Zn(e,n,t,i){const a=n.camera;if(a!=null)return va(a,E(e),i);const{targetGeometry:r}=n;if(r==null)throw new Error("Viewpoint has no targetGeometry!");const{camera:o,mode:s}=Wn(e,n.rotation,t);if(r.type==="point")return Ra(e,n,r,o,s,i);const c=r.extent;if(c==null)throw new Error("Target geometry has no extent!");return jn(e,c,o.heading,o.tilt,s,i)}function xa(e,n){const t=e.position;let i;try{i=sn(t,n)}catch{return null}if(!i)return null;const a=e.clone();return a.position=i.clone(),a}async function va(e,n,t){const i=e.position,a=await k(i,n,{signal:t});T(t);const r=e.clone();return r.position=a.clone(),r}function Wn(e,n,t){const i=xe(e,e.state.camera);let a=v.ADJUST;return n!=null&&(i.heading=Ln(n),a=v.LOCKED),t!=null&&(i.tilt=t),{camera:i,mode:a}}function Ma(e,n,t,i,a){const r=e.spatialReference;let o;try{o=sn(t.clone(),r)}catch{return null}if(!o)return null;const s=n.scale!=null?je(e,n.scale,o.latitude):e.state.camera.distance;return sa(e,o,s,i,a)}async function Ra(e,n,t,i,a,r){const o=e.spatialReference,s=await k(t.clone(),o,{signal:r});T(r);const c=n.scale!=null?je(e,n.scale,s.latitude):e.state.camera.distance;return zn(e,s,c,i,a,r)}function ba(e,n,t=null){return t==null&&(t=new Ge),Be(e,null,n.clone(),t)}async function Ta(e,n,t){const i=Ea(e,n);if(!i)throw new cn("viewpointutils-create:no-target","Missing target for creating viewpoint");const a=new te({fov:e.camera.fov}),r=new Ge({camera:a});if(i.target instanceof Ge)return U(await za(e,i.target,i,t,r));if(i.target instanceof te)return U(await Kn(e,i.target,t,r));const o=i.scale!=null||i.zoom!=null;if(i.target instanceof Oe){const l=i.target.xmin===i.target.xmax||i.target.ymin===i.target.ymax;return U(o||l?await Pe(e,i,i.target.center,a,t,r):await Pa(e,i,i.target,a,t,r))}const s=new Ia,c=o?Sa(e,i):void 0;if(await Jn(e,i.target,c,s,t),isFinite(s.boundingBox[0])){let l;if(pt(s.boundingBox,m),M.x=m[0],M.y=m[1],M.z=m[2],M.spatialReference=e.spatialReference,isFinite(M.z)&&s.hasZ?l=gt(s.boundingBox):(M.z=void 0,l=ht(yt(s.boundingBox,Fa))),o||l)return U(await Pe(e,i,M,a,t,r));const u=Ha(e,s.screenSpaceObjects);return U(await Oa(e,i,M,s.boundingBox,u,a,t,r))}return i.position?U(await Ca(e,i,a,r,t)):U(await Aa(e,i,a,t,r))}function qe(e,n){return n.scale==null&&n.zoom!=null?ha(e,n.zoom):n.scale}function Sa(e,n){const t=qe(e,n);return t?Pt(t):void 0}function Me(e,n){let t=!1;return n.heading!=null?(e.heading=n.heading,t=!0):n.rotation!=null&&(e.heading=Ln(n.rotation),t=!0),n.tilt!=null&&(e.tilt=n.tilt,t=!0),n.fov!=null&&(e.fov=n.fov),t}function Be(e,n,t,i){const a=e.spatialReference||J.WGS84;if(n??(n=oa(e,t)),n==null)return i;const r=new h({spatialReference:a});if(!ae(n.center,e.renderSpatialReference,r))return i;i.targetGeometry=r;const{latitude:o}=r;return i.scale=o!=null?W(e,n.distance,o):Bn(e,n),i.rotation=ve(t.heading),i.camera=t,i}async function ge(e,n,t,i){var g;const a=()=>new cn("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!n)throw a();n.type==="mesh"&&(n=n.extent);const r=e.basemapTerrain.spatialReference;if(!n.hasZ&&e.basemapTerrain){let f;switch(n.type){case"point":f=n;break;case"multipoint":case"polyline":f=(g=n.extent)==null?void 0:g.center;break;case"extent":f=n.center;break;case"polygon":f=n.centroid}f!=null&&r&&e.elevationProvider?(f=await k(f,r,{signal:i}),m[2]=we(e.elevationProvider,f)??0):m[2]=0}const o=Ua[n.type],s=new Array;if(o(n,n.hasZ?f=>{s.push([f[0],f[1],f[2]])}:f=>{s.push([f[0],f[1]])},m),s.length===0)throw a();const c=n.spatialReference,l=e.spatialReference,u=await k(new vt({spatialReference:c,hasZ:n.hasZ,hasM:!1,points:s}),l,{signal:i});if(n.hasZ&&(t.hasZ=!0),n.hasZ)for(const[f,y,p]of u.points)m[0]=f,m[1]=y,m[2]=p,Ce(t.boundingBox,m);else for(const[f,y]of u.points)m[0]=f,m[1]=y,Ce(t.boundingBox,m)}async function $a(e,n,t,i,a){const r=await Qe(e.whenViewForGraphic(n));if(r.ok===!1||r.value==null||!("whenGraphicBounds"in r.value))return void await ge(e,n.geometry,i,a);const o=r.value,s=await Qe(o.whenGraphicBounds(n,{minDemResolution:t}));if(s.ok===!1||!s.value)return void await ge(e,n.geometry,i,a);const{screenSpaceObjects:c,boundingBox:l}=s.value;Mt(i.boundingBox,l),c&&c.forEach(u=>{i.screenSpaceObjects.push(u)}),isFinite(l[2])&&(i.hasZ=!0)}async function Jn(e,n,t,i,a){var r;if(Array.isArray(n)&&n.length===2){const o=n[0],s=n[1];if(typeof o=="number"&&typeof s=="number")return M.x=o,M.y=s,M.z=void 0,M.spatialReference=(r=e.spatialReference)!=null&&r.isGeographic?e.spatialReference:J.WGS84,void await ge(e,M,i,a)}n&&"map"in n&&typeof n.map=="function"?await Promise.allSettled(n.map(o=>Jn(e,o,t,i,a))):n instanceof wt?await ge(e,n,i,a):n instanceof xt&&await $a(e,n,t,i,a)}async function za(e,n,t,i,a){if(n.camera)return Kn(e,n.camera,i,a);a.scale=n.scale,a.rotation=n.rotation,a.targetGeometry=n.targetGeometry!=null?n.targetGeometry.clone():null,a.camera=null,t.heading!=null?a.rotation=ve(t.heading):t.rotation!=null&&(a.rotation=t.rotation);const r=qe(e,t);return r!=null&&(a.scale=r),a.camera=await Zn(e,a,t.tilt,i),a}async function Kn(e,n,t,i){const a=e.spatialReference,r=await k(n.position,a,{signal:t}),o=n.clone();return o.position=r,Be(e,null,o,i)}async function Ga(e,n,t,i,a,r,o){const s=e.renderSpatialReference;return await me(n,$e,s,0,{signal:o}),await me(t,ce,s,0,{signal:o}),r.targetGeometry=new h(n),a.position=new h(t),le(he,$e,ce),_e(e,ce,he,i.up,a),r.scale=W(e,Ue(ce,$e),r.targetGeometry.latitude),r.rotation=ve(a.heading),r.camera=a,r}async function Pe(e,n,t,i,a,r){r.targetGeometry=t.clone();const o=K(e);if(n.position)return Ga(e,r.targetGeometry,n.position,o,i,r,a);if(n.zoomFactor){const c=o.distance/n.zoomFactor,l=R(m,o.viewForward,-c);o.eye=L(m,o.center,l),r.scale=W(e,c,t.latitude)}xe(e,o,i);const s=Me(i,n)?v.LOCKED:v.ADJUST;if(!n.zoomFactor){const c=qe(e,n);c==null?(await me(t,m,e.renderSpatialReference,0,{signal:a}),At(o.frustum,m)?r.scale=W(e,Ue(o.eye,m),t.latitude):r.scale=Bn(e,o)):r.scale=c,r.camera=await $n(e,r.targetGeometry,r.scale,i,s,a)}return r}async function Ca(e,n,t,i,a){const r=K(e);D(he,r.viewForward),_e(e,r.eye,he,r.up,ze);const o=e.spatialReference,{position:s}=n;if(s){const c=await k(s,o,{signal:a});t.position=c}else t.position=new h;return t.heading=n.heading!=null?n.heading:ze.heading,t.tilt=n.tilt!=null?n.tilt:ze.tilt,Be(e,null,t,i)}async function Aa(e,n,t,i,a){if(n.heading!=null||n.rotation!=null||n.scale!=null||n.tilt!=null||n.zoom!=null||n.zoomFactor!=null){const r=K(e),{spatialReference:o,renderSpatialReference:s}=e,c=new h({spatialReference:o});return ae(r.center,s,c)?Pe(e,n,c,t,i,a):a}return a.scale=e.scale,a.camera=e.camera.clone(),Me(a.camera,n),a}async function Pa(e,n,t,i,a,r){r.targetGeometry=t.clone();const o=K(e);xe(e,o,i);const s=Me(i,n)?v.LOCKED:v.ADJUST;return r.camera=await jn(e,t,i.heading,i.tilt,s,a),r}function Da(e,n,t,i,a){let r=0;t.z!=null?r=t.z:e.basemapTerrain&&e.elevationProvider&&(r=we(e.elevationProvider,t)),x(m,t.x,t.y,r),Ct(e.spatialReference,m,an,e.renderSpatialReference),Rt(se,an),bt(se,se),ln(Q);const o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let p=0;p<o.length;p++){const S=o[p];let C=i[S[2]];isFinite(C)||(C=r),x(m,i[S[0]],i[S[1]],C),Z(m,e.spatialReference,m,e.renderSpatialReference),Ce(Q,Tt(m,m,se))}const s=St(Q),c=$t(Q),l=zt(Q),u=1/Math.tan(n.fovX/2),g=1/Math.tan(n.fovY/2),f=.5*Math.sqrt(s*s+l*l)*Math.max(g,u)+.5*c,y=.5*c*g+.5*Math.max(s,l);return Math.max(f,y)/a}async function Oa(e,n,t,i,a,r,o,s){s.targetGeometry=t.clone();const c=K(e),l=Da(e,c,t,i,a);xe(e,c,r);const u=Me(r,n)?v.LOCKED:v.ADJUST;return s.scale=W(e,l,s.targetGeometry.latitude),s.camera=await $n(e,s.targetGeometry,s.scale,r,u,o),s}function Ea(e,n){if(!n||!e.spatialReference)return null;const t={target:void 0};return"declaredClass"in n||Array.isArray(n)?t.target=n:(Object.assign(t,n),!t.target&&"center"in n&&n.center&&(t.target=n.center)),t}function U(e){return(e==null?void 0:e.camera)!=null&&(e.rotation=ve(e.camera.heading)),e}function Ha(e,n){const t=ya;if(!n.length)return t;let i=Number.NEGATIVE_INFINITY;for(let a=0;a<n.length;a++){const r=n[a].screenSpaceBoundingRect;i=Math.max(i,Math.abs(r[0]),Math.abs(r[1]),Math.abs(r[2]),Math.abs(r[3]))}return t-i/Math.min(e.width,e.height)*2}class Ia{constructor(){this.hasZ=!1,this.boundingBox=ln(),this.screenSpaceObjects=new Array}}const m=d(),an=Ee(),se=Gt(),Q=mt(),Fa=dt(),he=d(),ce=d(),$e=d(),ze={heading:0,tilt:0},M=new h,Ua={point(e,n,t){t[0]=e.x,t[1]=e.y,e.z!=null&&(t[2]=e.z),n(t)},polygon(e,n,t){const i=e.hasZ;for(let a=0;a<e.rings.length;a++){const r=e.rings[a];for(let o=0;o<r.length;o++)t[0]=r[o][0],t[1]=r[o][1],i&&(t[2]=r[o][2]),n(t)}},polyline(e,n,t){const i=e.hasZ;for(let a=0;a<e.paths.length;a++){const r=e.paths[a];for(let o=0;o<r.length;o++)t[0]=r[o][0],t[1]=r[o][1],i&&(t[2]=r[o][2]),n(t)}},multipoint(e,n,t){const i=e.points,a=e.hasZ;for(let r=0;r<i.length;r++)t[0]=i[r][0],t[1]=i[r][1],a&&(t[2]=i[r][2]),n(t)},extent(e,n,t){e.zmin!=null&&e.zmax!=null?(n(x(t,e.xmin,e.ymin,e.zmin)),n(x(t,e.xmax,e.ymin,e.zmin)),n(x(t,e.xmin,e.ymax,e.zmin)),n(x(t,e.xmax,e.ymax,e.zmin)),n(x(t,e.xmin,e.ymin,e.zmax)),n(x(t,e.xmax,e.ymin,e.zmax)),n(x(t,e.xmin,e.ymax,e.zmax)),n(x(t,e.xmax,e.ymax,e.zmax))):(n(x(t,e.xmin,e.ymin,t[2])),n(x(t,e.xmax,e.ymin,t[2])),n(x(t,e.xmin,e.ymax,t[2])),n(x(t,e.xmax,e.ymax,t[2])))}},ei=Object.freeze(Object.defineProperty({__proto__:null,create:Ta,fromCamera:ba,toCameraAsync:Zn,toCameraSync:wa},Symbol.toStringTag,{value:"Module"}));export{je as $,ha as A,v as K,Va as N,Qa as P,xe as Q,Xa as R,oa as Z,W as _,Ya as a,Cn as c,Ta as d,jt as f,K as g,ba as h,wa as l,_e as r,mn as u,ei as v,fa as w};
