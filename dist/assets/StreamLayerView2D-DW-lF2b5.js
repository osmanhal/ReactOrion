import{ba as m,A as c,dc as y,az as g,bF as u,v as n,y as p,z as f}from"./index-BfC8i6jT.js";import{n as v,r as _}from"./FeatureLayerView2D-CKrd6g6f.js";import{r as S}from"./StreamLayerView-DFCkrRGG.js";import"./EffectView-BHVg_MGi.js";import"./featureConversionUtils-CGYMoz5K.js";import"./OptimizedFeature-7juV2tZm.js";import"./OptimizedGeometry-vU5jWBvU.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./timeSupport-OHicj2My.js";import"./timeUtils-BWG3K3Ml.js";import"./tagSymbols-BPcGfZon.js";import"./highlightReasons-Xh2OTEQT.js";import"./LayerView2D-vCOQCX0d.js";import"./Container-D8Z8PR0N.js";import"./DisplayObject-COGNSicI.js";import"./definitions-ByNBSgP9.js";import"./enums-BlUEVwJR.js";import"./Texture-Bq-Yp-pO.js";import"./ClipRect-QwkcqybV.js";import"./layerViewUtils-D2JqIDZ8.js";import"./TechniqueInstance-DugsV9W7.js";import"./UpdateTracking2D-CetJAt3b.js";import"./BindType-BmZEZMMh.js";import"./Util-D9KK83cB.js";import"./Program-C3FgCIV9.js";import"./BufferObject-CLFFt1Oe.js";import"./LabelMetric-BmRa1Bis.js";import"./enums-BRXbslMp.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./BoundingBox-Dn8AJClK.js";import"./TileContainer-DGzbl-7U.js";import"./WGLContainer-BLE0Uw_u.js";import"./VertexArrayObject-DJNUJ_t_.js";import"./WGLBrushVTLSymbol-DID28CcD.js";import"./vec4f32-CjrfB-0a.js";import"./StyleDefinition-BK3ROBTO.js";import"./config-MDUrh2eL.js";import"./ShaderCompiler-G2XYGDs6.js";import"./ProgramTemplate-Cd8GU6R3.js";import"./TiledDisplayObject-wW3wbRrm.js";import"./vec3f32-Cw9Q6TO_.js";import"./earcut-BrWrA6nz.js";import"./CircularArray-CujHzHWW.js";import"./tileUtils-B7X19rIS.js";import"./featureReductionUtils-Caulfaw_.js";import"./CIMSymbolHelper-RNagakW-.js";import"./BidiEngine-BwB1Df7c.js";import"./fontUtils-BN6jNuTX.js";import"./GeometryUtils-ClkMWevA.js";import"./Rect-CUzevAry.js";import"./SDFHelper-BfkhxXEz.js";import"./floatRGBA-BcMV1NFr.js";import"./FeatureCommandQueue-DuEpW0h7.js";import"./heatmapTextureUtils-CCcHDKhq.js";import"./constants-D5zmR9t2.js";import"./HighlightCounter-CsS6KOrs.js";import"./FeatureLayerView-CVEiLjfZ.js";import"./floorFilterUtils-DZ5C6FQv.js";import"./popupUtils-6OYxcFTS.js";import"./LayerView-D3G_E76P.js";import"./RefreshableLayerView-T2pK9W1H.js";let i=class extends S(_){constructor(){super(...arguments),this.pipelineConnectionStatus="disconnected",this.pipelineErrorString=null}initialize(){this.addHandles([m(()=>this.layer.customParameters,async e=>{(await this.getWorker()).streamMessenger.updateCustomParameters(e)}),this.layer.on("send-message-to-socket",async e=>{(await this.getWorker()).streamMessenger.sendMessageToSocket(e)}),this.layer.on("send-message-to-client",async e=>{(await this.getWorker()).streamMessenger.sendMessageToClient(e),this._isUserPaused&&"type"in e&&e.type==="clear"&&this.incrementSourceRefreshVersion()}),m(()=>this.layer.purgeOptions,()=>this._update()),m(()=>this.suspended,this._onSuspendedChange.bind(this))],"constructor"),this._doResume()}destroy(){this._doPause()}get connectionError(){return this.pipelineErrorString?new c("stream-controller",this.pipelineErrorString):null}on(e,s){if(Array.isArray(e))return y(e.map(t=>this.on(t,s)));const r=["data-received","message-received"].includes(e);r&&this.getWorker().then(t=>t.streamMessenger.enableEvent(e,!0));const a=super.on(e,s),o=this;return g(()=>{a.remove(),r&&(o._workerProxy.closed||o.hasEventListener(e)||o.getWorker().then(t=>t.streamMessenger.enableEvent(e,!1)))})}async queryLatestObservations(e,s){var a,o,t;if(!((a=this.layer.timeInfo)!=null&&a.endField||(o=this.layer.timeInfo)!=null&&o.startField||(t=this.layer.timeInfo)!=null&&t.trackIdField))throw new c("streamlayer-no-timeField","queryLatestObservation can only be used with services that define a TrackIdField");const r=await this.getWorker();return v(r.features.executeQueryForLatestObservations(this._cleanUpQuery(e),s).then(d=>{const l=u.fromJSON(d);return l.features.forEach(h=>{h.layer=this.layer,h.sourceLayer=this.layer}),l}),new u({features:[]}))}detach(){super.detach(),this.pipelineConnectionStatus="disconnected"}get _streamConnectionStatus(){return this.pipelineConnectionStatus}_doPause(){this._refreshInterval!=null&&(clearInterval(this._refreshInterval),this._refreshInterval=null)}_doResume(){this._refreshInterval=setInterval(()=>this.incrementSourceRefreshVersion(),this.layer.updateInterval)}_doDisconnect(){this.getWorker().then(e=>e.streamMessenger.disconnect()),this._doPause()}_doConnect(){this.getWorker().then(e=>e.streamMessenger.connect()),this.resume()}_doClear(){this.getWorker().then(e=>e.streamMessenger.clear()),this._refreshInterval==null&&this.incrementSourceRefreshVersion()}_createClientOptions(){const e=super._createClientOptions(),s=this;return{...e,get container(){return s.featureContainer},setProperty:r=>{this.set(r.propertyName,r.value)}}}};n([p()],i.prototype,"pipelineConnectionStatus",void 0),n([p()],i.prototype,"pipelineErrorString",void 0),n([p({readOnly:!0})],i.prototype,"connectionError",null),n([p({readOnly:!0})],i.prototype,"_streamConnectionStatus",null),i=n([f("esri.views.2d.layers.StreamLayerView2D")],i);const Oe=i;export{Oe as default};
